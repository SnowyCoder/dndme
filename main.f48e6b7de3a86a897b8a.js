!function(t){function e(e){for(var n,r,a=e[0],l=e[1],d=e[2],c=0,p=[];c<a.length;c++)r=a[c],Object.prototype.hasOwnProperty.call(s,r)&&s[r]&&p.push(s[r][0]),s[r]=0;for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(t[n]=l[n]);for(h&&h(e);p.length;)p.shift()();return o.push.apply(o,d||[]),i()}function i(){for(var t,e=0;e<o.length;e++){for(var i=o[e],n=!0,a=1;a<i.length;a++){var l=i[a];0!==s[l]&&(n=!1)}n&&(o.splice(e--,1),t=r(r.s=i[0]))}return t}var n={},s={0:0},o=[];function r(e){if(n[e])return n[e].exports;var i=n[e]={i:e,l:!1,exports:{}};return t[e].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=n,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="";var a=window.webpackJsonp=window.webpackJsonp||[],l=a.push.bind(a);a.push=e,a=a.slice();for(var d=0;d<a.length;d++)e(a[d]);var h=l;o.push([76,1]),i()}([,,,,,,,,,,,,,function(t,e,i){var n=i(39);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("7c681468",n,!1,{})},function(t,e,i){var n=i(42);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("6123dedb",n,!1,{})},function(t,e,i){var n=i(48);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("20adba36",n,!1,{})},function(t,e,i){var n=i(50);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("0e8a47b6",n,!1,{})},function(t,e,i){var n=i(52);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("cf98b6ba",n,!1,{})},,,,,,,,,,,,,,,,,,,,,function(t,e,i){"use strict";var n=i(13);i.n(n).a},function(t,e,i){var n=i(6),s=i(25),o=i(40);e=n(!1);var r=s(o);e.push([t.i,"\n.credits[data-v-539f2bff] {\n    text-align: right;\n    padding: 20px;\n}\n.github[data-v-539f2bff] {\n    display: inline-block;\n    width: 32px;\n    height: 32px;\n    background-image: url("+r+");\n}\n.github[data-v-539f2bff]:hover {\n    opacity: 0.5;\n}\n.profile[data-v-539f2bff] {\n    color: white;\n}\n.profile[data-v-539f2bff]:hover {\n    opacity: 0.5;\n}\n\n",""]),t.exports=e},function(t,e,i){"use strict";i.r(e),e.default=i.p+"266ca63177bca6f330a74e83fdc63178.png"},function(t,e,i){"use strict";var n=i(14);i.n(n).a},function(t,e,i){(e=i(6)(!1)).push([t.i,"\n.btn-entry[data-v-d8550b4a] {\n    margin-bottom: 10px;\n}\n\n",""]),t.exports=e},,,,,function(t,e,i){"use strict";var n=i(15);i.n(n).a},function(t,e,i){(e=i(6)(!1)).push([t.i,"\n.component-header[data-v-03d324d6] {\n    width: 100%;\n    display: flex;\n    align-items: center;\n    margin-left: 5px;\n    margin-bottom: 2px;\n}\n.component-header button[data-v-03d324d6]:last-child {\n    margin-right: 10px;\n}\n.component-body[data-v-03d324d6] {\n    margin-left: 12px;\n    margin-right: 12px;\n}\n.g11[data-v-03d324d6] {\n    grid-row: 1;\n    grid-column: 1;\n}\n",""]),t.exports=e},function(t,e,i){"use strict";var n=i(16);i.n(n).a},function(t,e,i){(e=i(6)(!1)).push([t.i,"\n.component-btn-header[data-v-c407dbfa] {\n    margin: 0.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: right;\n}\n.g11[data-v-c407dbfa] {\n    grid-column: 1;\n    grid-row: 1;\n}\n",""]),t.exports=e},function(t,e,i){"use strict";var n=i(17);i.n(n).a},function(t,e,i){(e=i(6)(!1)).push([t.i,"\n.game[data-v-53b46051] {\n    user-select: none;\n}\n.toolbar-btn[data-v-53b46051] {\n    color: #fff;\n    background-color: #2C3E50;\n    border-color: #2C3E50;\n}\n",""]),t.exports=e},function(t,e){function i(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}i.keys=function(){return[]},i.resolve=i,t.exports=i,i.id=53},,,,,,,,,,,,,,,,,,,function(t,e,i){var n=i(73);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("511f390e",n,!1,{})},function(t,e,i){var n=i(6),s=i(74),o=i(75);(e=n(!1)).push([t.i,"@import url(https://fonts.googleapis.com/css2?family=Merienda+One&display=swap);"]),e.i(s),e.i(o),e.push([t.i,":root {\n    --topbar-height: 40px;\n}\n\n* {\n    font-family: 'Merienda One', cursive;\n}\n\nbody {\n    color: white;\n\n    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAPklEQVQoU2NkYGAwZmBgOMsAASD2cwYGhmcwPiOUIcXAwCCJpBDOhynA0AkzCaQA2QoMk0AKQIJwO+nvBmMAk2YWvDhYBRoAAAAASUVORK5CYII=);\n    background-color: #6e472c !important;\n}\n\n.phase-container {\n}\n\n\n@media screen and (max-height: 890px) {\n    .footer {\n        position: static;\n    }\n}\n\n@media screen and (min-height: 890px) {\n    .footer {\n        position: fixed;\n        bottom: 0;\n    }\n}\n\n.under-navbar {\n    margin-top: var(--topbar-height) !important;\n}\n\ndiv.under-navbar {\n    margin-top: var(--topbar-height) !important;\n}\n\n.footer, .game-footer {\n    width: 100%;\n    background-color: rgba(0, 0, 0, 0.25);\n}\n\n.btn-xs {\n    padding: .25rem .4rem;\n    font-size: .875rem;\n    line-height: .5;\n    border-radius: .2rem;\n}\n\n.modal-fullscreen {\n    height: 92%;\n}\n.modal-fullscreen .modal-content {\n    height: 100%;\n}\n.modal-xxl {\n    width: 92% !important;\n    max-width: 92% !important;\n}",""]),t.exports=e},,,function(t,e,i){"use strict";i.r(e),i.d(e,"windowEventEmitter",(function(){return ie})),i.d(e,"app",(function(){return ne})),i.d(e,"stage",(function(){return se}));var n=i(3),s=i(7);class o{constructor(t){this.name=t,this.uiEventEmitter=new s}log(t){console.log(`[${this.name}] `+t)}ui(){}enable(){this.log("Enabling"),n.default.prototype.eventEmitter=this.uiEventEmitter,this.vue=this.ui(),this.vue&&(this.vue.$mount(),document.body.appendChild(this.vue.$el))}disable(){console.log(`[${this.name}] Disabling`),this.vue&&document.body.removeChild(this.vue.$el)}get[Symbol.toStringTag](){return"ObjectNoObserve"}}var r=i(1),a=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"phase-container text-center"},[t._m(0),t._v(" "),i("div",[i("b-button",{staticClass:"btn-entry",attrs:{variant:"warning",size:"lg"},on:{click:t.onCreateMap}},[t._v("Create Map")])],1),t._v(" "),i("div",[i("b-button",{staticClass:"btn-entry",attrs:{variant:"info",size:"lg"},on:{click:t.onEditMap}},[t._v("Edit Map")])],1),t._v(" "),i("b-modal",{ref:"map-load-modal",attrs:{"hide-footer":"",title:"Gimme the map"}},[i("b-form-file",{attrs:{state:Boolean(t.file),placeholder:"Choose a file or drop it here...","drop-placeholder":"Drop file here...",accept:".dndm"},model:{value:t.file,callback:function(e){t.file=e},expression:"file"}})],1),t._v(" "),i("footer-component")],1)};a._withStripped=!0;var l=function(){var t=this.$createElement;this._self._c;return this._m(0)};l._withStripped=!0;var d=n.default.extend({}),h=(i(38),i(2)),c=Object(h.a)(d,l,[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"footer"},[e("div",{staticClass:"credits"},[e("div",{staticClass:"links"},[e("a",{staticClass:"github",attrs:{href:"https://github.com/SnowyCoder/dndme",target:"_blank"}})]),this._v(" "),e("small",{staticStyle:{color:"lightgray"}},[this._v("\n            Developed by "),e("a",{staticClass:"profile",attrs:{href:"https://github.com/SnowyCoder",target:"_blank"}},[this._v("Rossi Lorenzo")]),this._v(" /\n            Drawings by "),e("span",{staticStyle:{color:"white"}},[this._v("Giorgia Nizzoli")])])])])}],!1,null,"539f2bff",null);c.options.__file="src/app/ui/footer.vue";var p=c.exports,m=function(){var t=this.$createElement,e=this._self._c||t;return e("b-modal",{ref:"my-modal",attrs:{"hide-footer":"",title:"Gimme the map"}},[e("div",{staticClass:"d-block text-center"},[e("h3",[this._v("Insert map to load")])]),this._v(" "),e("b-button",{staticClass:"mt-3",attrs:{variant:"outline-danger",block:""},on:{click:this.hideModal}},[this._v("Cancel")])],1)};m._withStripped=!0;var u={name:"mapInput",data:()=>({file:null}),methods:{onDrop:function(t){},hideModal:function(t){this.$emit("close")}}},g=Object(h.a)(u,m,[],!1,null,"7e9d406c",null);g.options.__file="src/app/ui/home/mapInput.vue";var f=g.exports,v=n.default.extend({data:()=>({file:null,pendingOp:""}),components:{MapInput:f,FooterComponent:p},methods:{onCreateMap(){this.eventEmitter.emit("create_map")},onEditMap(){this.pendingOp="edit",this.$refs["map-load-modal"].show(),this.eventEmitter.emit("edit_map")},mapLoadCancel(){this.$refs["map-load-modal"].hide()}},watch:{file:function(t){null!=t&&(console.log("File dropped, loading: "+this.pendingOp),this.eventEmitter.emit(this.pendingOp,this.file),this.file=null,this.mapLoadCancel())}}}),y=(i(41),Object(h.a)(v,a,[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title-container"},[e("h1",{staticClass:"title h1"},[this._v("DrawNDice")]),this._v(" "),e("p",{},[this._v("Dnd made ez!")])])}],!1,null,"d8550b4a",null));y.options.__file="src/app/ui/home/home.vue";var w=y.exports;class b{constructor(t){this.id=t}loadInto(t){t.clear(),void 0!==this.ecs&&t.deserialize(this.ecs)}saveFrom(t){this.ecs=void 0,this.ecs=t.serialize()}serialize(){return{name:this.name,ecs:this.ecs}}static deserialize(t,e){let i=new b(t);return i.name=e.name,i.ecs=e.ecs,i}}var _=i(21),C=i(20),E=i.n(C),x=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class S{constructor(){this.levels=new Map}createDataJson(){let t={};for(let[e,i]of this.levels.entries())t[e]=i.serialize();let e={version:S.SER_VERSION,levels:t};return Object(_.encode)(e)}saveToFile(){let t=this.createDataJson(),e=new E.a;return e.file("data.msgpack",t),e.generateAsync({type:"blob"})}static loadFromFile(t){return x(this,void 0,void 0,(function*(){let e=yield E.a.loadAsync(t),i=yield e.file("data.msgpack").async("arraybuffer"),n=yield Object(_.decode)(i);if(n.version!==this.SER_VERSION)throw"Version not supported";let s=new S,o=n.levels;for(let t in o){let e=o[t],i=yield b.deserialize(parseInt(t),e);s.levels.set(i.id,i)}return s}))}}S.SER_VERSION="1.0";var M=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"game"},[i("b-button-toolbar",{staticClass:"bg-dark",staticStyle:{width:"100%",height:"var(--topbar-height)","z-index":"1000"},attrs:{type:"dark",variant:"info",justify:""}},[t.isAdmin?i("b-button-group",{staticStyle:{"margin-right":"2rem"}},[i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Undo",squared:""}},[i("i",{staticClass:"fas fa-undo"})]),t._v(" "),i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Redo",squared:"",disabled:""}},[i("i",{staticClass:"fas fa-redo"})])],1):t._e(),t._v(" "),i("b-button-group",[i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Inspect",squared:""},on:{click:function(e){return t.changeTool("inspect")}}},[i("i",{staticClass:"fas fa-hand-pointer"})]),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Move",squared:""},on:{click:function(e){return t.changeTool("move")}}},[i("i",{staticClass:"fas fa-arrows-alt"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Add room",squared:""},on:{click:function(e){return t.changeTool("create_room")}}},[i("i",{staticClass:"fas fa-plus"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Edit grid",squared:""},on:{click:function(e){return t.changeTool("grid")}}},[i("i",{staticClass:"fas fa-border-all"})]):t._e()],1),t._v(" "),t.isAdmin?i("b-button",{staticClass:"btn-xs",attrs:{title:"Export map",squared:"",variant:"success"},on:{click:function(e){return t.phase.exportMap()}}},[i("i",{staticClass:"fas fa-download"})]):t._e(),t._v(" "),i("div",{staticStyle:{flex:"1 1 0"}}),t._v(" "),i("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.sidebar-right",modifiers:{"sidebar-right":!0}}],staticClass:"btn-xs",attrs:{title:"Toggle sidebar",variant:"warning"}},[i("i",{staticClass:"fas fa-angle-double-right"})])],1),t._v(" "),i("b-sidebar",{attrs:{id:"sidebar-right",title:"Sidebar","bg-variant":"dark","text-variant":"light",right:"",visible:"","no-header":"",shadow:"","sidebar-class":"under-navbar"}},[i("div",{directives:[{name:"show",rawName:"v-show",value:"grid"===t.tool,expression:"tool === 'grid'"}],staticClass:"px-3 py-2"},[t._v("\n            Type:\n            "),i("b-radio-group",{attrs:{id:"grid-type-radio",buttons:""},model:{value:t.grid.type,callback:function(e){t.$set(t.grid,"type",e)},expression:"grid.type"}},[i("b-radio",{attrs:{value:"none"}},[i("i",{staticClass:"fas fa-border-none"})]),t._v(" "),i("b-radio",{attrs:{value:"square"}},[i("i",{staticClass:"far fa-square"})]),t._v(" "),i("b-radio",{attrs:{value:"hex"}},[i("svg",{staticClass:"svg-inline--fa fa-hexagon fa-w-18",attrs:{role:"img",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 576 512"}},[i("path",{attrs:{fill:"currentColor",d:"M441.5 39.8C432.9 25.1 417.1 16 400 16H176c-17.1 0-32.9 9.1-41.5 23.8l-112 192c-8.7 14.9-8.7 33.4 0 48.4l112 192c8.6 14.7 24.4 23.8 41.5 23.8h224c17.1 0 32.9-9.1 41.5-23.8l112-192c8.7-14.9 8.7-33.4 0-48.4l-112-192zM400 448H176L64 256 176 64h224l112 192-112 192z"}})])])],1),t._v(" "),"none"!==t.grid.type?i("div",[i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Size:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"10",max:"512",size:"sm"},model:{value:t.grid.size,callback:function(e){t.$set(t.grid,"size",e)},expression:"grid.size"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"10",max:"512"},model:{value:t.grid.size,callback:function(e){t.$set(t.grid,"size",e)},expression:"grid.size"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",[t._v("Xoffset:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"0",max:"1",step:"0.001",size:"sm"},model:{value:t.grid.offX,callback:function(e){t.$set(t.grid,"offX",e)},expression:"grid.offX"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"0",max:"1",step:"0.001"},model:{value:t.grid.offX,callback:function(e){t.$set(t.grid,"offX",e)},expression:"grid.offX"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Yoffset:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"0",max:"1",step:"0.001",size:"sm"},model:{value:t.grid.offY,callback:function(e){t.$set(t.grid,"offY",e)},expression:"grid.offY"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"0",max:"1",step:"0.001"},model:{value:t.grid.offY,callback:function(e){t.$set(t.grid,"offY",e)},expression:"grid.offY"}}),t._v("\n\n                Color: "+t._s(t.grid.color)+"\n                "),i("b-input",{attrs:{type:"color"},model:{value:t.grid.color,callback:function(e){t.$set(t.grid,"color",e)},expression:"grid.color"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Opacity:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"0",max:"1",step:"0.001",size:"sm"},model:{value:t.grid.opacity,callback:function(e){t.$set(t.grid,"opacity",e)},expression:"grid.opacity"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"0",max:"1",step:"0.001"},model:{value:t.grid.opacity,callback:function(e){t.$set(t.grid,"opacity",e)},expression:"grid.opacity"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Width:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"1",max:"200",size:"sm"},model:{value:t.grid.width,callback:function(e){t.$set(t.grid,"width",e)},expression:"grid.width"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"1",max:"200"},model:{value:t.grid.width,callback:function(e){t.$set(t.grid,"width",e)},expression:"grid.width"}})],1):t._e()],1),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:"inspect"===t.tool,expression:"tool === 'inspect'"}]},[i("entity-inspect",{attrs:{components:this.selectedComponents,entity:this.selectedEntityOpts,isAdmin:t.isAdmin},on:{"ecs-property-change":t.onEcsPropertyChange}})],1)]),t._v(" "),i("a",{staticStyle:{display:"none"},attrs:{id:"hidden-download-link"}})],1)};M._withStripped=!0;const R={color:0,width:10,opacity:.75,size:100,offX:0,offY:0};var k;!function(t){t[t.SQUARE=0]="SQUARE",t[t.HEXAGON=1]="HEXAGON"}(k||(k={}));var I=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{directives:[{name:"show",rawName:"v-show",value:t.components.length>0,expression:"components.length > 0"}]},[i("div",{staticClass:"component-btn-header"},[t.isAdmin?i("b-dropdown",{attrs:{"toggle-class":"rounded-0",variant:"success"},scopedSlots:t._u([{key:"button-content",fn:function(){return[i("i",{staticClass:"fas fa-plus"})]},proxy:!0}],null,!1,1774554641)},[t._v(" "),i("b-dropdown-item",{on:{click:function(e){return t.emitSpecial("addComponent","name")}}},[t._v("Name")]),t._v(" "),i("b-dropdown-item",{on:{click:function(e){return t.emitSpecial("addComponent","note")}}},[t._v("Note")])],1):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticStyle:{display:"grid"},attrs:{squared:"",title:t.entity.hidden?"Show entity":"Hide entity"},on:{click:function(e){return t.emitSpecial("hidden",!t.entity.hidden)}}},[i("div",{staticClass:"g11",style:{visibility:t.entity.hidden?"visible":"hidden"}},[i("i",{staticClass:"fas fa-eye-slash"})]),t._v(" "),i("div",{staticClass:"g11",style:{visibility:t.entity.hidden?"hidden":"visible"}},[i("i",{staticClass:"fas fa-eye"})])]):t._e(),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:t.entity.forgettable,expression:"entity.forgettable"}],attrs:{variant:"danger",title:"Forget",squared:""},on:{click:function(e){return t.emitSpecial("forget")}}},[i("i",{staticClass:"fas fa-eraser"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{attrs:{variant:"danger",title:"Delete entity",squared:""},on:{click:function(e){return t.emitSpecial("delete")}}},[i("i",{staticClass:"fas fa-trash"})]):t._e()],1),t._v(" "),t._l(t.components,(function(e){return i("ecs-component-wrapper",{key:e.type+(e.multiId||""),attrs:{component:e,isAdmin:t.isAdmin},on:{"ecs-property-change":function(e){return t.$emit("ecs-property-change",arguments[0],arguments[1],arguments[2],arguments[3])}}})}))],2)};I._withStripped=!0;var A=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",[i("div",{staticClass:"component-header"},[i("div",{staticStyle:{width:"100%"},on:{click:function(e){t.visible=!t.visible}}},[t._v(" "+t._s(t.component.type)+" ")]),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:void 0!==t.component.clientVisible,expression:"component.clientVisible !== undefined"}],staticStyle:{display:"grid"},attrs:{squared:"",size:"sm",title:t.component.clientVisible?"Hide component":"Show component"},on:{click:function(e){return t.$emit("ecs-property-change",t.component.type,"clientVisible",!t.component.clientVisible)}}},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.component.clientVisible,expression:"component.clientVisible"}],staticClass:"g11"},[i("i",{staticClass:"fas fa-eye"})]),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:!t.component.clientVisible,expression:"!component.clientVisible"}],staticClass:"g11"},[i("i",{staticClass:"fas fa-eye-slash"})])]):t._e(),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:void 0!==t.component._isFullscreen,expression:"component._isFullscreen !== undefined"}],attrs:{squared:"",size:"sm",variant:"primary",title:"Fullscreen"},on:{click:function(e){t.component._isFullscreen=!0}}},[i("i",{staticClass:"fas fa-expand"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:t.component._canDelete,expression:"component._canDelete"}],attrs:{squared:"",size:"sm",variant:"danger",title:"Delete"},on:{click:function(e){return t.$emit("ecs-property-change","$","removeComponent",t.component.type,t.component.multiId)}}},[i("i",{staticClass:"fas fa-trash"})]):t._e()],1)]),t._v(" "),i("b-collapse",{staticClass:"component-body",attrs:{visible:""},model:{value:t.visible,callback:function(e){t.visible=e},expression:"visible"}},[i(t.componentType,{tag:"component",attrs:{component:t.component,isAdmin:t.isAdmin},on:{"ecs-property-change":function(e){return t.$emit("ecs-property-change",arguments[0],arguments[1],arguments[2],arguments[3])}}})],1)],1)};A._withStripped=!0;var T=function(){var t=this,e=t.$createElement;return(t._self._c||e)("b-input",{attrs:{readonly:!t.isAdmin,placeholder:"Entity name"},on:{change:t.onChange},model:{value:t.component.name,callback:function(e){t.$set(t.component,"name",e)},expression:"component.name"}})};T._withStripped=!0;var O={name:"ecs-name",props:["component","isAdmin"],data:function(){return{name:this.component.name}},watch:{"component.name":function(t){this.name=t}},methods:{onChange:function(){this.$emit("ecs-property-change","name","name",this.name,this.component.multiId)}}},D=Object(h.a)(O,T,[],!1,null,"3e768912",null);D.options.__file="src/app/ui/ecs/ecsName.vue";var P=D.exports,z=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("b-textarea",{attrs:{placeholder:"Write something here...",readonly:!t.isAdmin},on:{change:t.onChange},model:{value:t.note,callback:function(e){t.note=e},expression:"note"}}),t._v(" "),i("b-modal",{attrs:{title:"Note","dialog-class":"modal-fullscreen modal-xxl","hide-footer":"","hide-header":""},scopedSlots:t._u([{key:"modal-footer",fn:function(){},proxy:!0}]),model:{value:t.component._isFullscreen,callback:function(e){t.$set(t.component,"_isFullscreen",e)},expression:"component._isFullscreen"}},[i("b-textarea",{staticStyle:{height:"100%",resize:"none"},attrs:{readonly:t.isAdmin},on:{change:t.onChange},model:{value:t.note,callback:function(e){t.note=e},expression:"note"}})],1)],1)};z._withStripped=!0;var B={name:"ecs-note",props:["component","isAdmin"],data:function(){return{note:this.component.note,console:console}},watch:{"component.note":function(t){this.note=t}},methods:{onChange:function(){this.$emit("ecs-property-change","note","note",this.note,this.component.multiId)}}},N=Object(h.a)(B,z,[],!1,null,"2effb2f9",null);N.options.__file="src/app/ui/ecs/ecsNote.vue";var F=N.exports,L=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        X: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(t._s(t.x))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"0.001",size:"sm"},on:{change:t.onChange},model:{value:t.x,callback:function(e){t.x=e},expression:"x"}}):t._e()],1),t._v(" "),i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        Y: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(" "+t._s(t.y))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"0.001",size:"sm"},on:{change:t.onChange},model:{value:t.y,callback:function(e){t.y=e},expression:"y"}}):t._e()],1)])};L._withStripped=!0;var $={name:"ecs-position",props:["component","isAdmin"],data:function(){return{x:this.component.x,y:this.component.y}},methods:{onChange:function(){this.component.x!==this.x&&""!==this.x&&this.$emit("ecs-property-change","position","x",parseFloat(this.x)),this.component.y!==this.y&&""!==this.y&&this.$emit("ecs-property-change","position","y",parseFloat(this.y))}},watch:{"component.x":function(t){this.x=t},"component.y":function(t){this.y=t}}},j=Object(h.a)($,L,[],!1,null,"e81e4da0",null);j.options.__file="src/app/ui/ecs/ecsPosition.vue";var Y=j.exports,U=function(){var t=this,e=t.$createElement;return(t._self._c||e)("b-button",{on:{click:function(e){return t.$emit("ecs-property-change","room","visible",!t.component.visible)}}},[t._v("\n    "+t._s(t.component.visible?"Hide room":"Show room")+"\n")])};U._withStripped=!0;var X={name:"ecs-room",props:["component"]},H=Object(h.a)(X,U,[],!1,null,"7326313c",null);H.options.__file="src/app/ui/ecs/ecsRoom.vue";var V=H.exports,W=function(){var t=this.$createElement;return(this._self._c||t)("span",[this._v("Your regular background image")])};W._withStripped=!0;var G={name:"ecs-background-image",props:["component"]},q=Object(h.a)(G,W,[],!1,null,"5efd7016",null);q.options.__file="src/app/ui/ecs/ecsBackgroundImage.vue";var K={name:"ecs-component-wrapper",props:["component","isAdmin"],data:function(){return{visible:!0}},computed:{componentType:function(){return"ecs-"+this.component.type.replace("_","-")}},components:{ecsName:P,ecsNote:F,ecsPosition:Y,ecsRoom:V,ecsBackgroundImage:q.exports}},J=(i(47),Object(h.a)(K,A,[],!1,null,"03d324d6",null));J.options.__file="src/app/ui/ecs/compWrapper.vue";var Q={name:"entity-inspect",components:{EcsComponentWrapper:J.exports},props:["entity","components","isAdmin"],methods:{emitSpecial:function(t,e){this.$emit("ecs-property-change","$",t,e)}}},Z=(i(49),Object(h.a)(Q,I,[],!1,null,"c407dbfa",null));Z.options.__file="src/app/ui/ecs/entityInspect.vue";var tt=Z.exports,et=n.default.extend({components:{EntityInspect:tt},data:()=>({tool:"inspect",isAdmin:!1,grid:{type:"none",size:1,offX:0,offY:0,color:"#000000",opacity:.5,width:2},selectedComponents:new Array,selectedEntityOpts:{},phase:null}),methods:{changeTool(t){this.phase.changeTool(t)},onEcsPropertyChange(t,e,i,n){this.phase.selection.setProperty(t,e,i,n)}},watch:{grid:{handler:function(t,e){let i;switch(t.offX=Math.min(t.offX,t.size),t.offY=Math.min(t.offY,t.size),t.type){case"none":i=void 0;break;case"hex":i=k.HEXAGON;break;case"square":i=k.SQUARE}void 0!==i?this.phase.ecs.addResource({type:"grid",gridType:i,size:t.size,offX:t.offX,offY:t.offY,color:parseInt(t.color.substring(1),16),opacity:t.opacity,width:t.width},"update"):this.phase.ecs.removeResource("grid",!1)},deep:!0}},mounted(){let t=this.phase.ecs.getResource("grid");switch(void 0!==t?t.gridType:void 0){case void 0:this.grid.type="none";break;case k.HEXAGON:this.grid.type="hex";break;case k.SQUARE:this.grid.type="square"}let e=t||R;this.grid.size=e.size,this.grid.offX=e.offX,this.grid.offY=e.offY,this.grid.color="#"+e.color.toString(16).padEnd(6,"0"),this.grid.opacity=e.opacity,this.grid.width=e.width,this.eventEmitter.on("changeTool",t=>{this.tool=t})}}),it=(i(51),Object(h.a)(et,M,[],!1,null,"53b46051",null));it.options.__file="src/app/ui/edit/editMap.vue";var nt=it.exports;class st extends r.d{constructor(){super(),this.left=1/0,this.right=-1/0,this.bottom=1/0,this.top=-1/0,this.isDragging=!1,this.initPixi()}isBoardLost(t,e){const i=t.x+this.left*e.x,n=t.x+this.right*e.x,s=t.y+this.bottom*e.y;return t.y+this.top*e.y<0||s>window.innerHeight||i>window.innerWidth||n<0}initPixi(){this.sortableChildren=!0,this.hitArea={contains:(t,e)=>!0},this.interactive=!0,this.interactiveChildren=!0,this.isDragging=!1,this.on("mousedown",t=>{this.isDragging=!0}),this.on("mouseup",t=>{this.isDragging=!1}),this.on("mouseupoutside",t=>{this.isDragging=!1}),this.on("mousemove",t=>{if(this.isDragging){let e=t.data.originalEvent;const i=this.position.x+e.movementX,n=this.position.y+e.movementY;if(this.isBoardLost(new r.f(i,n),this.scale))return;this.position.x=i,this.position.y=n}})}}var ot=r.o.EventEmitter;class rt{constructor(){this.storages=new Map,this.entities=new Set,this.resources=new Map,this.isDeserializing=!1,this.events=new ot}spawnEntity(...t){let e=-1;do{e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}while(this.entities.has(e));return this.spawnEntityManual(e,t),e}spawnEntityManual(t,e){this.entities.add(t),this.events.emit("entity_spawn",t);for(let i of e)this.addComponent(t,i);this.events.emit("entity_spawned",t)}despawnEntity(t){this.events.emit("entity_despawn",t);for(let e of this.storages.values()){let i=[...e.getComponents(t)];for(let t of i)this.events.emit("component_remove",t);e.unregisterAllOf(t);for(let t of i)this.events.emit("component_removed",t)}this.entities.delete(t),this.events.emit("entity_despawned",t)}hasAllComponents(t,...e){for(let i of e)if(void 0===this.getComponent(t,i))return!1;return!0}addComponent(t,e){e.entity=t;let i=this.storages.get(e.type);if(void 0===i)throw"Cannot register component of type "+e.type+", no storage found";i.register(e),this.events.emit("component_add",e)}removeComponent(t){this.events.emit("component_remove",t),this.storages.get(t.type).unregister(t),this.events.emit("component_removed",t)}addStorage(t){this.storages.set(t.type,t)}getComponent(t,e,i){return this.storages.get(e).getFirstComponent(t,i)}getAllComponents(t){let e=new Array;for(let i of this.storages.values())e.push(...i.getComponents(t));return e}editComponent(t,e,i,n){let s=this.getComponent(t,e,n);this.events.emit("component_edit",s,i);let o=at(s,i);this.events.emit("component_edited",s,o)}addResource(t,e="fail"){if(this.resources.has(t.type))switch(e){case"ignore":break;case"update":this.editResource(t.type,t);break;default:throw"Resource type already present"}else{if(this.events.emit("resource_add",t),this.resources.has(t.type))throw'"resource_add" event has added a resource of the same type!';this.resources.set(t.type,t),this.events.emit("resource_added",t)}}getResource(t){return this.resources.get(t)}editResource(t,e){let i=this.getResource(t);this.events.emit("resource_edit",e,i),at(i,e),this.events.emit("resource_edited",i,e)}removeResource(t,e=!0){let i=this.resources.get(t);if(void 0!==i)this.events.emit("resource_remove",i),this.resources.delete(t),this.events.emit("resource_removed",i);else if(e)throw"Resource type not found"}serialize(){let t={};for(let e of this.storages.values())t[e.type]=e.serialize();let e={};for(let t of this.resources.values()){let i={};for(let e in t)"_"!==e[0]&&"type"!==e&&(i[e]=t[e]);e[t.type]=i}return{entities:[...this.entities],storages:t,resources:e}}serializeClient(){let t={},e=this.storages.get("host_hidden");for(let i of this.storages.values())i.type.startsWith("host_")||(t[i.type]=i.serializeClient(t=>void 0!==e.getFirstComponent(t)));let i={};for(let t of this.resources.values()){if(!0===t._clientHide)continue;let e={};for(let i in t)"_"!==i[0]&&"type"!==i&&(e[i]=t[i]);i[t.type]=e}return{entities:[...this.entities].filter(t=>void 0===e.getFirstComponent(t)),storages:t,resources:i}}deserialize(t){this.clear(),this.isDeserializing=!0,this.events.emit("deserialize");for(let e in t.resources){let i=t.resources[e];i.type=e,this.addResource(i)}for(let e of t.entities)this.entities.add(e),this.events.emit("entity_spawn",e);for(let e in t.storages){let i=this.storages.get(e);void 0!==i?i.deserialize(this,t.storages[e]):console.error("Cannot deserialize storage type: "+e+", ignoring")}for(let e of t.entities)this.events.emit("entity_spawned",e);this.isDeserializing=!1,this.events.emit("deserialized")}clear(){this.events.emit("clear");for(let t of[...this.entities])this.despawnEntity(t);for(let t of[...this.entities])this.despawnEntity(t);if(0!==this.entities.size)throw"Entities spawned while clearing!";this.events.emit("cleared")}}function at(t,e){for(let i in e){let n=e[i];e[i]=t[i],t[i]=n}}function lt(t){let e={};for(let i in t)"_"!==i[0]&&"entity"!==i&&"type"!==i&&(e[i]=t[i]);return e}class dt{constructor(t){this.data=new Map,this.type=t}getFirstComponent(t,e){if(void 0!==e)return this.getComponent(t,e);let i=this.data.get(t);return void 0!==i?i[0]:void 0}getComponent(t,e){let i=this.data.get(t);if(void 0!==i)for(let t of i)if(t.multiId===e)return t}getComponents(t){return void 0!==t?this.data.get(t)||[]:this.allComponents()}*allComponents(){for(let t of this.data.values())for(let e of t)yield e}register(t){let e=this.data.get(t.entity);if(t.multiId>=0)if(void 0===e)this.data.set(t.entity,[t]);else{for(let i of e)if(i.multiId===t.multiId)throw"Invalid pre-assigned multiId";e.push(t)}else if(void 0===e)t.multiId=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),this.data.set(t.entity,[t]);else{let i,n;do{i=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),n=!1;for(let t of e)if(t.multiId===i){n=!0;break}}while(n);t.multiId=i,e.push(t)}}unregister(t){let e=this.data.get(t.entity);void 0!==e&&(1===e.length&&e[0]===t?this.data.delete(t.entity):e.splice(e.indexOf(t),1))}unregisterAllOf(t){this.data.delete(t)}serialize(){let t={};for(let[e,i]of this.data.entries()){let n=new Array;for(let t of i)n.push(lt(t));t[e]=n}return t}serializeClient(t){let e={};for(let[i,n]of this.data.entries()){if(t(i))continue;let s=new Array;for(let t of n)!1!==t.clientVisible&&s.push(lt(t));0!==s.length&&(e[i]=s)}return e}deserialize(t,e){for(let i in e){let n=parseInt(i);for(let s of e[i]){let e=Object.assign({},s,{type:this.type});t.addComponent(n,e)}}}}class ht{constructor(t){this.data=new Map,this.type=t}getComponent(t){return this.data.get(t)}getFirstComponent(t){return this.data.get(t)}getComponents(t){if(void 0!==t){let e=this.data.get(t);return void 0===e?[]:[e]}return this.allComponents()}allComponents(){return this.data.values()}register(t){if(void 0!==this.data.get(t.entity))throw"Component of same type already registered";this.data.set(t.entity,t)}unregister(t){let e=this.data.get(t.entity);void 0!==e&&e===t&&this.data.delete(t.entity)}unregisterAllOf(t){this.data.delete(t)}serialize(){let t={};for(let e of this.data.values())t[e.entity]=lt(e);return t}serializeClient(t){let e={};for(let i of this.data.values())t(i.entity)||!1===i.clientVisible||(e[i.entity]=lt(i));return e}deserialize(t,e){for(let i in e){let n=Object.assign({},e[i],{type:this.type});t.addComponent(parseInt(i),n)}}}class ct{constructor(t){this.data=new Map,this.type=t}getComponent(t){return this.data.get(t)}getFirstComponent(t){return this.getComponent(t)}getComponents(t){if(void 0!==t){let e=this.getComponent(t);return void 0===e?[]:[e]}return this.allComponents()}allComponents(){return this.data.values()}register(t){if(this.data.has(t.entity))throw"Component of same type already registered";this.data.set(t.entity,t)}unregister(t){this.data.delete(t.entity)}unregisterAllOf(t){this.data.delete(t)}serialize(){return[...this.data.keys()]}serializeClient(t){return[...this.data.keys()].filter(e=>!t(e))}deserialize(t,e){for(let i of e)t.addComponent(i,{type:this.type,entity:-1})}}const pt={children:!0,texture:!0,baseTexture:!0},mt=["jpeg","png","x-jg","bmp","x-icon","ief","pjpeg","x-portable-bitmap","x-rgb","tiff","x-tiff"];function ut(t,e){!function(t){if(!t.startsWith("image/"))throw"Invalid type: it should be an image";if(mt.indexOf(t.substr("image/".length))<0)throw"Unsupported image type"}(e);let i=new Uint8Array(t),n="data:"+e+";base64,"+btoa(i.reduce((t,e)=>t+String.fromCharCode(e),""));return new Promise((t,e)=>{let i=new Image;i.onload=()=>{const e=new r.k(new r.c(new r.n.ImageResource(i)));t([e,i])},i.onerror=e,i.src=n})}const gt=Math.sqrt(3);class ft{constructor(t){this.type="grid",this.posX=0,this.posY=0,this.scaleX=1,this.scaleY=1,this.ecs=t,this.sprite=new r.l(r.k.EMPTY,ne.screen.width,ne.screen.height),this.sprite.zIndex=5e3,t.events.on("resource_add",this.onResourceAdd,this),t.events.on("resource_edited",this.onResourceEdited,this),t.events.on("resource_remove",this.onResourceRemove,this)}onResourceAdd(t){"grid"===t.type&&(this.gridRes=t,this.updateTex(),this.updatePos())}onResourceEdited(t,e){"grid"===t.type&&(this.updateTex(),this.updatePos())}onResourceRemove(t){"grid"===t.type&&(this.gridRes=void 0,this.disable())}disable(){this.sprite.texture.destroy(!0),this.sprite.texture=r.k.EMPTY}updateTex(){if(void 0===this.gridRes)return;this.sprite.texture.destroy(!0);let t=function(t,e,i){let n;switch(e){case k.HEXAGON:n=function(t,e){let i=t/gt,n=Math.floor(3*i),s=document.createElement("canvas");s.width=n,s.height=t;let o=s.getContext("2d"),r=t;return o.lineWidth=e.width,o.strokeStyle=vt(e.color,e.opacity),o.moveTo(0,0),o.lineTo(i,0),o.lineTo(i+i/2,r/2),o.lineTo(2*i+i/2,r/2),o.lineTo(3*i,0),o.moveTo(0,r),o.lineTo(i,r),o.lineTo(i+i/2,r/2),o.moveTo(2*i+i/2,r/2),o.lineTo(3*i,r),o.moveTo(0,0),o.lineTo(-i/2,r/2),o.lineTo(0,r),o.stroke(),o.getImageData(0,0,n,t)}(t,i);break;case k.SQUARE:n=function(t,e){let i=document.createElement("canvas");i.width=t,i.height=t;let n=i.getContext("2d");return n.lineWidth=e.width,n.strokeStyle=vt(e.color,e.opacity),n.strokeRect(0,0,t+1,t+1),n.getImageData(0,0,t,t)}(t,i);break;default:throw"Cannot draw unknown type: "+e}return r.c.fromBuffer(new Uint8Array(n.data.buffer),n.width,n.height)}(512,this.gridRes.gridType,this.gridRes);this.internalScale=this.gridRes.size/512,this.sprite.texture=new r.k(t)}updatePos(){void 0!==this.gridRes&&(this.sprite.tileScale.set(this.scaleX*this.internalScale,this.scaleY*this.internalScale),this.sprite.tilePosition.set(this.posX+this.scaleX*this.gridRes.offX*this.gridRes.size,this.posY+this.scaleY*this.gridRes.offY*this.gridRes.size))}closestPoint(t){if(void 0===this.gridRes)return;let e=new r.f(t[0],t[1]);this.sprite.worldTransform.apply(e,e);let i,n,s=e.x/this.internalScale/512-this.gridRes.offX,o=e.y/this.internalScale/512-this.gridRes.offY;switch(this.gridRes.gridType){case k.SQUARE:{let t=Math.floor(s),e=Math.floor(o);i=t,n=e,s>t+.5&&(i+=1),o>e+.5&&(n+=1)}break;case k.HEXAGON:{const t=1/gt;let e=2*(s-t/2)/gt,r=o,a=Math.floor(e),l=Math.floor(r),d=e-a,h=r-l,c=a*gt/2+t/2;a%2==0?h<.5-d/2?(n=l,i=c+t/2):h>d/2+.5?(n=l+1,i=c+t/2):(n=l+.5,i=c+t):h>1-d/2?(n=l+1,i=c+t):h<d/2?(n=l,i=c+t):(n=l+.5,i=c+t/2)}}return e.set((i+this.gridRes.offX)*this.internalScale*512,(n+this.gridRes.offY)*this.internalScale*512),this.sprite.worldTransform.applyInverse(e,e),[e.x,e.y]}destroy(){this.sprite.destroy(pt)}}function vt(t,e){return"#"+(t<<8|255*e).toString(16).padStart(8,"0")}class yt extends o{constructor(t){super(t),this.isDraggingBoard=!1,this.ecs=new rt,this.board=new st,this.board.position.set(0,0),this.board.zIndex=100}setupEcs(){var t;(t=this.ecs).addStorage(new ht("position")),t.addStorage(new dt("name")),t.addStorage(new dt("note")),this.gridSystem=new ft(this.ecs)}onMouseWheel(t){const e=1-.1*Math.sign(t.deltaY);if(this.board.scale.x<.05&&e<1||this.board.scale.x>3&&e>1)return;let i=this.board.position.x-t.clientX,n=this.board.position.y-t.clientY;i*=e,n*=e;const s=new r.f(i+t.clientX,n+t.clientY),o=new r.f(this.board.scale.x*e,this.board.scale.y*e);this.board.position.copyFrom(s),this.board.scale.copyFrom(o),this.gridSystem.posX=s.x,this.gridSystem.posY=s.y,this.gridSystem.scaleX=o.x,this.gridSystem.scaleY=o.y,this.gridSystem.updatePos()}onCursorDown(t){this.isDraggingBoard=!0,this.lastMouseDownTime=Date.now(),this.lastMouseDownPos=t.data.global.clone()}onCursorUp(t){if(this.isDraggingBoard=!1,void 0===this.lastMouseDownTime)return;let e=Date.now()-this.lastMouseDownTime,i=Math.abs(t.data.global.x-this.lastMouseDownPos.x),n=Math.abs(t.data.global.y-this.lastMouseDownPos.y);Math.sqrt(i*i+n*n)<5&&e<500&&this.onCursorClick(t)}onCursorUpOutside(t){this.isDraggingBoard=!1}onCursorMove(t){if(this.isDraggingBoard){let e=t.data.originalEvent;const i=this.board.position.x+e.movementX,n=this.board.position.y+e.movementY;this.board.position.x=i,this.board.position.y=n,this.gridSystem.posX=i,this.gridSystem.posY=n,this.gridSystem.updatePos()}}onCursorClick(t){}onCursorRightDown(t){}centerBoard(){let t=ne.renderer.width/2,e=ne.renderer.height/2,i=this.board.getBounds();this.board.position.set(t-i.x-i.width/2,e-i.y-i.height/2)}applyCanvasStyle(t){const e=t.style;e.position="fixed",e.width="100%",e.height="100%"}enable(){super.enable();const t=ne.view;this.applyCanvasStyle(t),document.body.appendChild(t),ne.stage=new r.d,ne.stage.addChild(this.board),ne.stage.addChild(this.gridSystem.sprite),ne.stage.interactive=!0,ne.stage.on("mousemove",this.onCursorMove,this),ne.stage.on("mousedown",this.onCursorDown,this),ne.stage.on("mouseup",this.onCursorUp,this),ne.stage.on("mouseupoutside",this.onCursorUpOutside,this),ne.stage.on("rightdown",this.onCursorRightDown,this),this.wheelListener=this.onMouseWheel.bind(this),t.addEventListener("wheel",this.wheelListener)}disable(){this.gridSystem.destroy(),ne.stage.off("mousemove",this.onCursorMove,this),ne.stage.off("mousedown",this.onCursorDown,this),ne.stage.off("mouseup",this.onCursorUp,this),ne.stage.off("mouseupoutside",this.onCursorUpOutside,this),ne.stage.off("rightdown",this.onCursorRightDown,this),ne.view.removeEventListener("wheel",this.wheelListener),document.body.removeChild(ne.view),super.disable()}}var wt;!function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.GRID=10]="GRID",t[t.ROOM=20]="ROOM",t[t.ROOM_CREATOR=30]="ROOM_CREATOR"}(wt||(wt={}));var bt=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class _t{constructor(t,e){this.ecs=t,this.phase=e,this.storage=new ht("background_image"),this.ecs.addStorage(this.storage),this.ecs.events.on("entity_spawned",this.onEntitySpawned,this),this.ecs.events.on("component_edited",this.onComponentEdit,this),this.ecs.events.on("component_remove",this.onComponentRemove,this),this.ecs.events.on("selection_begin",this.onSelectionBegin,this),this.ecs.events.on("selection_end",this.onSelectionEnd,this)}onSelectionBegin(t){let e=this.ecs.getComponent(t,"background_image");void 0!==e&&(e._display.tint=7964363)}onSelectionEnd(t){let e=this.ecs.getComponent(t,"background_image");void 0!==e&&(e._display.tint=16777215)}findBackgroundAt(t){let e=new r.g;for(let i of this.storage.allComponents())if(i._display.getLocalBounds(e),e.x+=i._display.position.x,e.y+=i._display.position.y,e.contains(t.x,t.y))return i.entity}enable(){this.displayMaps=new r.d,this.displayMaps.zIndex=wt.BACKGROUND,this.phase.board.addChild(this.displayMaps)}onEntitySpawned(t){return bt(this,void 0,void 0,(function*(){let e=this.ecs.getComponent(t,"background_image");if(void 0===e)return;let i=this.ecs.getComponent(t,"position");if(void 0===i)return;0!==e.image.byteOffset&&(e.image=new Uint8Array(e.image));let[n,s]=yield ut(e.image,e.imageType),o=new r.j(n);o.position.set(i.x,i.y),o.dndBkgImage=t,e._display=o,e._html=s,this.displayMaps.addChild(o),console.log("Sprite added")}))}onComponentEdit(t){if("position"!==t.type)return;let e=t,i=this.ecs.getComponent(t.entity,"background_image");void 0!==i&&i._display.position.set(e.x,e.y)}onComponentRemove(t){if("background_image"!==t.type)return;t._display.destroy(pt)}destroy(){this.displayMaps.destroy(pt)}}class Ct{constructor(t,e,i){this.left=void 0,this.right=void 0,this.point=t,this.parent=e,this.dimension=i}}class Et{constructor(){this.root=void 0}distance(t,e){let i=t[0]-e[0],n=t[1]-e[1];return i*i+n*n}lastSearch(t,e,i){for(;void 0!==e;)i=e,e=t[e.dimension]<e.point[e.dimension]?e.left:e.right;return i}nodeSearch(t){let e=this.root;for(;void 0!==e;){if(t[0]===e.point[0]&&t[1]===e.point[1])return e;e=t[e.dimension]<e.point[e.dimension]?e.left:e.right}}insert(t){let e=this.lastSearch(t,this.root,void 0);if(void 0===e)return void(this.root=new Ct(t,void 0,0));let i=new Ct(t,e,e.dimension+1&1),n=e.dimension;t[n]<e.point[n]?e.left=i:e.right=i}findMin(t,e){if(void 0===t)return;if(t.dimension===e)return void 0!==t.left?this.findMin(t.left,e):t;let i=t.point[e],n=this.findMin(t.left,e),s=this.findMin(t.right,e),o=t;return void 0!==n&&n.point[e]<i&&(o=n),void 0!==s&&s.point[e]<o.point[e]&&(o=s),o}removeNode(t){if(void 0!==t.left||void 0!==t.right)if(void 0!==t.right){let e=this.findMin(t.right,t.dimension),i=e.point;this.removeNode(e),t.point=i}else{let e=this.findMin(t.left,t.dimension),i=e.point;this.removeNode(e),t.right=t.left,t.left=void 0,t.point=i}else{if(void 0===t.parent)return void(this.root=void 0);let e=t.parent.dimension;t.point[e]<t.parent.point[e]?t.parent.left=void 0:t.parent.right=void 0}}remove(t){let e=this.nodeSearch(t);return void 0!==e&&(this.removeNode(e),!0)}nearestPoint(t,e){if(void 0===(e=e||this.root))return;let i,n=this.distance(e.point,t);if(void 0===e.left&&void 0===e.right)return[e.point,n];i=void 0===e.right?e.left:void 0===e.left?e.right:t[e.dimension]<e.point[e.dimension]?e.left:e.right;let s,o,[r,a]=this.nearestPoint(t,i);a<n?(s=r,o=a):(s=e.point,o=n);let l=[t[0],t[1]];if(l[e.dimension]=e.point[e.dimension],this.distance(l,t)<o){let n;if(n=i===e.left?e.right:e.left,void 0!==n){let[e,i]=this.nearestPoint(t,n);i<o&&(s=e,o=i)}}return[s,o]}}function xt(t,e){const i=t.x,n=t.y;let s=!1;const o=e.length/2;for(let t=0,r=o-1;t<o;r=t++){const o=e[2*t],a=e[2*t+1],l=e[2*r],d=e[2*r+1];a>n!=d>n&&i<(n-a)/(d-a)*(l-o)+o&&(s=!s)}return s}class St{constructor(t){this.counter=new Map,this.tree=new Et,this.count=0,this.grid=t}insert(t){let e=t[0]+"|"+t[1],i=this.counter.get(e)||0;this.counter.set(e,i+1),0==i&&this.tree.insert(t),this.count++}remove(t){let e=t[0]+"|"+t[1],i=(this.counter.get(e)||0)-1;if(0==i)this.counter.delete(e),this.tree.remove(t)||console.error("Failed to remove node: "+t);else{if(!(i>0))return!1;this.counter.set(e,i)}return this.count--,!0}findNearest(t){let e=this.tree.nearestPoint(t),i=void 0;if(void 0!==this.grid&&(i=this.grid.closestPoint(t)),void 0!==i){let n=function(t,e,i,n){let s=t-i,o=e-n;return s*s+o*o}(t[0],t[1],i[0],i[1]);if(void 0===e||n<e[1])return[i,n]}return e}}var Mt;!function(t){t[t.NONE=0]="NONE",t[t.SELECTION=1]="SELECTION",t[t.OBSCURED=2]="OBSCURED"}(Mt||(Mt={}));class Rt{constructor(t,e){this.roomStorage=new ht("room"),this.isTranslating=!1,this.ecs=t,this.phase=e,t.addStorage(this.roomStorage),t.events.on("entity_spawned",this.onEntitySpawned,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_remove",this.onComponentRemove,this),t.events.on("selection_begin",this.onSelectionBegin,this),t.events.on("selection_end",this.onSelectionEnd,this),t.events.on("tool_move_begin",this.onToolMoveBegin,this),t.events.on("tool_move_end",this.onToolMoveEnd,this)}findRoomAt(t){for(let e of this.roomStorage.allComponents())if(xt(t,e._worldPolygon))return e.entity}static recomputeWorld(t,e){void 0!==t._worldPolygon&&t._worldPolygon.length===t.polygon.length||(t._worldPolygon=new Array(t.polygon.length));let i=t._worldPolygon;for(let n=0;n<i.length;n+=2)i[n]=t.polygon[n]+e.x,i[n+1]=t.polygon[n+1]+e.y}onEntitySpawned(t){let e=this.ecs.getComponent(t,"room");if(void 0===e)return;let i=this.ecs.getComponent(t,"position");void 0!==i&&(void 0===e._worldPolygon&&Rt.recomputeWorld(e,i),this.addRoom(e))}onComponentEdited(t,e){if("room"!==t.type&&"position"!==t.type)return;let i,n;if("room"===t.type?(i=t,n=this.ecs.getComponent(t.entity,"position")):(i=this.ecs.getComponent(t.entity,"room"),n=t),void 0!==i&&void 0!==n){if(!this.isTranslating){for(let t=0;t<i._worldPolygon.length;t+=2)this.phase.pointDb.remove([i._worldPolygon[t],i._worldPolygon[t+1]])||console.error("Error removing point");Rt.recomputeWorld(i,n);for(let t=0;t<i._worldPolygon.length;t+=2)this.phase.pointDb.insert([i._worldPolygon[t],i._worldPolygon[t+1]])}if("position"===t.type){let t=void 0!==e.x?e.x:n.x,s=void 0!==e.y?e.y:n.y,o=n.x-t,r=n.y-s,a=i._graphics.position;a.set(a.x+o,a.y+r)}else this.redrawComponent(i)}}onComponentRemove(t){"room"===t.type&&t._graphics.destroy(pt)}onSelectionBegin(t){let e=this.ecs.getComponent(t,"room");void 0!==e&&(e._selected=!0,this.redrawComponent(e))}onSelectionEnd(t){let e=this.ecs.getComponent(t,"room");void 0!==e&&(e._selected=void 0,this.redrawComponent(e))}onToolMoveBegin(){this.isTranslating=!0;for(let t of this.phase.selection.getSelectedByType("room")){let e=t;for(let t=0;t<e._worldPolygon.length;t+=2)this.phase.pointDb.remove([e._worldPolygon[t],e._worldPolygon[t+1]])||console.error("Error removing point")}}onToolMoveEnd(){this.isTranslating=!1;for(let t of this.phase.selection.getSelectedByType("room")){let e=t,i=this.ecs.getComponent(e.entity,"position");Rt.recomputeWorld(e,i);for(let t=0;t<e._worldPolygon.length;t+=2)this.phase.pointDb.insert([e._worldPolygon[t],e._worldPolygon[t+1]])}}addVertex(t){this.currentRoom.length>0&&t.x==this.currentRoom[0]&&t.y==this.currentRoom[1]?this.endRoomCreation(!0):(this.currentRoom.push(t.x,t.y),this.phase.pointDb.insert([t.x,t.y]),this.redrawRoomCreation(this.currentRoom,this.currentRoomDisplay,!1,!0,Mt.SELECTION))}undoVertex(t){let e=this.currentRoom.pop(),i=this.currentRoom.pop();void 0!==i&&(this.phase.pointDb.remove([i,e]),this.redrawRoomCreation(this.currentRoom,this.currentRoomDisplay,!1,!0,Mt.SELECTION),this.redrawLastLine(this.currentRoom,t))}initRoomCreation(){this.endRoomCreation(!1),this.currentRoom=[]}addRoom(t){let e=new r.e;this.displayRooms.addChild(e),t._graphics=e,this.redrawComponent(t)}endRoomCreation(t){if(void 0===this.currentRoom)return;this.currentRoomDisplay.clear(),this.currentRoomDisplayLastSegment.clear();let e=this.currentRoom;this.currentRoom=void 0;let i=1/0,n=1/0;for(let t=0;t<e.length;t+=2)i=Math.min(i,e[t]),n=Math.min(n,e[t+1]);let s=new Array(e.length);for(let t=0;t<e.length;t+=2)s[t]=e[t]-i,s[t+1]=e[t+1]-n;if(t){let t=this.ecs.spawnEntity({type:"position",x:i,y:n},{type:"room",polygon:s,_worldPolygon:e,visible:!1});this.phase.selection.setOnlyEntity(t),this.phase.changeTool(Nt.INSPECT)}}redrawComponent(t){t._graphics.position.set(0,0),t._graphics.cacheAsBitmap=!1;let e=Mt.NONE;!0===t._selected?e=Mt.SELECTION:t.visible||(e=Mt.OBSCURED),this.redrawRoomCreation(t._worldPolygon,t._graphics,!0,!1,e)}redrawRoomCreation(t,e,i,n,s){e.clear();let o=0,r=0;if(s===Mt.SELECTION?(o=7964363,r=.2):s===Mt.OBSCURED&&(o=0,r=.5),0!==t.length){s!==Mt.NONE&&e.beginFill(o,r),e.moveTo(t[0],t[1]),e.lineStyle(5);for(let i=2;i<t.length;i+=2)e.lineTo(t[i],t[i+1]);if(i&&e.lineTo(t[0],t[1]),s!==Mt.NONE&&e.endFill(),n){e.lineStyle(0),e.beginFill(15011856),e.drawCircle(t[0],t[1],10),e.endFill(),e.beginFill();for(let i=2;i<t.length;i+=2)e.drawCircle(t[i],t[i+1],10);e.endFill()}}}redrawLastLine(t,e){let i=this.currentRoomDisplayLastSegment;i.clear(),0!==t.length&&(i.lineTo(t[t.length-2],t[t.length-1]),i.lineStyle(5),i.lineTo(e.x,e.y)),i.lineStyle(0),i.beginFill(4218878),i.drawCircle(e.x,e.y,10),i.endFill()}enable(){this.displayRooms=new r.d,this.displayRooms.zIndex=wt.ROOM,this.currentRoomDisplay=new r.e,this.currentRoomDisplay.zIndex=wt.ROOM_CREATOR,this.currentRoomDisplayLastSegment=new r.e,this.currentRoomDisplayLastSegment.zIndex=wt.ROOM_CREATOR+1,this.phase.board.addChild(this.displayRooms,this.currentRoomDisplay,this.currentRoomDisplayLastSegment)}destroy(){this.displayRooms.destroy(pt),this.currentRoomDisplay.destroy(pt),this.currentRoomDisplayLastSegment.destroy(pt)}}const kt=["name","note"],It=["name","note"],At=["note"];class Tt{constructor(t){this.selectedEntities=new Set,this.dataByType=new Map,this.isTranslating=!1,this.translateDirty=!1,this.ecs=t,this.ecs.events.on("tool_move_begin",()=>this.isTranslating=!0),this.ecs.events.on("tool_move_end",()=>{this.isTranslating=!1,this.translateDirty&&(this.translateDirty=!1,this.update())}),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edited",this.onComponentUpdate,this),this.ecs.events.on("component_removed",this.onComponentRemove,this),this.ecs.events.on("entity_despawn",this.onEntityDespawn,this)}update(){this.isTranslating?this.translateDirty=!0:this.ecs.events.emit("selection_update",this)}onComponentAdd(t){this.selectedEntities.has(t.entity)&&(this.getOrCreateData(t.type).entities.add(t),this.update())}onComponentUpdate(t){this.selectedEntities.has(t.entity)&&this.update()}onComponentRemove(t){if(!this.selectedEntities.has(t.entity))return;let e=this.dataByType.get(t.type);e.entities.delete(t),0===e.entities.size&&this.dataByType.delete(t.type),this.update()}onEntityDespawn(t){this.selectedEntities.has(t)&&(this.removeEntity(t),this.update())}clear(t=!0,e=!0){if(t)for(let t of this.selectedEntities)this.ecs.events.emit("selection_end",t);this.selectedEntities.clear(),this.dataByType.clear(),e&&this.update()}setOnlyEntity(t){this.clear(!0,!1),this.addEntity(t)}toggleEntity(t){this.selectedEntities.has(t)?this.removeEntity(t):this.addEntity(t)}addEntity(t){this.selectedEntities.add(t);let e=this.ecs.getAllComponents(t);for(let t of e)this.getOrCreateData(t.type).entities.add(t);this.ecs.events.emit("selection_begin",t),this.update()}removeEntity(t){this.selectedEntities.delete(t);let e=this.ecs.getAllComponents(t);for(let t of e){let e=this.dataByType.get(t.type);e.entities.delete(t),0===e.entities.size&&this.dataByType.delete(t.type)}this.ecs.events.emit("selection_end",t),this.update()}getSelectedByType(t){let e=this.dataByType.get(t);return void 0===e?[]:e.entities}initialComponent(t){return{_canDelete:It.indexOf(t)>=0,_isFullscreen:!(At.indexOf(t)>=0)&&void 0}}getSingleComponents(){let t=new Array,e=this.selectedEntities.values().next().value;for(let i of this.ecs.storages.keys()){if(i.startsWith("host_"))continue;let n=this.ecs.storages.get(i).getComponents(e);for(let e of n)t.push(Ot(this.initialComponent(i),e))}return t}getCommonComponents(){if(0===this.selectedEntities.size)return[];let t=this.selectedEntities.size;if(1===t)return this.getSingleComponents();let e=new Array;for(let i of this.ecs.storages.keys()){if("host_hidden"===i)continue;let n=this.dataByType.get(i);null!=n&&n.entities.size===t&&-1===kt.indexOf(i)&&e.push(i)}let i=new Array;for(let t of e){if("host_hidden"===t)continue;let e=void 0;for(let i of this.selectedEntities){let n=this.ecs.storages.get(t).getComponents(i);for(let i of n)void 0===e?e=Ot(this.initialComponent(t),i):Dt(e,i)}i.push(e)}return i}getCommonEntityOpts(){let t=this.dataByType.get("host_hidden"),e=this.dataByType.get("room");return{hidden:void 0!==t&&t.entities.size===this.selectedEntities.size,forgettable:void 0!==e&&e.entities.size===this.selectedEntities.size}}setProperty(t,e,i,n){if("$"!==t){for(let s of this.selectedEntities){let o={};o[e]=i,this.ecs.editComponent(s,t,o,n)}this.update()}else switch(e){case"hidden":for(let t of this.selectedEntities){let e=this.ecs.getComponent(t,"host_hidden");void 0!==e?this.ecs.removeComponent(e):this.ecs.addComponent(t,{type:"host_hidden",entity:-1})}break;case"forget":alert("TODO: forget room");break;case"delete":for(let t of[...this.selectedEntities])this.ecs.despawnEntity(t);this.clear();break;case"addComponent":let t;switch(i){case"name":t={type:"name",name:"",clientVisible:!0};break;case"note":t={type:"note",note:"",clientVisible:!0};break;default:throw"Cannot add unknown component: "+i}for(let e of[...this.selectedEntities])this.ecs.addComponent(e,Object.assign({},t));break;case"removeComponent":for(let t of[...this.selectedEntities]){let e=this.ecs.getComponent(t,i,n);void 0!==e&&this.ecs.removeComponent(e)}break;default:console.warn("Unknown special event: "+e)}}moveAll(t,e){for(let i of this.selectedEntities){let n=this.ecs.getComponent(i,"position");void 0!==n&&this.ecs.editComponent(i,"position",{x:n.x+t,y:n.y+e})}this.isTranslating?this.translateDirty=!0:this.update()}getOrCreateData(t){let e=this.dataByType.get(t);return void 0===e&&(e={entities:new Set},this.dataByType.set(t,e)),e}hasComponentType(t){let e=this.dataByType.get(t);return void 0!==e&&e.entities.size>0}}function Ot(t,e){for(let i in e)"_"!==i[0]&&(t[i]=e[i]);return t}function Dt(t,e){for(let i in e)"_"!==i[0]&&t[i]!==e[i]&&(t[i]=null);for(let i in t)"_"!==i[0]&&void 0===e[i]&&(t[i]=null)}var Pt=i(28),zt=i.n(Pt);class Bt{constructor(t){this.connections=[],this.connectionsById=new Map,this.myId=-1,this.nextBroadcastPacketId=0,this.eventEmitter=new s,this.isHost=t,this.isHost&&(this.myId=0)}onMessage(t,e){let i=t;if(this.isHost&&(i.sender=e.channelId),i.payload.type.startsWith("_"))console.error("Invalid payload type");else{if(this.isHost&&i.receiver!==this.myId){let t=i.id;if(void 0===i.receiver){i.id=this.nextBroadcastPacketId++;for(let t of this.connectionsById.values())t!==e&&t.send(i)}else{let t=this.connectionsById.get(i.receiver);if(void 0===t)return void this.send({type:"error",errorType:"unknown_receiver",requestId:i.id},e.channelId);i.id=t.nextPacketId++,t.send(i)}i.id=t}if(void 0===i.receiver||i.receiver===this.myId){let t=i.payload.type;0,this.eventEmitter.emit("any",i.payload,i),this.eventEmitter.emit(t,i.payload,i)}}}broadcast(t){const e={id:this.nextBroadcastPacketId,payload:t,sender:this.myId};for(let t of this.connectionsById.values())t.send(e);this.nextBroadcastPacketId++}send(t,e){const i={id:0,payload:t,sender:this.myId};if(this.isHost){let t=this.connectionsById.get(e);if(void 0===t)throw"Unknown receiver";i.id=t.channelId++,t.send(i)}else{i.id=this.nextBroadcastPacketId++;for(let t of this.connectionsById.values())t.send(i)}}registerNewConnection(t){this.connectionsById.set(t.channelId,t),this.connections.push(t),t.ondata=this.onMessage.bind(this),t.nextPacketId=0,this.eventEmitter.emit("_device_join",t.channelId)}removeConnection(t){this.connectionsById.delete(t.channelId);const e=this.connections.indexOf(t);e>-1&&this.connections.splice(e,1),this.eventEmitter.emit("_device_left",t.channelId)}}var Nt,Ft=r.o.EventEmitter;class Lt extends Ft{constructor(t){super(),this.myId=-1,this.nextConnectionId=1,this.isHost=t,this.channel=new Bt(t),this.peer=new zt.a(void 0,{host:"peerjs.92k.de",secure:!0,debug:2}),this.isHost&&(this.myId=0,this.connections=new Map),this.peer.on("connection",this.onConnection.bind(this)),this.peer.on("open",this.onPeerConnectionOpen.bind(this)),this.peer.on("error",this.onPeerConnectionError.bind(this))}onConnection(t){let e=0;this.isHost&&(e=this.nextConnectionId++);let i=new $t(this,e,t);this.isHost?this.connections.set(e,i):this.hostConnection=i}onPeerConnectionOpen(){void 0!==this.connectId&&this.connectReady(),this.emit("ready")}onPeerConnectionError(t){this.emit("error",t)}getId(){return this.peer.id}connectTo(t){if(this.isHost)throw"A host cannot open a connection, for now!";if(void 0!==this.connectId)throw"Cannot connect to multiple hosts";this.connectId=t,null!=this.peer.id&&this.connectReady()}connectReady(){let t=this.peer.connect(this.connectId,{reliable:!0});this.hostConnection=new $t(this,void 0,t)}}class $t{constructor(t,e,i){this.bootstrap=!1,this.parent=t,this.channelId=e,this.connection=i,t.isHost&&(this.bootstrap=!0),i.on("open",this.onOpen.bind(this)),i.on("data",this.onData.bind(this)),i.on("close",this.onClose.bind(this))}onOpen(){this.parent.isHost&&(this.connection.send(this.channelId),this.parent.channel.registerNewConnection(this))}onData(t){if(!this.bootstrap)return this.parent.myId=t,this.parent.channel.myId=t,this.bootstrap=!0,void this.parent.channel.registerNewConnection(this);void 0!==this.ondata&&this.ondata(t,this)}onClose(){}send(t){this.connection.send(t)}}class jt extends yt{constructor(t,e){super(t),this.tool=Nt.INSPECT,this.isMovingSelection=!1,this.movingStart=new r.f(0,0),this.lastMove=new r.f(0,0),this.isHost=e,this.pointDb=new St(this.gridSystem),this.selection=new Tt(this.ecs)}setupEcs(){this.setupNetworkManager(),super.setupEcs(),this.backgroundSystem=new _t(this.ecs,this),this.roomSystem=new Rt(this.ecs,this),this.ecs.events.on("selection_update",t=>{this.vue.selectedEntityOpts=t.getCommonEntityOpts(),this.vue.selectedComponents=t.getCommonComponents()})}setupBoard(){ne.stage.sortableChildren=!0,ne.stage.addChild(this.board)}setupNetworkManager(){this.networkManager=new Lt(this.isHost),this.networkManager.on("ready",this.onNetworkReady,this),this.networkManager.on("error",this.onNetworkError,this)}changeTool(t){let e=this.tool;e===Nt.CREATE_ROOM&&this.roomSystem.endRoomCreation(!1),t!==Nt.MOVE&&t!==Nt.INSPECT&&this.selection.clear(),t===Nt.CREATE_ROOM&&this.roomSystem.initRoomCreation(),this.tool=t,console.log("Changing tool from "+e+" to "+t),this.uiEventEmitter.emit("changeTool",this.tool)}getMapPointFromMouseInteraction(t,e){let i=t.data.getLocalPosition(this.board,e),n=this.pointDb.findNearest([i.x,i.y]);return void 0!==n&&n[1]<100&&i.set(n[0][0],n[0][1]),i}onCursorDown(t){if(super.onCursorDown(t),1!==t.data.button&&this.tool===Nt.MOVE){this.isDraggingBoard=!1,this.isMovingSelection=!0;let e=this.getMapPointFromMouseInteraction(t);this.movingStart.copyFrom(e),this.lastMove.set(0,0),this.ecs.events.emit("tool_move_begin")}}onCursorMove(t){if(super.onCursorMove(t),this.tool===Nt.CREATE_ROOM){let e=this.getMapPointFromMouseInteraction(t);this.roomSystem.redrawLastLine(this.roomSystem.currentRoom,e)}else if(this.isMovingSelection){let e=this.getMapPointFromMouseInteraction(t),i=e.x-this.movingStart.x,n=e.y-this.movingStart.y,s=i-this.lastMove.x,o=n-this.lastMove.y;this.lastMove.set(i,n),this.selection.moveAll(s,o)}}onCursorUp(t){super.onCursorUp(t),this.isMovingSelection&&(this.isMovingSelection=!1,this.ecs.events.emit("tool_move_end"))}onCursorUpOutside(t){super.onCursorUpOutside(t),this.isMovingSelection=!0}findEntityAt(t){let e=this.roomSystem.findRoomAt(t);return void 0!==e?e:this.backgroundSystem.findBackgroundAt(t)}onCursorClick(t){super.onCursorClick(t);let e=this.getMapPointFromMouseInteraction(t);if(this.tool===Nt.CREATE_ROOM)return void this.roomSystem.addVertex(e);let i=this.findEntityAt(e),n=!!t.data.originalEvent.ctrlKey;this.tool===Nt.INSPECT&&(n?void 0!==i&&this.selection.toggleEntity(i):void 0!==i?this.selection.setOnlyEntity(i):this.selection.clear())}onNetworkReady(){console.log("Network is ready! "+this.networkManager.isHost),this.networkManager.isHost&&(window.location.hash="#p"+this.networkManager.peer.id)}onNetworkError(t){console.error("Error from peerjs: ",t.type),"server-error"===t.type?(alert("Error connecting to peerjs instance, you're offline now"),this.isHost||se.setPhase(new Kt(new S))):"peer-unavailable"===t.type?(console.log("Invalid invite link"),alert("Invalid invite link"),location.hash="",this.isHost||se.setPhase(new Kt(new S))):"network"===t.ty?alert("Connection lost"):alert(t)}onCursorRightDown(t){if(super.onCursorRightDown(t),this.tool===Nt.CREATE_ROOM){let e=this.getMapPointFromMouseInteraction(t);this.roomSystem.undoVertex(e)}}ui(){let t=new nt;return t.phase=this,t.isAdmin=this.isHost,t}enable(){super.enable(),this.setupBoard(),this.backgroundSystem.enable(),this.roomSystem.enable()}disable(){this.roomSystem.destroy(),this.backgroundSystem.destroy(),super.disable()}}!function(t){t.INSPECT="inspect",t.MOVE="move",t.CREATE_ROOM="create_room",t.GRID="grid"}(Nt||(Nt={}));class Yt{constructor(t,e){this.connectedClients=0,this.isEnabled=!1,this.ecs=t,this.channel=e,this.channel.eventEmitter.on("_device_join",this.onDeviceJoin,this),this.channel.eventEmitter.on("_device_left",this.onDeviceLeft,this),this.ecs.events.on("entity_spawn",this.onEntitySpawn,this),this.ecs.events.on("entity_spawned",this.onEntitySpawned,this),this.ecs.events.on("entity_despawn",this.onEntityDespawn,this),this.ecs.events.on("entity_despawned",this.onEntityDespawned,this),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edit",this.onComponentEdit,this),this.ecs.events.on("component_removed",this.onComponentRemoved,this),this.ecs.events.on("resource_add",this.onResourceAdd,this),this.ecs.events.on("resource_edit",this.onResourceEdit,this),this.ecs.events.on("resource_remove",this.onResourceRemove,this)}onDeviceJoin(t){this.connectedClients++,this.isEnabled=!0,this.channel.send({type:"ecs_bootstrap",payload:this.ecs.serializeClient()},t)}onDeviceLeft(t){this.connectedClients--,this.isEnabled=0!==this.connectedClients}onEntitySpawn(t){this.entitySpawning=t}onEntitySpawned(t){if(t!==this.entitySpawning&&!this.ecs.isDeserializing)throw this.entitySpawning=void 0,"Invalid entity spawn";this.entitySpawning=void 0,this.isEnabled&&!this.shouldIgnoreEntity(t)&&this.channel.broadcast(this.createEntitySpawnPacket(t))}onEntityDespawn(t){this.isEnabled&&!this.shouldIgnoreEntity(t)&&(this.entityDespawning=t,this.channel.broadcast({type:"entity_despawn",entityId:t}))}onEntityDespawned(t){this.entityDespawning=void 0}onComponentAdd(t){this.entitySpawning!==t.entity&&this.isEnabled&&("host_hidden"!==t.type?this.shouldIgnoreComponent(t)||this.channel.broadcast({type:"component_add",entityId:t.entity,payload:Xt(t)}):this.channel.broadcast({type:"entity_despawn",entityId:t.entity}))}onComponentEdit(t,e){if(this.isEnabled&&!this.shouldIgnoreEntity(t.entity))if(!0!==e.clientVisible||!1!==t.clientVisible)!1!==e.clientVisible||!1===t.clientVisible?!1!==t.clientVisible&&this.channel.broadcast({type:"component_edit",entityId:t.entity,compType:t.type,multiId:t.multiId,changes:e}):this.channel.broadcast({type:"component_remove",entityId:t.entity,compType:t.type,multiId:t.multiId});else{let i=Object.assign({},t,e);this.channel.broadcast({type:"component_add",entityId:t.entity,payload:Xt(i)})}}onComponentRemoved(t){if(this.entityDespawning!==t.entity&&this.isEnabled)if("host_hidden"!==t.type)this.shouldIgnoreComponent(t)||this.channel.broadcast({type:"component_remove",entityId:t.entity,compType:t.type,multiId:t.multiId});else{if(this.entityDespawning===t.entity)return;this.channel.broadcast(this.createEntitySpawnPacket(t.entity))}}onResourceAdd(t){this.isEnabled&&!0!==t._clientHide&&this.channel.broadcast({type:"resource_add",payload:Ht(t)})}onResourceEdit(t){this.isEnabled&&!0!==t._clientHide&&this.channel.broadcast({type:"resource_remove",resType:t.type})}onResourceRemove(t,e){this.isEnabled&&!0!==t._clientHide&&this.channel.broadcast({type:"resource_edit",resType:t.type,changes:e})}shouldIgnoreComponent(t){return this.shouldIgnoreEntity(t.entity)||!1===t.clientVisible||t.type.startsWith("host_")}shouldIgnoreEntity(t){return this.ecs.hasAllComponents(t,"host_hidden")}createEntitySpawnPacket(t){let e=this.ecs.getAllComponents(t),i=[];for(let t of e)t.type.startsWith("host_")||!1!==t.clientVisible&&i.push(Xt(t));return{type:"entity_spawn",entityId:t,components:i}}destroy(){}}class Ut{constructor(t,e){this.ecs=t,this.channel=e,e.eventEmitter.on("ecs_bootstrap",this.onEcsBootstrap,this),e.eventEmitter.on("entity_spawn",this.onEntitySpawn,this),e.eventEmitter.on("entity_despawn",this.onEntityDespawn,this),e.eventEmitter.on("component_add",this.onComponentAdd,this),e.eventEmitter.on("component_edit",this.onComponentEdit,this),e.eventEmitter.on("component_remove",this.onComponentRemove,this),e.eventEmitter.on("resource_add",this.onResourceAdd,this),e.eventEmitter.on("resource_edit",this.onResourceEdit,this),e.eventEmitter.on("resource_remove",this.onResourceRemove,this)}onEcsBootstrap(t,e){0===e.sender&&this.ecs.deserialize(t.payload)}onEntitySpawn(t,e){0===e.sender&&this.ecs.spawnEntityManual(t.entityId,t.components)}onEntityDespawn(t,e){0===e.sender&&this.ecs.despawnEntity(t.entityId)}onComponentAdd(t,e){0===e.sender&&this.ecs.addComponent(t.entityId,t.payload)}onComponentEdit(t,e){0===e.sender&&this.ecs.editComponent(t.entityId,t.compType,t.changes,t.multiId)}onComponentRemove(t,e){if(0!==e.sender)return;let i=this.ecs.getComponent(t.entityId,t.compType,t.multiId);void 0!==i&&this.ecs.removeComponent(i)}onResourceAdd(t,e){0===e.sender&&this.ecs.addResource(t.payload)}onResourceEdit(t,e){0===e.sender&&this.ecs.editResource(t.resType,t.changes)}onResourceRemove(t,e){0===e.sender&&this.ecs.removeResource(t.resType)}destroy(){}}function Xt(t){let e={};for(let i in t)"_"!==i[0]&&"entity"!==i&&"clientVisible"!==i&&(e[i]=t[i]);return e}function Ht(t){let e={};for(let i in t)"_"!==i[0]&&(e[i]=t[i]);return e}var Vt=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class Wt{constructor(t,e){this.ecs=t,this.channel=e,this.channel.eventEmitter.on("_device_join",this.onDeviceJoin,this),this.roomKnownStorage=new ct("host_room_known"),this.ecs.addStorage(this.roomKnownStorage),this.ecs.events.on("entity_spawned",this.onEntitySpawned,this),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edit",this.onComponentEdit,this),this.ecs.events.on("component_remove",this.onComponentRemove,this)}onDeviceJoin(t){return Vt(this,void 0,void 0,(function*(){let e=this.ecs.storages.get("position"),i=1/0,n=1/0,s=[];for(let t of this.roomKnownStorage.allComponents()){s.push(t.entity);let o=e.getComponent(t.entity);i=Math.min(i,o.x),n=Math.min(n,o.y)}if(0===s.length)return;let o=yield this.cutRoomImage(s);if(null===o)return;let r=yield o.arrayBuffer();this.channel.send({type:"room_map_draw",map:r,mapType:"image/png",mapX:i,mapY:n},t)}))}onEntitySpawned(t){let e=this.ecs.getComponent(t,"room");void 0!==e&&e.visible&&(this.ecs.hasAllComponents(t,"host_hidden")||this.ecs.hasAllComponents(t,"host_room_known")||this.ecs.addComponent(t,{type:"host_room_known"}))}onComponentAdd(t){return Vt(this,void 0,void 0,(function*(){if("host_hidden"===t.type){let e=this.roomKnownStorage.getComponent(t.entity);void 0!==e&&this.ecs.removeComponent(e)}else if("host_room_known"===t.type){if(0===this.channel.connections.length)return;let e=yield this.cutRoomImage([t.entity]);if(null===e)return;let i=yield e.arrayBuffer(),n=this.ecs.getComponent(t.entity,"position");this.channel.broadcast({type:"room_map_draw",map:i,mapType:"image/png",mapX:n.x,mapY:n.y})}}))}onComponentEdit(t,e){return Vt(this,void 0,void 0,(function*(){"room"===t.type?!0===e.visible&&void 0===this.roomKnownStorage.getComponent(t.entity)&&this.ecs.addComponent(t.entity,{type:"host_room_known"}):"position"==t.type&&this.roomKnownStorage.getComponent(t.entity)}))}onComponentRemove(t){return Vt(this,void 0,void 0,(function*(){if("host_hidden"===t.type){let e=this.ecs.getComponent(t.entity,"room");void 0!==e&&e.visible&&this.ecs.addComponent(t.entity,{type:"host_room_known"})}}))}cutRoomImage(t){let e=this.ecs.storages.get("room"),i=this.ecs.storages.get("background_image"),n=this.ecs.storages.get("position"),s=1/0,o=1/0,r=-1/0,a=-1/0;for(let i of t){let t=e.getComponent(i),l=n.getComponent(i);s=Math.min(s,l.x),o=Math.min(o,l.y);let d=t.polygon.length;for(let e=0;e<d;e+=2)r=Math.max(r,t._worldPolygon[e]+l.x),a=Math.max(a,t._worldPolygon[e+1]+l.y)}let l=[];for(let t of i.getComponents()){let e=t._html,i=n.getComponent(t.entity);d=s,h=o,c=r,p=a,m=i.x,u=i.y,g=i.x+e.width,f=i.y+e.height,d<g&&c>m&&h<f&&p>u&&l.push(t)}var d,h,c,p,m,u,g,f;if(0===l.length)return Promise.resolve(null);let v=document.createElement("canvas");v.width=r-s,v.height=a-o;let y=v.getContext("2d");y.beginPath();for(let i of t){let t=e.getFirstComponent(i);y.moveTo(t._worldPolygon[0]-s,t._worldPolygon[1]-o);let n=t.polygon.length;for(let e=2;e<n;e+=2)y.lineTo(t._worldPolygon[e]-s,t._worldPolygon[e+1]-o);y.closePath()}y.clip();for(let t of l){let e=n.getComponent(t.entity),i=t._html,l=e.x+s,d=e.y+o,h=Math.min(r,e.x+i.width)-s,c=Math.min(a,e.y+i.height)-o;y.drawImage(i,l,d,h,c,0,0,h,c)}return new Promise(t=>{v.toBlob(t)})}destroy(){this.channel.eventEmitter.off("_device_join",this.onDeviceJoin,this)}}class Gt{constructor(t,e){this.phase=t,this.ecs=t.ecs,this.channel=e,this.displayMap=new r.j(r.k.EMPTY),this.displayMapTex=void 0,this.ecs.events.on("component_remove",this.onComponentRemove,this),e.eventEmitter.on("room_map_draw",this.onRoomMapDraw,this)}onComponentRemove(t){"room"===t.type&&this.forget([t.entity])}onRoomMapDraw(t,e){return Vt(this,void 0,void 0,(function*(){if(0!==e.sender)return;let[i]=yield ut(t.map,t.mapType);this.addPartialImage(t.mapX,t.mapY,i)}))}forget(t){if(void 0===this.displayMapTex)return;let e=this.ecs.storages.get("room"),i=new r.e;i.lineStyle(3);for(let n of t){let t=e.getComponent(n);i.beginFill(),i.drawPolygon(t._worldPolygon),i.endFill()}i.blendMode=r.b.ERASE;let n=this.displayMap.position,s=new r.d;s.filters=[new r.m.AlphaFilter],s.position.set(-n.x,-n.y);let o=new r.j(this.displayMapTex);o.position.copyFrom(n),s.addChild(o),s.addChild(i);let a=r.h.create({width:this.displayMapTex.width,height:this.displayMapTex.height,scaleMode:r.i.LINEAR});ne.renderer.render(s,a),this.displayMap.texture=a,void 0!==this.displayMapTex&&this.displayMapTex.destroy(!0),this.displayMapTex=a}addPartialImage(t,e,i){let n=new r.j(i),s=new r.j(this.displayMapTex);s.x=this.displayMap.x,s.y=this.displayMap.y,n.position.set(t,e);let o,a,l=this.displayMap.x,d=this.displayMap.y;this.displayMapTex;void 0!==this.displayMapTex?(o=Math.min(t,l),a=Math.min(e,d)):(o=t,a=e);let h=Math.max(t+i.width,l+this.displayMap.width),c=Math.max(e+i.height,d+this.displayMap.height),p=r.h.create({width:Math.ceil(h-o),height:Math.ceil(c-a),scaleMode:r.i.LINEAR}),m=new r.d;m.addChild(n),m.addChild(s),m.position.set(-o,-a),ne.renderer.render(m,p),this.displayMap.texture=p,this.displayMap.x=o,this.displayMap.y=a,void 0!==this.displayMapTex&&this.displayMapTex.destroy(!0),this.displayMapTex=p,m.destroy({children:!1,texture:!0,baseTexture:!0}),s.destroy({children:!1,texture:!1,baseTexture:!1}),n.destroy(pt)}enable(){this.phase.board.addChild(this.displayMap)}destroy(){this.displayMap.destroy(pt),this.channel.eventEmitter.off("room_map_draw",this.onRoomMapDraw,this)}}var qt=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class Kt extends jt{constructor(t){super("editHost",!0),this.map=t,0==this.map.levels.size&&this.map.levels.set(42,new b(42)),this.currentLevel=this.map.levels.values().next().value,this.setupEcs()}setupEcs(){super.setupEcs(),this.ecs.addStorage(new ct("host_hidden")),this.networkSystem=new Yt(this.ecs,this.networkManager.channel),this.roomBackgroundSystem=new Wt(this.ecs,this.networkManager.channel)}onDrop(t){return qt(this,void 0,void 0,(function*(){if(t.stopPropagation(),t.preventDefault(),t.dataTransfer.items){let e=[];for(let i of t.dataTransfer.items){let t=i.getAsFile();null!=t&&e.push(t)}yield this.onFileDrop(e)}else yield this.onFileDrop(t.dataTransfer.files)}))}onDragOver(t){return t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy",!1}onFileDrop(t){return qt(this,void 0,void 0,(function*(){if(0==t.length)return;let e=t[0];e.type.startsWith("image/")&&(this.ecs.spawnEntity({type:"host_hidden"},{type:"name",name:e.name,clientVisible:!1},{type:"position",x:0,y:0},{type:"background_image",imageType:e.type,image:new Uint8Array(yield e.arrayBuffer())}),console.log("Image loaded"))}))}exportMap(){return qt(this,void 0,void 0,(function*(){this.currentLevel.saveFrom(this.ecs);let t=yield this.map.saveToFile();this.saveBlob(t,"map.dndm")}))}saveBlob(t,e){let i=document.getElementById("hidden-download-link"),n=window.URL.createObjectURL(t);i.href=n,i.download=e,i.click(),window.URL.revokeObjectURL(n)}enable(){super.enable(),ne.view.ondrop=this.onDrop.bind(this),ne.view.ondragover=this.onDragOver.bind(this),this.currentLevel.loadInto(this.ecs);this.networkManager.channel.eventEmitter}disable(){this.networkManager.channel.eventEmitter;ne.view.ondrop=void 0,ne.view.ondragover=void 0,super.disable()}}var Jt=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class Qt extends o{constructor(){super("home")}ui(){return new w}createMap(){let t=new S;se.setPhase(new Kt(t))}editMap(t){return Jt(this,void 0,void 0,(function*(){let e=yield S.loadFromFile(t);se.setPhase(new Kt(e))}))}enable(){super.enable(),this.uiEventEmitter.on("create_map",this.createMap,this),this.uiEventEmitter.on("edit",this.editMap,this)}disable(){this.uiEventEmitter.on("edit",this.editMap,this),this.uiEventEmitter.on("create_map",this.createMap,this),super.disable()}}var Zt=i(29);i(54),i(71),i(72);class te extends jt{constructor(t){super("editClient",!1),this.setupEcs(),this.networkManager.connectTo(t)}setupEcs(){super.setupEcs(),this.ecs.addStorage(new ct("host_hidden")),this.networkSystem=new Ut(this.ecs,this.networkManager.channel),this.roomBackgroundSystem=new Gt(this,this.networkManager.channel)}enable(){super.enable(),this.roomBackgroundSystem.enable()}disable(){super.disable(),this.networkSystem.destroy(),this.roomBackgroundSystem.destroy()}}var ee=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};n.default.use(Zt.a);const ie=new class extends s{constructor(t){super(),this.caught=new Set,this.catcher=t}catchEvent(t){this.catcher(t,this),this.caught.add(t)}on(t,e,i){return super.on(t,e,i),this.caught.has(t)||this.catchEvent(t),this}addListener(t,e,i){return super.addListener(t,e,i),this.caught.has(t)||this.catchEvent(t),this}}((t,e)=>{window.addEventListener(t,i=>{e.emit(t,i)})});let ne;const se=new class extends o{constructor(t){super(t)}setPhase(t){this.phase&&this.phase.disable(),this.phase=t,this.phase&&this.phase.enable()}disable(){super.disable(),this.setPhase(null)}}("main");!function(){ee(this,void 0,void 0,(function*(){if(ne=new r.a({resizeTo:window,transparent:!0}),ne.view.addEventListener("contextmenu",t=>{t.preventDefault()}),window.location.hash){const t=window.location.hash.substr(1);t.startsWith("p")?(console.log("Connecting with: peerj2"),se.setPhase(new te(t.substr(1)))):(console.log("Invalid hash"),se.setPhase(new Qt))}else se.setPhase(new Qt)}))}()}]);
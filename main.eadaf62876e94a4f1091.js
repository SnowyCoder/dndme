!function(t){function e(e){for(var n,a,r=e[0],l=e[1],h=e[2],d=0,p=[];d<r.length;d++)a=r[d],Object.prototype.hasOwnProperty.call(s,a)&&s[a]&&p.push(s[a][0]),s[a]=0;for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(t[n]=l[n]);for(c&&c(e);p.length;)p.shift()();return o.push.apply(o,h||[]),i()}function i(){for(var t,e=0;e<o.length;e++){for(var i=o[e],n=!0,r=1;r<i.length;r++){var l=i[r];0!==s[l]&&(n=!1)}n&&(o.splice(e--,1),t=a(a.s=i[0]))}return t}var n={},s={0:0},o=[];function a(e){if(n[e])return n[e].exports;var i=n[e]={i:e,l:!1,exports:{}};return t[e].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=t,a.c=n,a.d=function(t,e,i){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)a.d(i,n,function(e){return t[e]}.bind(null,n));return i},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="";var r=window.webpackJsonp=window.webpackJsonp||[],l=r.push.bind(r);r.push=e,r=r.slice();for(var h=0;h<r.length;h++)e(r[h]);var c=l;o.push([2,1]),i()}([function(t,e,i){"use strict";var n=i(10);i(64);e.a=n},,function(t,e,i){"use strict";i.r(e),i.d(e,"windowEventEmitter",(function(){return G})),i.d(e,"app",(function(){return W})),i.d(e,"stage",(function(){return H}));var n=i(20);class s extends n.a{constructor(t){super(t)}setPhase(t){this.phase&&this.phase.disable(),this.phase=t,this.phase&&this.phase.enable()}disable(){super.disable(),this.setPhase(null)}}var o=i(0),a=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"phase-container text-center"},[t._m(0),t._v(" "),i("div",[i("b-button",{staticClass:"btn-entry",attrs:{variant:"warning",size:"lg"},on:{click:t.onCreateMap}},[t._v("Create Map")])],1),t._v(" "),i("div",[i("b-button",{staticClass:"btn-entry",attrs:{variant:"info",size:"lg"},on:{click:t.onEditMap}},[t._v("Edit Map")])],1),t._v(" "),i("b-modal",{ref:"map-load-modal",attrs:{"hide-footer":"",title:"Gimme the map"}},[i("b-form-file",{attrs:{state:Boolean(t.file),placeholder:"Choose a file or drop it here...","drop-placeholder":"Drop file here...",accept:".dndm"},model:{value:t.file,callback:function(e){t.file=e},expression:"file"}})],1),t._v(" "),i("footer-component")],1)};a._withStripped=!0;var r=i(13),l=function(){var t=this.$createElement;this._self._c;return this._m(0)};l._withStripped=!0;var h=r.default.extend({}),c=(i(65),i(6)),d=Object(c.a)(h,l,[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"footer"},[e("div",{staticClass:"credits"},[e("div",{staticClass:"links"},[e("a",{staticClass:"github",attrs:{href:"https://github.com/SnowyCoder/dndme",target:"_blank"}})]),this._v(" "),e("small",{staticStyle:{color:"lightgray"}},[this._v("\n            Developed by "),e("a",{staticClass:"profile",attrs:{href:"https://github.com/SnowyCoder",target:"_blank"}},[this._v("Rossi Lorenzo")]),this._v(" /\n            Drawings by "),e("span",{staticStyle:{color:"white"}},[this._v("Giorgia Nizzoli")])])])])}],!1,null,"539f2bff",null);d.options.__file="src/app/ui/footer.vue";var p=d.exports,u=function(){var t=this.$createElement,e=this._self._c||t;return e("b-modal",{ref:"my-modal",attrs:{"hide-footer":"",title:"Gimme the map"}},[e("div",{staticClass:"d-block text-center"},[e("h3",[this._v("Insert map to load")])]),this._v(" "),e("b-button",{staticClass:"mt-3",attrs:{variant:"outline-danger",block:""},on:{click:this.hideModal}},[this._v("Cancel")])],1)};u._withStripped=!0;var m={name:"mapInput",data:()=>({file:null}),methods:{onDrop:function(t){},hideModal:function(t){this.$emit("close")}}},y=Object(c.a)(m,u,[],!1,null,"7e9d406c",null);y.options.__file="src/app/ui/home/mapInput.vue";var g=y.exports,f=r.default.extend({data:()=>({file:null,pendingOp:""}),components:{MapInput:g,FooterComponent:p},methods:{onCreateMap(){this.eventEmitter.emit("create_map")},onEditMap(){this.pendingOp="edit",this.$refs["map-load-modal"].show(),this.eventEmitter.emit("edit_map")},mapLoadCancel(){this.$refs["map-load-modal"].hide()}},watch:{file:function(t){null!=t&&(console.log("File dropped, loading: "+this.pendingOp),this.eventEmitter.emit(this.pendingOp,this.file),this.file=null,this.mapLoadCancel())}}}),v=(i(68),Object(c.a)(f,a,[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title-container"},[e("h1",{staticClass:"title h1"},[this._v("DrawNDice")]),this._v(" "),e("p",{},[this._v("Dnd made ez!")])])}],!1,null,"d8550b4a",null));v.options.__file="src/app/ui/home/home.vue";var b=v.exports,_=i(25),C=i(26),w=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function r(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,r)}l((n=n.apply(t,e||[])).next())}))};class x extends n.a{constructor(){super("home")}ui(){return new b}createMap(){let t=new _.a;H.setPhase(new C.a(t))}editMap(t){return w(this,void 0,void 0,(function*(){let e=yield _.a.loadFromFile(t);H.setPhase(new C.a(e))}))}enable(){super.enable(),this.uiEventEmitter.on("create_map",this.createMap,this),this.uiEventEmitter.on("edit",this.editMap,this)}disable(){this.uiEventEmitter.on("edit",this.editMap,this),this.uiEventEmitter.on("create_map",this.createMap,this),super.disable()}}var E=i(19);var S=i(54),T=(i(81),i(98),i(99),i(41)),P=i(40),A=i(7);class I extends T.a{constructor(t){super("editClient",!1),this.setupEcs(),this.networkManager.connectTo(t)}setupEcs(){super.setupEcs(),this.ecs.addStorage(new A.a("host_hidden",!1,!0)),this.networkSystem=new P.a(this.ecs,this.networkManager.channel)}enable(){super.enable()}disable(){super.disable(),this.networkSystem.destroy()}}var O=i(4),L=i(10),M=i.p+"461f357929f9f8d63da20b81e743a099.png",k=i(53),N=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function r(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,r)}l((n=n.apply(t,e||[])).next())}))},R=L.BaseTexture,Y=L.resources.ImageResource;function X(t,e,i,n){return N(this,void 0,void 0,(function*(){return new Promise((s,o)=>{console.log("[Spritesheet] Loading: "+e);const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{const i=new L.Texture(new R(new Y(a))),o=new L.Spritesheet(i,n);t.resources[e]=new L.LoaderResource(e,""),t.resources[e].spritesheet=o,o.parse(()=>{console.log("[Spritesheet] Loaded: "+e),s(o)})},a.src=i})}))}var V=function(){var t=this.$createElement;this._self._c;return this._m(0)};V._withStripped=!0;var D=r.default.extend(),B=Object(c.a)(D,V,[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",{staticClass:"title-container"},[e("h1",{staticClass:"title"},[this._v("Carcassonne")]),this._v(" "),e("small",[this._v("Loading...")])])])}],!1,null,null,null);B.options.__file="src/app/ui/loading/loading.vue";var z=B.exports;class j extends n.a{constructor(){super("loading")}ui(){return new z}}var F=i(24),U=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function r(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,r)}l((n=n.apply(t,e||[])).next())}))};r.default.use(S.a);const G=new class extends E{constructor(t){super(),this.caught=new Set,this.catcher=t}catchEvent(t){this.catcher(t,this),this.caught.add(t)}on(t,e,i){return super.on(t,e,i),this.caught.has(t)||this.catchEvent(t),this}addListener(t,e,i){return super.addListener(t,e,i),this.caught.has(t)||this.catchEvent(t),this}}((t,e)=>{window.addEventListener(t,i=>{e.emit(t,i)})});let W;const H=new s("main");function $(){if(window.location.hash){const t=window.location.hash.substr(1);t.startsWith("p")?(console.log("Connecting with: peerj2"),H.setPhase(new I(t.substr(1)))):(console.log("Invalid hash"),H.setPhase(new x))}else H.setPhase(new x)}!function(){U(this,void 0,void 0,(function*(){W=new o.a.Application,Object(O.d)(),W.renderer.backgroundColor=F.a,W.view.addEventListener("contextmenu",t=>{t.preventDefault()}),H.setPhase(new j),yield function(){return N(this,void 0,void 0,(function*(){const t=L.Loader.shared;yield Promise.all([X(t,"props",M,k)])}))}(),$(),window.onhashchange=function(t){console.log("Hash change"+t.newURL),$()}}))}()},function(t,e,i){"use strict";(function(t){i.d(e,"f",(function(){return l})),i.d(e,"c",(function(){return h})),i.d(e,"h",(function(){return c})),i.d(e,"g",(function(){return p})),i.d(e,"o",(function(){return u})),i.d(e,"i",(function(){return m})),i.d(e,"j",(function(){return y})),i.d(e,"k",(function(){return g})),i.d(e,"n",(function(){return f})),i.d(e,"m",(function(){return v})),i.d(e,"u",(function(){return b})),i.d(e,"s",(function(){return _})),i.d(e,"q",(function(){return C})),i.d(e,"r",(function(){return w})),i.d(e,"b",(function(){return x})),i.d(e,"p",(function(){return E})),i.d(e,"t",(function(){return S})),i.d(e,"l",(function(){return T})),i.d(e,"a",(function(){return P})),i.d(e,"d",(function(){return A})),i.d(e,"v",(function(){return I})),i.d(e,"e",(function(){return O}));var n=i(8),s=i(11),o=i(14),a=i(12),r=i(21);function l(t,e){return t.minX<=e.maxX&&t.maxX>=e.minX&&t.minY<=e.maxY&&t.maxY>=e.minY}function h(t,e){return t.minX<=e.minX&&t.maxX>=e.maxX&&t.minY<=e.minY&&t.maxY>=e.maxY}function c(t,e){return t.minX<=e.x&&t.minY<=e.y&&t.maxX>=e.x&&t.maxY>=e.y}function d(t,e,i){let n=0;return e<t.minX?n|=1:e>t.maxX&&(n|=2),i<t.minY?n|=4:i>t.maxY&&(n|=8),n}function p(t,e){let i=d(t,e.fromX,e.fromY),n=d(t,e.toX,e.toY);return 0===i||0===n||0==(i&n)&&(3==(i|n)||(12==(i|n)||(A(new s.a(t.minX,t.minY,t.minX,t.maxY),e)===P.INTERN||A(new s.a(t.minX,t.maxY,t.maxX,t.maxY),e)===P.INTERN||A(new s.a(t.maxX,t.maxY,t.maxX,t.minY),e)===P.INTERN||A(new s.a(t.maxX,t.minY,t.minX,t.minY),e)===P.INTERN)))}function u(t,e,i){return Object(a.a)(t.x,t.y,e.x,e.y)<i*i}function m(t,e,i){let n=Math.abs(t.x-(i.minX+i.maxX)/2),s=Math.abs(t.y-(i.minY+i.maxY)/2),o=(i.maxX-i.minX)/2,a=(i.maxY-i.minY)/2;if(n>o+e)return!1;if(s>a+e)return!1;if(n<o||s<a)return!0;let r=n-o,l=s-a;return r*r+l*l<=e*e}function y(t,e,i,n){let s=t.x-i.x,o=t.y-i.y,a=e+n;return s*s+o*o<a*a}function g(e,i,n){if(Object(a.c)(e,n))return!0;let o=new s.a(0,0,0,0),r=new t.Point,l=i*i;for(let t=2;t<n.length;t+=2)if(o.fromX=n[t-2],o.fromY=n[t-1],o.toX=n[t],o.toY=n[t+1],o.projectPoint(e,r,!0),Object(a.a)(r.x,r.y,e.x,e.y)<=l)return!0;return!1}function f(t,e){let i=n.a.zero();if(i.wrapPolygon(e),!E(t,i))return!1;for(let i=0;i<8;i+=2){let n={x:t.rotVertex[i],y:t.rotVertex[i+1]};if(Object(a.c)(n,e))return!0}for(let i=0;i<e.length;i+=2){if(_(t,{x:e[i],y:e[i+1]}))return!0}let o=[[0,2],[2,4],[4,6],[6,0]];for(let i of o){if(v(new s.a(t.rotVertex[i[0]],t.rotVertex[i[0]+1],t.rotVertex[i[1]],t.rotVertex[i[1]+1]),e))return!0}return!1}function v(t,e){let i=e.length-2;for(let n=0;n<i;n+=2){if(A(t,new s.a(e[n],e[n+1],e[n+2],e[n+3]))==P.INTERN)return!0}return A(t,new s.a(e[0],e[1],e[e.length-2],e[e.length-1]))==P.INTERN}function b(e,i,n){let s=Math.sin(-i),o=Math.cos(-i),a=n.x-e.x,r=n.y-e.y;return new t.Point(a*o-r*s+e.x,a*s+r*o+e.y)}function _(t,e){let i=b(t.unrotated.getCenter(),t.rotation,e);return c(t.unrotated,i)}function C(t,e,i){return m(b(t.unrotated.getCenter(),t.rotation,e),i,t.unrotated)}function w(t,e){let i=t.unrotated.getCenter(),n=b(i,t.rotation,{x:e.fromX,y:e.fromY}),o=b(i,t.rotation,{x:e.toX,y:e.toY});return p(t.unrotated,new s.a(n.x,n.y,o.x,o.y))}function x(t,e,i){let n=new Array(8),s=i||{x:(t.minX+t.maxX)/2,y:(t.minY+t.maxY)/2};for(let i=0;i<4;i++){let o=(2&i)>>>1,a=b(s,e,{x:1&i?t.minX:t.maxX,y:o?t.minY:t.maxY});n[2*i]=a.x,n[2*i+1]=a.y}return n}function E(t,e){let i=n.a.zero();if(i.wrapPolygon(t.rotVertex),l(e,i))return!0;let s=x(e,t.rotation,t.unrotated.getCenter());return i.reset(),i.wrapPolygon(s),l(t.unrotated,i)}function S(t,e){let i=e.unrotated.getCenter(),n=e.unrotated.copy();return n.translate(-i.x,-i.y,n),E(r.a.rotateAabb(n,e.rotation-t.rotation),t.unrotated)}function T(e,i,n){let s=new t.Point;return!!e.projectPoint(i,s,!0)&&Object(a.a)(s.x,s.y,i.x,i.y)<n*n}var P;function A(t,e,i){let n=(e.toY-e.fromY)*(t.toX-t.fromX)-(e.toX-e.fromX)*(t.toY-t.fromY);if(0===n)return P.NONE;const s=((e.toX-e.fromX)*(t.fromY-e.fromY)-(e.toY-e.fromY)*(t.fromX-e.fromX))/n;if(s<-o.a||s>1+o.a)return P.NONE;const a=((t.toX-t.fromX)*(t.fromY-e.fromY)-(t.toY-t.fromY)*(t.fromX-e.fromX))/n;if(a<-o.a||a>1+o.a)return P.NONE;void 0!==i&&i.set(t.fromX+s*(t.toX-t.fromX),t.fromY+s*(t.toY-t.fromY));let r=0;return(s<o.a||s>1-o.a)&&(r|=P.EDGE_A),(a<o.a||a>1-o.a)&&(r|=P.EDGE_B),0===r?P.INTERN:r}function I(t,e,i,n){let s=.5*(-i.y*n.x+e.y*(-i.x+n.x)+e.x*(i.y-n.y)+i.x*n.y),a=s<0?-1:1,r=(e.y*n.x-e.x*n.y+(n.y-e.y)*t.x+(e.x-n.x)*t.y)*a,l=(e.x*i.y-e.y*i.x+(e.y-i.y)*t.x+(i.x-e.x)*t.y)*a;return r-o.a>0&&l-o.a>0&&r+l<2*s*a-o.a}function O(t,e,i,n){return Math.abs(e*i-n*t)<o.a}!function(t){t[t.NONE=0]="NONE",t[t.INTERN=1]="INTERN",t[t.EDGE_A=2]="EDGE_A",t[t.EDGE_B=4]="EDGE_B"}(P||(P={}))}).call(this,i(10))},function(t,e,i){"use strict";i.d(e,"b",(function(){return o})),i.d(e,"c",(function(){return a})),i.d(e,"e",(function(){return l})),i.d(e,"a",(function(){return h})),i.d(e,"d",(function(){return c}));var n=i(0),s=i(2);const o={children:!0,texture:!0,baseTexture:!0},a={children:!1,texture:!1,baseTexture:!1},r=["jpeg","png","x-jg","bmp","x-icon","ief","pjpeg","x-portable-bitmap","x-rgb","tiff","x-tiff"];function l(t,e){!function(t){if(!t.startsWith("image/"))throw"Invalid type: it should be an image";if(r.indexOf(t.substr("image/".length))<0)throw"Unsupported image type"}(e);let i=new Uint8Array(t),s="data:"+e+";base64,"+btoa(i.reduce((t,e)=>t+String.fromCharCode(e),""));return new Promise((t,e)=>{let i=new Image;i.onload=()=>{const e=new n.a.Texture(new n.a.BaseTexture(new n.a.resources.ImageResource(i)));t([e,i])},i.onerror=e,i.src=s})}var h;function c(){let t=s.app.renderer.gl,e=s.app.renderer.state.blendModes;e[h.MULTIPLY_COLOR_ONLY]=[t.DST_COLOR,t.ZERO,t.ONE,t.ZERO],e[h.ADD_WHERE_ALPHA_1]=[t.DST_ALPHA,t.ONE,t.ZERO,t.ONE]}!function(t){t[t.MULTIPLY_COLOR_ONLY=30]="MULTIPLY_COLOR_ONLY",t[t.ADD_WHERE_ALPHA_1=31]="ADD_WHERE_ALPHA_1"}(h||(h={}))},function(t,e,i){"use strict";(function(t){i.d(e,"b",(function(){return n})),i.d(e,"h",(function(){return p})),i.d(e,"c",(function(){return u})),i.d(e,"d",(function(){return m})),i.d(e,"f",(function(){return y})),i.d(e,"i",(function(){return g})),i.d(e,"g",(function(){return f})),i.d(e,"e",(function(){return v})),i.d(e,"j",(function(){return b})),i.d(e,"a",(function(){return C}));var n,s=i(3),o=i(8),a=i(12),r=i(21),l=i(38),h=i(7),c=i(28),d=i(55);function p(t){return{type:n.POINT,pos:t}}function u(t){return{type:n.AABB,data:t}}function m(t,e){return{type:n.CIRCLE,pos:t,radius:e}}function y(t){return{type:n.LINE,data:t}}function g(t){return{type:n.POLYGON,polygon:t}}function f(t){return{type:n.OBB,data:t}}function v(t,e){e.type<t.type&&([e,t]=[t,e]);let i=t.type,o=e.type;if(i===n.POINT){let i=t;switch(o){case n.POINT:return!1;case n.AABB:return Object(s.h)(e.data,i.pos);case n.CIRCLE:return Object(s.o)(i.pos,e.pos,e.radius);case n.LINE:return!1;case n.POLYGON:return Object(a.c)(i.pos,e.polygon);case n.OBB:return Object(s.s)(e.data,i.pos)}}else if(i===n.AABB){let i=t;switch(o){case n.AABB:return Object(s.f)(e.data,i.data);case n.CIRCLE:return Object(s.i)(e.pos,e.radius,i.data);case n.LINE:return Object(s.g)(i.data,e.data);case n.POLYGON:return Object(s.n)(r.a.fromAabb(i.data),e.polygon);case n.OBB:return Object(s.p)(e.data,i.data)}}else if(i===n.CIRCLE){let i=t;switch(o){case n.CIRCLE:return Object(s.j)(e.pos,e.radius,i.pos,i.radius);case n.LINE:return Object(s.l)(e.data,i.pos,i.radius);case n.POLYGON:return Object(s.k)(i.pos,i.radius,e.polygon);case n.OBB:return Object(s.q)(e.data,i.pos,i.radius)}}else if(i===n.LINE){let i=t;switch(o){case n.LINE:return Object(s.d)(i.data,e.data)==s.a.INTERN;case n.POLYGON:return Object(s.m)(i.data,e.polygon);case n.OBB:return Object(s.r)(e.data,i.data)}}else if(i===n.POLYGON){let i=t;switch(o){case n.POLYGON:break;case n.OBB:return Object(s.n)(e.data,i.polygon)}}else if(i===n.OBB)return Object(s.t)(t.data,e.data);throw"Query not implemented: "+i+" vs "+o}function b(t){switch(t.type){case n.POINT:return o.a.fromPoint(t.pos);case n.AABB:return t.data;case n.CIRCLE:{let e=t;return new o.a(e.pos.x-e.radius,e.pos.y-e.radius,e.pos.x+e.radius,e.pos.y+e.radius)}case n.LINE:{let e=t.data;return new o.a(e.fromX,e.fromY,e.toX,e.toY)}case n.POLYGON:{let e=o.a.zero();return e.wrapPolygon(t.polygon),e}case n.OBB:{let e=o.a.zero();return e.wrapPolygon(t.data.rotVertex),e}default:throw"Unknown shape type: "+t.type}}function _(t,e,i){switch(t.type){case n.CIRCLE:case n.POINT:{let n=t;n.pos.x+=e,n.pos.y+=i;break}case n.AABB:{let n=t.data;n.translate(e,i,n);break}case n.LINE:{let n=t.data;n.fromX+=e,n.fromY+=i,n.toX+=e,n.toY+=i;break}case n.POLYGON:{let n=t,s=n.polygon.length;for(let t=0;t<s;t+=2)n.polygon[t]+=e,n.polygon[t+1]+=i;break}case n.OBB:{let n=t.data;n.unrotated.translate(e,i,n.unrotated);let s=n.rotVertex;for(let t=0;t<8;t+=2)s[t]+=e,s[t+1]+=i;break}default:throw"Unknown shape type: "+t.type}}!function(t){t[t.POINT=0]="POINT",t[t.AABB=1]="AABB",t[t.CIRCLE=2]="CIRCLE",t[t.LINE=3]="LINE",t[t.POLYGON=4]="POLYGON",t[t.OBB=5]="OBB"}(n||(n={}));class C{constructor(t,e){this.storage=new h.c("interaction",!1,!1),this.isTranslating=!1,this.aabbTree=new l.a,this.ecs=t,this.phase=e,this.snapDb=new d.a(e.gridSystem),t.addStorage(this.storage),t.events.on("component_add",this.onComponentAdd,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_remove",this.onComponentRemove,this),t.events.on("tool_move_begin",this.onToolMoveBegin,this),t.events.on("tool_move_end",this.onToolMoveEnd,this),t.events.on("query_hit",this.onQueryHit,this)}registerSnapPoints(t){let e=t.length;for(let i=0;i<e;i+=2)this.snapDb.insert([t[i],t[i+1]])}unregisterSnapPoints(t){let e=t.length;for(let i=0;i<e;i+=2)this.snapDb.remove([t[i],t[i+1]])}unregisterComponent(t){t._snaps&&(this.unregisterSnapPoints(t._snaps),t._snaps=void 0),void 0!==t._treeId&&(this.aabbTree.destroyProxy(t._treeId),t._treeId=void 0)}updateComponent(t){this.unregisterComponent(t),void 0!==t.shape&&(t._treeId=this.aabbTree.createProxy(b(t.shape),t),t.snapEnabled&&(t._snaps=function(t){switch(t.type){case n.POINT:case n.CIRCLE:{let e=t;return[e.pos.x,e.pos.y]}case n.AABB:{let e=t.data;return[e.minX,e.minY,e.minX,e.maxY,e.maxX,e.minY,e.maxX,e.maxY]}case n.LINE:{let e=t.data;return[e.fromX,e.fromY,e.toX,e.toY]}case n.POLYGON:{let e=t.polygon,i=new Array;for(let t=0;t<e.length;t+=2)i.push(e[t],e[t+1]);return i}case n.OBB:{let e=t.data.rotVertex,i=new Array(8);for(let t=0;t<8;t++)i[t]=e[t];return i}default:throw"Unknown shape type: "+t.type}}(t.shape),this.registerSnapPoints(t._snaps)))}savePosPreTranslate(t){let e=this.ecs.getComponent(t.entity,"position");t._translateStartLoc=[e.x,e.y]}updatePosPostTranslate(t){let e=this.ecs.getComponent(t.entity,"position"),i=t._translateStartLoc;_(t.shape,e.x-i[0],e.y-i[1]),t._translateStartLoc=void 0}onComponentAdd(t){"interaction"===t.type&&this.updateComponent(t)}onComponentEdited(t,e){if("interaction"===t.type){let i=t;"shape"in e&&this.updateComponent(i)}else{if("position"===t.type){let i=t,n=this.storage.getComponent(i.entity);if(void 0===n||void 0===n.shape)return;if(this.isTranslating&&this.phase.selection.selectedEntities.has(i.entity))return;let s=void 0!==e.x?e.x:i.x,o=void 0!==e.y?e.y:i.y,a=i.x-s,r=i.y-o;return void(0===a&&0===r||(_(n.shape,a,r),this.updateComponent(n)))}if("transform"===t.type){let i=t,s=this.storage.getComponent(i.entity);if(void 0===s||void 0===s.shape)return;let o=s.shape;if(o.type===n.POINT)return;if(o.type===n.CIRCLE){let t=o;"scale"in e&&(t.radius=t.radius*i.scale/e.scale,this.updateComponent(s))}else{if(o.type!==n.OBB)return void console.warn("Unable to auto-rotate other shapes than OBB, watch your components!");{let t=o;if("scale"in e){let n=i.scale/e.scale;t.data.unrotated.scale(n,n,t.data.unrotated)}t.data.rotation=i.rotation,t.data.recompute(),this.updateComponent(s)}}}}}onComponentRemove(t){"interaction"===t.type&&this.unregisterComponent(t)}onToolMoveBegin(){for(let t of this.phase.selection.getSelectedByType("interaction")){let e=t;this.unregisterComponent(e),this.savePosPreTranslate(e)}this.isTranslating=!0}onToolMoveEnd(){this.isTranslating=!1;for(let t of this.phase.selection.getSelectedByType("interaction")){let e=t;this.updatePosPostTranslate(e),this.updateComponent(e)}}singleHitQuery(t,e){let i=Number.NEGATIVE_INFINITY,n=-1,s=this.queryVisible(t,t=>t.selectPriority>i);for(let t of s)n=t.entity,i=t.selectPriority;-1!==n&&e.addHit(n)}multiHitQuery(t,e){let i=this.queryVisible(t,t=>void 0!==t.selectPriority);for(let t of i)if(e.addHit(t.entity),!e.shouldContinue())return}onQueryHit(t){if(!t.shouldContinue())return;let e;switch(t.type){case c.a.POINT:e=m(t.data,20);break;case c.a.AABB:e=u(t.data);break;default:throw"Unknown query type"}t.multi?this.multiHitQuery(e,t):this.singleHitQuery(e,t)}queryVisible(t,e){let i=void 0;return this.ecs.isMaster||(i=this.ecs.storages.get("player_visible")),void 0===i?this.query(t,e):this.query(t,t=>{let n=i.getComponent(t.entity);return(void 0===n||!n.visible)&&(void 0===e||e(t))})}*query(t,e){let i=b(t);for(let n of this.aabbTree.query(i)){if(e&&!e(n.tag))continue;if(!v(n.tag.shape,t))continue;let i=n.tag.queryCheck;i&&!i(t)||(yield n.tag)}}enable(){}destroy(){}}}).call(this,i(10))},,function(t,e,i){"use strict";function n(t){let e={};for(let i in t)"_"!==i[0]&&"entity"!==i&&"type"!==i&&(e[i]=t[i]);return e}i.d(e,"b",(function(){return s})),i.d(e,"c",(function(){return o})),i.d(e,"a",(function(){return a}));class s{constructor(t,e=!0,i=!0){this.data=new Map,this.type=t,this.sync=e,this.save=i}getFirstComponent(t,e){if(void 0!==e)return this.getComponent(t,e);let i=this.data.get(t);return void 0!==i?i[0]:void 0}getComponent(t,e){let i=this.data.get(t);if(void 0!==i)for(let t of i)if(t.multiId===e)return t}getComponents(t){return void 0!==t?this.data.get(t)||[]:this.allComponents()}*allComponents(){for(let t of this.data.values())for(let e of t)yield e}register(t){let e=this.data.get(t.entity);if(t.multiId>=0)if(void 0===e)this.data.set(t.entity,[t]);else{for(let i of e)if(i.multiId===t.multiId)throw"Invalid pre-assigned multiId";e.push(t)}else if(void 0===e)t.multiId=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),this.data.set(t.entity,[t]);else{let i,n;do{i=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),n=!1;for(let t of e)if(t.multiId===i){n=!0;break}}while(n);t.multiId=i,e.push(t)}}unregister(t){let e=this.data.get(t.entity);void 0!==e&&(1===e.length&&e[0]===t?this.data.delete(t.entity):e.splice(e.indexOf(t),1))}unregisterAllOf(t){this.data.delete(t)}serialize(){let t={};for(let[e,i]of this.data.entries()){let s=new Array;for(let t of i)s.push(n(t));t[e]=s}return t}serializeClient(t){let e={};for(let[i,s]of this.data.entries()){if(t(i))continue;let o=new Array;for(let t of s)!1!==t.clientVisible&&o.push(n(t));0!==o.length&&(e[i]=o)}return e}deserialize(t,e){for(let i in e){let n=parseInt(i);for(let s of e[i]){let e=Object.assign({},s,{type:this.type});t.addComponent(n,e)}}}}class o{constructor(t,e=!0,i=!0){this.data=new Map,this.type=t,this.sync=e,this.save=i}getComponent(t){return this.data.get(t)}getFirstComponent(t){return this.data.get(t)}getComponents(t){if(void 0!==t){let e=this.data.get(t);return void 0===e?[]:[e]}return this.allComponents()}allComponents(){return this.data.values()}register(t){if(void 0!==this.data.get(t.entity))throw"Component of same type already registered";this.data.set(t.entity,t)}unregister(t){let e=this.data.get(t.entity);void 0!==e&&e===t&&this.data.delete(t.entity)}unregisterAllOf(t){this.data.delete(t)}serialize(){let t={};for(let e of this.data.values())t[e.entity]=n(e);return t}serializeClient(t){let e={};for(let i of this.data.values())t(i.entity)||!1===i.clientVisible||(e[i.entity]=n(i));return e}deserialize(t,e){for(let i in e){let n=Object.assign({},e[i],{type:this.type});t.addComponent(parseInt(i),n)}}}class a{constructor(t,e=!0,i=!0){this.data=new Map,this.type=t,this.sync=e,this.save=i}getComponent(t){return this.data.get(t)}getFirstComponent(t){return this.getComponent(t)}getComponents(t){if(void 0!==t){let e=this.getComponent(t);return void 0===e?[]:[e]}return this.allComponents()}allComponents(){return this.data.values()}register(t){if(this.data.has(t.entity))throw"Component of same type already registered";this.data.set(t.entity,t)}unregister(t){this.data.delete(t.entity)}unregisterAllOf(t){this.data.delete(t)}serialize(){return[...this.data.keys()]}serializeClient(t){return[...this.data.keys()].filter(e=>!t(e))}deserialize(t,e){for(let i of e)t.addComponent(i,{type:this.type,entity:-1})}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var n=i(0);class s{constructor(t,e,i,n){t>i&&([t,i]=[i,t]),e>n&&([e,n]=[n,e]),this.minX=t,this.minY=e,this.maxX=i,this.maxY=n}isValid(){return this.minX<this.maxX&&this.minY<this.maxY}getCenter(){return new n.a.Point((this.minX+this.maxX)/2,(this.minY+this.maxY)/2)}getPerimeter(){return 2*(this.maxX-this.minX+this.maxY-this.minY)}translate(t,e,i){i.minX=this.minX+t,i.minY=this.minY+e,i.maxX=this.maxX+t,i.maxY=this.maxY+e}combine(t,e){e.minX=Math.min(this.minX,t.minX),e.minY=Math.min(this.minY,t.minY),e.maxX=Math.max(this.maxX,t.maxX),e.maxY=Math.max(this.maxY,t.maxY)}intersect(t,e){e.minX=Math.max(this.minX,t.minX),e.minY=Math.max(this.minY,t.minY),e.maxX=Math.min(this.maxX,t.maxX),e.maxY=Math.min(this.maxY,t.maxY)}extend(t,e){e.minX=this.minX-t,e.minY=this.minY-t,e.maxX=this.maxX-t,e.maxY=this.maxY-t}scale(t,e,i){let n=(this.minX+this.maxX)/2,s=(this.minY+this.maxY)/2,o=(this.maxX-this.minX)/2,a=(this.maxY-this.minY)/2;i.minX=n-o*t,i.minY=s-a*e,i.maxX=n+o*t,i.maxY=s+a*e}copyFrom(t){this.minX=t.minX,this.minY=t.minY,this.maxX=t.maxX,this.maxY=t.maxY}reset(){this.minX=0,this.minY=0,this.maxX=0,this.maxY=0}wrapPolygon(t){this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY;let e=t.length;for(let i=0;i<e;i+=2)this.minX=Math.min(this.minX,t[i]),this.minY=Math.min(this.minY,t[i+1]),this.maxX=Math.max(this.maxX,t[i]),this.maxY=Math.max(this.maxY,t[i+1])}copy(){let t=s.zero();return t.copyFrom(this),t}toString(){return"AABB("+this.minX.toFixed(2)+", "+this.minY.toFixed(2)+", "+this.maxX.toFixed(2)+", "+this.maxY.toFixed(2)+")"}static zero(){return new s(0,0,0,0)}static fromBounds(t){return new s(t.left,t.top,t.right,t.bottom)}static fromPoint(t){return new s(t.x,t.y,t.x,t.y)}}},function(t,e,i){"use strict";var n;i.d(e,"a",(function(){return n})),function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.GRID=10]="GRID",t[t.LIGHT=100]="LIGHT",t[t.WALL=210]="WALL",t[t.PROP=220]="PROP",t[t.PINS=230]="PINS",t[t.WALL_CREATOR=260]="WALL_CREATOR",t[t.TEXT=300]="TEXT"}(n||(n={}))},,function(t,e,i){"use strict";i.d(e,"a",(function(){return n}));class n{constructor(t,e,i,n){this.fromX=t,this.fromY=e,this.toX=i,this.toY=n}distance(){let t=this.toX-this.fromX,e=this.toY-this.fromY;return Math.sqrt(t*t+e*e)}distanceSquared(){let t=this.toX-this.fromX,e=this.toY-this.fromY;return t*t+e*e}projectPoint(t,e,i=!1){if(this.fromX===this.toX&&this.fromY===this.toY)return!1;let n=(t.x-this.fromX)*(this.toX-this.fromX)+(t.y-this.fromY)*(this.toY-this.fromY);n/=this.distanceSquared();let s=this.fromX+n*(this.toX-this.fromX),o=this.fromY+n*(this.toY-this.fromY);if(i)return e.set(s,o),!0;let a=this.fromX,r=this.toX,l=this.fromY,h=this.toY;return a>r&&([a,r]=[r,a]),l>h&&([l,h]=[h,l]),!!(s>=a&&s<=r&&o>=l&&o<=h)&&(e.set(s,o),!0)}copy(){return new n(this.fromX,this.fromY,this.toX,this.toY)}}},function(t,e,i){"use strict";function n(t,e){const i=t.x,n=t.y;let s=!1;const o=e.length/2;for(let t=0,a=o-1;t<o;a=t++){const o=e[2*t],r=e[2*t+1],l=e[2*a],h=e[2*a+1];r>n!=h>n&&i<(n-r)/(h-r)*(l-o)+o&&(s=!s)}return s}function s(t,e,i,n){let s=t-i,o=e-n;return s*s+o*o}function o(t,e,i,n,s){let o=n.x-i.x,a=n.y-i.y,r=e.x-t.x,l=e.y-t.y,h=a*r-o*l;if(0==h)return!1;let c=(o*(t.y-i.y)-a*(t.x-i.x))/h;return void 0!==s&&s.set(t.x-c*-r,t.y-c*-l),!0}i.d(e,"c",(function(){return n})),i.d(e,"a",(function(){return s})),i.d(e,"b",(function(){return o}))},,function(t,e,i){"use strict";i.d(e,"a",(function(){return l})),i.d(e,"b",(function(){return y}));var n=i(11),s=i(3),o=i(12);class a{constructor(t){this.content=new Array,this.elemMap=new Map,this.cmpLt=t}push(t){this.elemMap.set(t,this.content.length),this.content.push(t),this.bubbleUp(this.content.length-1)}pop(){if(0===this.content.length)return;let t=this.content[0];this.elemMap.delete(t);let e=this.content.pop();return 0!==this.content.length&&(this.content[0]=e,this.elemMap.set(e,0),this.sinkDown(0)),t}popElem(t){let e=this.elemMap.get(t);if(void 0===e)return;this.elemMap.delete(t);let i=this.content.pop();e!==this.content.length&&(this.content[e]=i,this.elemMap.set(i,e),this.sinkDown(e),this.bubbleUp(e))}hasElem(t){return this.elemMap.has(t)}peek(){return this.content[0]}size(){return this.content.length}bubbleUp(t){let e=this.content[t];for(;t>0;){let i=Math.floor((t+1)/2)-1,n=this.content[i];if(!this.cmpLt(e,n))break;this.content[i]=e,this.content[t]=n,this.elemMap.set(e,i),this.elemMap.set(n,t),t=i}}sinkDown(t){let e=this.content.length,i=this.content[t];for(;;){let n,s=2*(t+1),o=s-1,a=null;if(o<e&&(n=this.content[o],this.cmpLt(n,i)&&(a=o)),s<e){let t=this.content[s];this.cmpLt(t,null==a?i:n)&&(a=s)}if(null==a)break;this.content[t]=this.content[a],this.content[a]=i,this.elemMap.set(this.content[t],t),this.elemMap.set(i,a),t=a}}}var r=i(0);const l=1e-7;class h extends r.a.Point{}class c{constructor(t,e){this.from=t,this.to=e}}function d(t,e,i,n,s){let a=new h(t,e),r=new h(i,n);a.angle=Math.atan2(s.y-a.y,s.x-a.x),r.angle=Math.atan2(s.y-r.y,s.x-r.x),a.dist=Object(o.a)(s.x,s.y,a.x,a.y),r.dist=Object(o.a)(s.x,s.y,r.x,r.y);let l=new c(a,r);return a.segment=l,r.segment=l,l}function p(t,e){let i=new Array;for(let t of e)i.push(t.from,t.to);i.sort((t,e)=>t.angle-e.angle);let h=new a((e,i)=>function(t,e,i){if(Object(s.v)(t.from,e.from,e.to,i))return!0;if(Object(s.v)(t.to,e.from,e.to,i))return!0;let o=Object(s.d)(new n.a(e.from.x,e.from.y,i.x,i.y),new n.a(t.from.x,t.from.y,t.to.x,t.to.y));if(o===s.a.INTERN)return!0;let a=Object(s.d)(new n.a(e.to.x,e.to.y,i.x,i.y),new n.a(t.from.x,t.from.y,t.to.x,t.to.y));if(a===s.a.INTERN)return!0;if(0!=(o&s.a.EDGE_B)&&a!==s.a.NONE)return!0;if(0!=(a&s.a.EDGE_B)&&o!==s.a.NONE)return!0;if(((o|a)&(s.a.EDGE_B|s.a.EDGE_A))===s.a.EDGE_B){if(Object(s.d)(new n.a(e.from.x,e.from.y,e.to.x,e.to.y),new n.a(t.from.x,t.from.y,t.to.x,t.to.y))!==s.a.NONE)return!0}return!1}(e,i,t));for(let t of e){let e=t.from.angle,i=t.to.angle,n=!1;n||(n=e<=0&&i>=0&&i-e>Math.PI),n||(n=i<=0&&e>=0&&e-i>Math.PI),n&&h.push(t)}let c=new Array;for(let e=0;e<i.length;){let n=!1,s=e,a=i[e],d=h.peek();do{let t=i[e].segment;if(h.hasElem(t)?(t===d&&(n=!0,a=i[e]),h.popElem(t)):h.push(t),e++,e===i.length)break}while(i[e].angle<i[s].angle+l);if(h.peek().used=!0,n){c.push(a.x,a.y);let e=new r.a.Point,i=h.peek();Object(o.b)(i.from,i.to,t,a,e),Math.abs(e.x-a.x)<l&&Math.abs(e.y-a.y)<l||c.push(e.x,e.y)}else if(h.peek()!=d){let e=new r.a.Point;Object(o.b)(d.from,d.to,t,a,e),c.push(e.x,e.y);let n,p=h.peek();n=Math.abs(p.from.angle-i[s].angle)<l?p.from:p.to,Math.abs(e.x-n.x)<l&&Math.abs(e.y-n.y)<l||c.push(n.x,n.y)}}return c}function u(t,e,i){let n=0;return e<t.minX?n|=1:e>t.maxX&&(n|=2),i<t.minY?n|=4:i>t.maxY&&(n|=8),n}function m(t,e,i){let n=t.fromX,s=t.fromY,o=t.toX,a=t.toY,r=u(e,n,s),l=u(e,o,a);for(;;){if(0==(r|l))return d(n,s,o,a,i);if(0!=(r&l))return;{let t,i,h=l>r?l:r;0!=(8&h)?(t=n+(o-n)*(e.maxY-s)/(a-s),i=e.maxY):0!=(4&h)?(t=n+(o-n)*(e.minY-s)/(a-s),i=e.minY):0!=(2&h)?(i=s+(a-s)*(e.maxX-n)/(o-n),t=e.maxX):0!=(1&h)&&(i=s+(a-s)*(e.minX-n)/(o-n),t=e.minX);let c=u(e,t,i);h===r?(n=t,s=i,r=c):(o=t,a=i,l=c)}}}function y(t,e,i,n){let s=new Array,o=t.length;for(let n=0;n<o;n++){let o=m(t[n],e,i);void 0!==o&&(o.index=n,s.push(o))}s.push(d(e.minX,e.minY,e.minX,e.maxY,i),d(e.minX,e.maxY,e.maxX,e.maxY,i),d(e.maxX,e.maxY,e.maxX,e.minY,i),d(e.maxX,e.minY,e.minX,e.minY,i));let a=p(i,s);if(void 0!==n){let t=s.length-4;for(let e=0;e<t;e++){let t=s[e];t.used&&n.push(t.index)}}return a}},function(t,e,i){"use strict";i.d(e,"b",(function(){return h})),i.d(e,"a",(function(){return c})),i.d(e,"c",(function(){return d})),i.d(e,"d",(function(){return p}));var n=i(0),s=n.a.utils.hex2rgb;const o="\n    precision mediump float;\n    attribute vec2 aVertexPosition;\n    \n    varying vec2 vecPos;\n\n    uniform mat3 translationMatrix;\n    uniform mat3 projectionMatrix;\n\n    void main() {\n        vecPos = aVertexPosition;\n        gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n    }\n";let a=void 0,r=void 0,l=void 0;function h(){void 0===a&&(a=n.a.Program.from(o,"\n    precision mediump float;\n\n    varying vec2 vecPos;\n    \n    uniform vec2 center;\n    uniform float radSquared;\n    uniform vec3 color;\n\n    void main() {\n        vec2 diff = center - vecPos;\n        float distSq = diff.x * diff.x + diff.y * diff.y;\n        float intensity = 1.0 - clamp(distSq / radSquared, 0., 1.);\n        gl_FragColor = vec4(color, 1) * (intensity * intensity);// Pre multiplied alpha\n    }\n"),r=n.a.Program.from(o,"\n    precision mediump float;\n\n    varying vec2 vecPos;\n    \n    uniform vec2 center;\n    uniform float radSquared;\n    uniform vec3 color;\n\n    void main() {\n        vec2 diff = center - vecPos;\n        float distSq = diff.x * diff.x + diff.y * diff.y;\n        float intensity = float(distSq <= radSquared);\n        gl_FragColor = vec4(color, 1) * intensity;// Pre multiplied alpha\n    }\n"),l=n.a.Program.from(o,"\n    precision mediump float;\n\n    varying vec2 vecPos;\n    \n    uniform vec2 center;\n    uniform float radSquared;\n    uniform vec3 color;\n\n    void main() {\n        vec2 diff = center - vecPos;\n        float distSq = diff.x * diff.x + diff.y * diff.y;\n        float intensity = 1.0 - smoothstep(0.9, 1.0, clamp(distSq / radSquared, 0., 1.));\n        gl_FragColor = vec4(color, 1) * intensity;// Pre multiplied alpha\n    }\n"))}function c(t="normal"){let e,i=new n.a.Geometry,s=new n.a.Buffer(new Float32Array(1));switch(i.addAttribute("aVertexPosition",s,2,!1,n.a.TYPES.FLOAT),t){case"normal":e=a;break;case"const":e=r;break;case"player":e=l}let o=new n.a.Shader(e,{center:new Float32Array([.5,.5]),radSquared:10,color:new Float32Array([0,0,0])}),h=new n.a.Mesh(i,o,void 0,n.a.DRAW_MODES.TRIANGLE_FAN);return h.interactive=!1,h.interactiveChildren=!1,h}function d(t,e,i){let n=t.geometry.getBuffer("aVertexPosition"),s=new Float32Array(i.length+4);s[0]=e.x,s[1]=e.y,s.set(i,2),s[i.length+2]=i[0],s[i.length+3]=i[1],n.update(s)}function p(t,e,i,n){let o=t.shader.uniforms,a=o.center;a[0]=e.x,a[1]=e.y,o.radSquared=i,s(n,o.color)}},,,,,function(t,e,i){"use strict";i.d(e,"a",(function(){return o}));var n=i(13),s=i(19);class o{constructor(t){this.name=t,this.uiEventEmitter=new s}log(t){console.log(`[${this.name}] `+t)}ui(){}enable(){this.log("Enabling"),n.default.prototype.eventEmitter=this.uiEventEmitter,this.vue=this.ui(),this.vue&&(this.vue.$mount(),document.body.appendChild(this.vue.$el))}disable(){console.log(`[${this.name}] Disabling`),this.vue&&document.body.removeChild(this.vue.$el)}get[Symbol.toStringTag](){return"ObjectNoObserve"}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var n=i(3);class s{constructor(t,e,i){this.unrotated=t,this.rotation=e,this.rotVertex=i}recompute(){this.rotVertex=Object(n.b)(this.unrotated,this.rotation)}copy(){return new s(this.unrotated.copy(),this.rotation,[...this.rotVertex])}static rotateAabb(t,e){return 0===e?this.fromAabb(t):new s(t,e,Object(n.b)(t,e))}static fromAabb(t){let e=[t.minX,t.minY,t.minX,t.maxY,t.maxX,t.maxY,t.maxX,t.minY];return new s(t,0,e)}}},,function(t,e,i){"use strict";function n(t,e){let i=t.indexOf(e);-1!==i&&t.splice(i,1)}i.d(e,"a",(function(){return n}))},function(t,e,i){"use strict";i.d(e,"a",(function(){return c})),i.d(e,"b",(function(){return d})),i.d(e,"c",(function(){return p}));var n=i(4),s=i(7),o=i(9),a=i(0),r=i(2),l=i(15),h=a.a.utils.hex2rgb;const c=7227180,d={ambientLight:5592405,background:c,needsLight:!0};class p{constructor(t,e){this.storage=new s.c("light"),this.ecs=t,this.phase=e,t.addStorage(this.storage),this.lightSettings=Object.assign({type:"light_settings",_save:!0,_sync:!0},d),t.addResource(this.lightSettings),this.localLightSettings={type:"local_light_settings",visionType:this.ecs.isMaster?"dm":"rp",_save:!0,_sync:!1},t.addResource(this.localLightSettings),t.events.on("component_add",this.onComponentAdd,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_remove",this.onComponentRemove,this),t.events.on("resource_edited",this.onResourceEdited,this)}createLightVisMesh(){let t=l.a();return t.blendMode=n.a.ADD_WHERE_ALPHA_1,this.lightContainer.addChild(t),t}createPlayerVisMesh(){let t=l.a("player");return t.blendMode=a.a.BLEND_MODES.ADD,this.playerContainer.addChild(t),t}updateVisMesh(t,e,i){t.visible=!0,l.c(t,e,i)}updateVisUniforms(t,e,i,n){l.d(t,e,i,n)}disableVisMesh(t){t.visible=!1}updateVisPolygon(t,e,i,n,s){if(void 0!==n||void 0!==(n=this.ecs.getComponent(t,"position")))if(void 0!==s||void 0!==(s=this.ecs.getComponent(t,"visibility")))if(void 0===s.polygon)this.disableVisMesh(e);else{let t=50*s.range;this.updateVisMesh(e,n,s.polygon),this.updateVisUniforms(e,n,t*t,i)}else this.disableVisMesh(e)}updateLightVisPolygon(t,e,i){this.updateVisPolygon(t.entity,t._lightDisplay,t.color,e,i)}updatePlayerVisPolygon(t,e,i){this.updateVisPolygon(t.entity,t._lightVisionDisplay,0,e,i)}onComponentAdd(t){if("light"===t.type){let e=t;e._lightDisplay=this.createLightVisMesh();let i=this.ecs.getComponent(e.entity,"visibility");void 0===i?(i={type:"visibility",range:e.range,trackWalls:!0},this.ecs.addComponent(t.entity,i)):this.updateLightVisPolygon(e,void 0,i)}else if("player"===t.type){let e=t;e._lightVisionDisplay=this.createPlayerVisMesh();let i=this.ecs.getComponent(e.entity,"visibility");void 0===i?(i={type:"visibility",range:e.range,trackWalls:!0},this.ecs.addComponent(t.entity,i)):this.updatePlayerVisPolygon(e,void 0,i)}}onComponentEdited(t,e){if("light"===t.type){let i=t;if("range"in e)this.ecs.editComponent(i.entity,"visibility",{range:i.range});else{let t=this.ecs.getComponent(i.entity,"position"),e=this.ecs.getComponent(i.entity,"visibility");if(void 0!==e.polygon){let n=50*e.range;this.updateVisUniforms(i._lightDisplay,t,n*n,i.color)}}}else if("visibility"===t.type){let i=t;if(!("polygon"in e))return;let n=this.storage.getComponent(i.entity);if(void 0!==n)this.updateLightVisPolygon(n,void 0,i);else{let t=this.ecs.getComponent(i.entity,"player");void 0!==t&&this.updatePlayerVisPolygon(t,void 0,i)}}}onResourceEdited(t){if("light_settings"!==t.type&&"local_light_settings"!==t.type)return;let e=[0,0,0,0];"dm"===this.localLightSettings.visionType&&(e[3]=1),h(this.lightSettings.ambientLight,e),this.lightLayer.clearColor=e,this.playerContainer.visible="dm"!==this.localLightSettings.visionType,r.app.renderer.backgroundColor=this.lightSettings.background}onComponentRemove(t){if("light"===t.type){t._lightDisplay.destroy(n.b)}else if("player"===t.type){t._lightVisionDisplay.destroy(n.b)}}enable(){l.b(),this.lightLayer=new a.a.display.Layer,this.lightLayer.useRenderTexture=!0,this.lightLayer.interactive=!1,this.lightLayer.interactiveChildren=!1,this.playerContainer=new a.a.Container,this.playerContainer.zOrder=o.a.LIGHT-1,this.playerContainer.zIndex=o.a.LIGHT-1,this.playerContainer.interactive=!1,this.playerContainer.interactiveChildren=!1,this.playerContainer.parentLayer=this.phase.lightSystem.lightLayer,this.lightContainer=new a.a.Container,this.lightContainer.zOrder=o.a.LIGHT,this.lightContainer.zIndex=o.a.LIGHT,this.lightContainer.interactive=!1,this.lightContainer.interactiveChildren=!1,this.lightContainer.parentLayer=this.lightLayer,this.onResourceEdited(this.lightSettings);let t=new a.a.Sprite(this.lightLayer.getRenderTexture());t.blendMode=n.a.MULTIPLY_COLOR_ONLY,t.zIndex=o.a.LIGHT,t.interactive=!1,t.interactiveChildren=!1,this.phase.board.addChild(this.playerContainer,this.lightContainer,this.lightLayer),r.app.stage.addChild(t)}destroy(){this.lightContainer.destroy(n.b),this.playerContainer.destroy(n.b),this.lightLayer.destroy(n.b),r.app.renderer.backgroundColor=c}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return l}));var n=i(37),s=i(45),o=i(44),a=i.n(o),r=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function r(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,r)}l((n=n.apply(t,e||[])).next())}))};class l{constructor(){this.levels=new Map}createDataJson(){let t={};for(let[e,i]of this.levels.entries())t[e]=i.serialize();let e={version:l.SER_VERSION,levels:t};return Object(s.encode)(e)}saveToFile(){let t=this.createDataJson(),e=new a.a;return e.file("data.msgpack",t),e.generateAsync({type:"blob"})}static loadFromFile(t){return r(this,void 0,void 0,(function*(){let e=yield a.a.loadAsync(t),i=yield e.file("data.msgpack").async("arraybuffer"),o=yield Object(s.decode)(i);if(o.version!==this.SER_VERSION)throw"Version not supported";let r=new l,h=o.levels;for(let t in h){let e=h[t],i=yield n.a.deserialize(parseInt(t),e);r.levels.set(i.id,i)}return r}))}}l.SER_VERSION="1.0"},function(t,e,i){"use strict";(function(t){i.d(e,"a",(function(){return h}));var n=i(41),s=i(7),o=i(2),a=i(37),r=i(40),l=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function r(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,r)}l((n=n.apply(t,e||[])).next())}))};class h extends n.a{constructor(t){super("editHost",!0),this.map=t,0==this.map.levels.size&&this.map.levels.set(42,new a.a(42)),this.currentLevel=this.map.levels.values().next().value,this.setupEcs()}setupEcs(){super.setupEcs(),this.ecs.addStorage(new s.a("host_hidden",!1,!0)),this.networkSystem=new r.b(this.ecs,this.networkManager.channel)}onDrop(t){return l(this,void 0,void 0,(function*(){t.stopPropagation(),t.preventDefault();let e=t.pageX,i=t.pageY;if(t.dataTransfer.items){let n=[];for(let e of t.dataTransfer.items){let t=e.getAsFile();null!=t&&n.push(t)}yield this.onFileDrop(n,e,i)}else yield this.onFileDrop(t.dataTransfer.files,e,i)}))}onDragOver(t){return t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy",!1}onFileDrop(e,i,n){return l(this,void 0,void 0,(function*(){if(0==e.length)return;let s=e[0],o=new t.Point(i,n);this.board.updateTransform(),this.board.transform.worldTransform.applyInverse(o,o),s.type.startsWith("image/")&&(this.ecs.spawnEntity({type:"name",name:s.name,clientVisible:!1},{type:"position",x:o.x,y:o.y},{type:"transform",rotation:0,scale:1},{type:"background_image",imageType:s.type,image:new Uint8Array(yield s.arrayBuffer())}),console.log("Image loaded"))}))}exportMap(){return l(this,void 0,void 0,(function*(){this.currentLevel.saveFrom(this.ecs);let t=yield this.map.saveToFile();this.saveBlob(t,"map.dndm")}))}saveBlob(t,e){let i=document.getElementById("hidden-download-link"),n=window.URL.createObjectURL(t);i.href=n,i.download=e,i.click(),window.URL.revokeObjectURL(n)}enable(){super.enable(),o.app.view.ondrop=this.onDrop.bind(this),o.app.view.ondragover=this.onDragOver.bind(this),this.currentLevel.loadInto(this.ecs)}disable(){o.app.view.ondrop=void 0,o.app.view.ondragover=void 0,super.disable()}}}).call(this,i(10))},,function(t,e,i){"use strict";i.d(e,"a",(function(){return n})),i.d(e,"b",(function(){return o}));var n,s=i(8);!function(t){t[t.POINT=0]="POINT",t[t.AABB=1]="AABB"}(n||(n={}));class o{constructor(t,e,i,n){this.hits=new Set,this.type=t,this.multi=e,this.aabb=i,this.data=n||i}shouldContinue(){return this.multi||0===this.hits.size}addHit(t){this.shouldContinue()&&this.hits.add(t)}static queryPoint(t,e){return new o(n.POINT,e,new s.a(t.x,t.y,t.x,t.y),t)}static queryAabb(t,e){return new o(n.AABB,e,t)}}},,,,function(t,e,i){var n=i(66);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(22).default)("7c681468",n,!1,{})},function(t,e,i){var n=i(69);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(22).default)("6123dedb",n,!1,{})},function(t,e,i){var n=i(75);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(22).default)("20adba36",n,!1,{})},function(t,e,i){var n=i(77);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(22).default)("0e8a47b6",n,!1,{})},function(t,e,i){var n=i(79);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(22).default)("cf98b6ba",n,!1,{})},function(t,e,i){"use strict";i.d(e,"a",(function(){return n}));class n{constructor(t){this.id=t}loadInto(t){t.clear(),void 0!==this.ecs&&t.deserialize(this.ecs)}saveFrom(t){this.ecs=void 0,this.ecs=t.serialize()}serialize(){return{name:this.name,ecs:this.ecs}}static deserialize(t,e){let i=new n(t);return i.name=e.name,i.ecs=e.ecs,i}}},function(t,e,i){"use strict";i.d(e,"a",(function(){return a}));var n=i(8),s=i(3);class o{constructor(t){this.aabb=n.a.zero(),this.height=-1,this.id=t}toString(){return this.id+": "+this.tag}isLeaf(){return void 0===this.left}}class a{constructor(t=.1,e=2){this.nodes=new Map,this.lastProxyId=0,this.aabbExtension=t,this.aabbMultiplier=e}getTag(t){return this.nodes.get(t).tag}setTag(t,e){}getFatAabb(t){return this.nodes.get(t).aabb}allocateNode(){let t=new o(++this.lastProxyId);return this.nodes.set(t.id,t),t}freeNode(t){this.nodes.delete(t.id)}createProxy(t,e){let i=this.allocateNode();return i.aabb.copyFrom(t),i.aabb.extend(this.aabbExtension,i.aabb),i.tag=e,i.height=0,this.insertLeaf(i),i.id}destroyProxy(t){let e=this.nodes.get(t);this.removeLeaf(e),this.freeNode(e)}moveProxy(t,e,i){let n=this.nodes.get(t);return!Object(s.c)(n.aabb,e)&&(this.removeLeaf(n),n.aabb.copyFrom(e),n.aabb.extend(this.aabbExtension,n.aabb),1!==this.aabbMultiplier&&(i.x<0?e.minX+=i.x*this.aabbMultiplier:e.maxX+=i.x*this.aabbMultiplier,i.y<0?e.minY+=i.y*this.aabbMultiplier:e.maxY+=i.y*this.aabbMultiplier),this.insertLeaf(n),!0)}insertLeaf(t){if(void 0===this.root)return this.root=t,void(this.root.parent=void 0);let e=t.aabb,i=this.root;for(;!i.isLeaf();){let t=i.left,s=i.right,o=i.aabb.getPerimeter(),a=n.a.zero();i.aabb.combine(e,a);let r,l,h=a.getPerimeter(),c=2*h,d=2*(h-o);if(t.isLeaf())t.aabb.combine(e,a),r=a.getPerimeter()+d;else{t.aabb.combine(e,a);let i=t.aabb.getPerimeter();r=a.getPerimeter()-i+d}if(s.isLeaf())s.aabb.combine(e,a),l=a.getPerimeter()+d;else{s.aabb.combine(e,a);let t=s.aabb.getPerimeter();l=a.getPerimeter()-t+d}if(c<r&&c<l)break;i=r<l?t:s}let s=i,o=s.parent,a=this.allocateNode();for(a.parent=o,s.aabb.combine(e,a.aabb),a.height=s.height+1,void 0!==o?o.left===s?o.left=a:o.right=a:this.root=a,a.left=s,a.right=t,s.parent=a,t.parent=a,i=t.parent;void 0!==i;)i=this.balance(i),i.height=1+Math.max(i.left.height,i.right.height),i.left.aabb.combine(i.right.aabb,i.aabb),i=i.parent}removeLeaf(t){if(t===this.root)return void(this.root=void 0);let e,i=t.parent,n=i.parent;if(e=i.left===t?i.right:i.left,void 0!==n){n.left===i?n.left=e:n.right=e,e.parent=n,this.freeNode(i);let t=n;for(;void 0!==t;)t=this.balance(t),t.left.aabb.combine(t.right.aabb,t.aabb),t.height=1+Math.max(t.left.height,t.right.height),t=t.parent}else this.root=e,e.parent=void 0,this.freeNode(i)}balance(t){let e=t;if(e.isLeaf()||e.height<2)return e;let i=e.left,n=e.right,s=n.height-i.height;if(s>1){let t=n.left,s=n.right;return n.left=e,n.parent=e.parent,e.parent=n,void 0!==n.parent?n.parent.left===e?n.parent.left=n:n.parent.right=n:this.root=n,t.height>s.height?(n.right=t,e.right=s,s.parent=e,i.aabb.combine(s.aabb,e.aabb),e.aabb.combine(t.aabb,n.aabb),e.height=1+Math.max(i.height,s.height),n.height=1+Math.max(e.height,t.height)):(n.right=s,e.right=t,t.parent=e,i.aabb.combine(t.aabb,e.aabb),e.aabb.combine(s.aabb,n.aabb),e.height=1+Math.max(i.height,t.height),n.height=1+Math.max(e.height,s.height)),n}if(s<-1){let t=i.left,s=i.right;return i.left=e,i.parent=e.parent,e.parent=i,void 0!==i.parent?i.parent.left===e?i.parent.left=i:i.parent.right=i:this.root=i,t.height>s.height?(i.right=t,e.left=s,s.parent=e,n.aabb.combine(s.aabb,e.aabb),e.aabb.combine(t.aabb,i.aabb),e.height=1+Math.max(n.height,s.height),i.height=1+Math.max(e.height,t.height)):(i.right=s,e.left=t,t.parent=e,n.aabb.combine(t.aabb,e.aabb),e.aabb.combine(s.aabb,i.aabb),e.height=1+Math.max(n.height,t.height),i.height=1+Math.max(e.height,s.height)),i}return e}*query(t){let e=[];if(void 0!==this.root)for(e.push(this.root);e.length>0;){let i=e.pop();Object(s.f)(i.aabb,t)&&(i.isLeaf()?yield i:(e.push(i.left),e.push(i.right)))}}}},function(t,e,i){"use strict";(function(t){i.d(e,"b",(function(){return l})),i.d(e,"a",(function(){return h}));var n=i(7),s=i(23),o=i(5),a=i(8),r=t.utils.EventEmitter;function l(t=!1){return{type:"visibility_aware",entity:-1,visibleBy:[],isWall:t}}class h{constructor(t,e){this.storage=new n.c("visibility_aware",!1,!1),this.events=new r,this.ecs=t,this.phase=e,this.visSys=e.visibilitySystem,t.addStorage(this.storage),t.events.on("component_add",this.onComponentAdd,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_remove",this.onComponentRemove,this)}visibilityChange(t,e,i){if(i*=50,void 0===e){let e=t._canSee;t._canSee=[];for(let i of e){let e=this.storage.getComponent(i);void 0!==e&&(Object(s.a)(e.visibleBy,t.entity),this.events.emit("aware_update",e,[],[t.entity]))}return}let n=t._canSee;t._canSee=[];let a=this.ecs.storages.get("position"),r=this.ecs.storages.get("interaction"),l=a.getComponent(t.entity),h=Object(o.i)(e),c=Object(o.d)(l,i);for(let e of n){let i=r.getComponent(e).shape;if(Object(o.e)(h,i)&&Object(o.e)(c,i))t._canSee.push(e);else{let i=this.storage.getComponent(e);Object(s.a)(i.visibleBy,t.entity),this.events.emit("aware_update",i,[],[t.entity])}}let d=this.phase.interactionSystem.query(h,t=>{let e=this.storage.getComponent(t.entity);return void 0!==e&&!0!==e.isWall&&-1===n.indexOf(t.entity)});for(let e of d){let i=r.getComponent(e.entity).shape;if(!Object(o.e)(c,i))continue;let n=this.storage.getComponent(e.entity);t._canSee.push(e.entity),n.visibleBy.push(t.entity),this.events.emit("aware_update",n,[t.entity],[])}}visibleElementMove(t){if(!0===t.isWall)return;let e=this.ecs.storages.get("position"),i=this.ecs.storages.get("visibility"),n=e.getComponent(t.entity),r=this.ecs.getComponent(t.entity,"interaction").shape,l=t.visibleBy;t.visibleBy=[];let h=[],c=[];for(let s of this.phase.visibilitySystem.aabbTree.query(a.a.fromPoint(n))){let n=s.tag.entity,a=i.getComponent(n);if(void 0===a||-1!==l.indexOf(n))continue;let c=e.getComponent(n),d=50*i.getComponent(n).range;Object(o.e)(Object(o.d)(c,d),r)&&Object(o.e)(r,Object(o.i)(s.tag.polygon))&&(a._canSee.push(t.entity),t.visibleBy.push(a.entity),h.push(a.entity))}for(let n of l){let a=i.getComponent(n),l=e.getComponent(n),h=i.getComponent(n),d=50*h.range;Object(o.e)(Object(o.d)(l,d),r)&&Object(o.e)(r,Object(o.i)(h.polygon))?t.visibleBy.push(n):(Object(s.a)(a._canSee,t.entity),c.push(a.entity))}h.length+c.length>0&&this.events.emit("aware_update",t,h,c)}onViewBlockerEdited(t,e,i){if(i=i||[],0===e.length){for(let e of i){let i=this.storage.getComponent(e);void 0!==i&&(Object(s.a)(i.visibleBy,t.entity),this.events.emit("aware_update",i,[],[t.entity]))}return}let n=[];for(let o of i){if(-1!==e.indexOf(o)){n.push(o);continue}let i=this.storage.getComponent(o);void 0!==i&&(Object(s.a)(i.visibleBy,t.entity),this.events.emit("aware_update",i,[],[t.entity]))}for(let i of e){if(-1!==n.indexOf(i))continue;let e=this.storage.getComponent(i);void 0!==e&&(e.visibleBy.push(t.entity),this.events.emit("aware_update",e,[t.entity],[]))}}onComponentAdd(t){"visibility_aware"===t.type&&this.visibleElementMove(t)}onComponentEdited(t,e){if("visibility"===t.type){let i=t;"polygon"in e&&this.visibilityChange(i,i.polygon,i.range),"_canSeeWalls"in e&&this.onViewBlockerEdited(i,i._canSeeWalls,e.walls)}else if("position"===t.type){let e=this.storage.getComponent(t.entity);if(void 0===e)return;this.visibleElementMove(e)}}onComponentRemove(t){if("visibility"===t.type){let e=t;this.visibilityChange(e,void 0,0),this.onViewBlockerEdited(e,[],e._canSeeWalls)}else if("visibility_aware"===t.type){let e=t;e.visibleBy;let i=this.ecs.storages.get("visibility");for(let t of e.visibleBy){let n=i.getComponent(t);Object(s.a)(n._canSee,e.entity)}}}enable(){}destroy(){}}}).call(this,i(10))},function(t,e,i){"use strict";i.d(e,"b",(function(){return n})),i.d(e,"a",(function(){return s}));class n{constructor(t,e){this.connectedClients=0,this.isEnabled=!1,this.ecs=t,this.channel=e,this.channel.eventEmitter.on("_device_join",this.onDeviceJoin,this),this.channel.eventEmitter.on("_device_left",this.onDeviceLeft,this),this.ecs.events.on("entity_spawn",this.onEntitySpawn,this),this.ecs.events.on("entity_spawned",this.onEntitySpawned,this),this.ecs.events.on("entity_despawn",this.onEntityDespawn,this),this.ecs.events.on("entity_despawned",this.onEntityDespawned,this),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edit",this.onComponentEdit,this),this.ecs.events.on("component_removed",this.onComponentRemoved,this),this.ecs.events.on("resource_add",this.onResourceAdd,this),this.ecs.events.on("resource_edit",this.onResourceEdit,this),this.ecs.events.on("resource_remove",this.onResourceRemove,this)}onDeviceJoin(t){this.connectedClients++,this.isEnabled=!0,this.channel.send({type:"ecs_bootstrap",payload:this.ecs.serializeClient()},t)}onDeviceLeft(t){this.connectedClients--,this.isEnabled=0!==this.connectedClients}onEntitySpawn(t){this.entitySpawning=t}onEntitySpawned(t){if(t!==this.entitySpawning&&!this.ecs.isDeserializing)throw this.entitySpawning=void 0,"Invalid entity spawn";this.entitySpawning=void 0,this.isEnabled&&!this.shouldIgnoreEntity(t)&&this.channel.broadcast(this.createEntitySpawnPacket(t))}onEntityDespawn(t){this.isEnabled&&!this.shouldIgnoreEntity(t)&&(this.entityDespawning=t,this.channel.broadcast({type:"entity_despawn",entityId:t}))}onEntityDespawned(t){this.entityDespawning=void 0}onComponentAdd(t){this.entitySpawning!==t.entity&&this.isEnabled&&("host_hidden"!==t.type?this.shouldIgnoreComponent(t)||this.channel.broadcast({type:"component_add",entityId:t.entity,payload:o(t)}):this.channel.broadcast({type:"entity_despawn",entityId:t.entity}))}onComponentEdit(t,e){if(this.isEnabled&&!this.shouldIgnoreEntity(t.entity))if(!0!==e.clientVisible||!1!==t.clientVisible)!1!==e.clientVisible||!1===t.clientVisible?this.shouldIgnoreComponent0(t)||this.channel.broadcast({type:"component_edit",entityId:t.entity,compType:t.type,multiId:t.multiId,changes:Object.assign({},e)}):this.channel.broadcast({type:"component_remove",entityId:t.entity,compType:t.type,multiId:t.multiId});else{let i=Object.assign({},t,e);this.channel.broadcast({type:"component_add",entityId:t.entity,payload:o(i)})}}onComponentRemoved(t){if(this.entityDespawning!==t.entity&&this.isEnabled)if("host_hidden"!==t.type)this.shouldIgnoreComponent(t)||this.channel.broadcast({type:"component_remove",entityId:t.entity,compType:t.type,multiId:t.multiId});else{if(this.entityDespawning===t.entity)return;this.channel.broadcast(this.createEntitySpawnPacket(t.entity))}}onResourceAdd(t){this.isEnabled&&!0===t._sync&&this.channel.broadcast({type:"resource_add",payload:a(t)})}onResourceEdit(t,e){this.isEnabled&&!0===t._sync&&this.channel.broadcast({type:"resource_edit",resType:t.type,changes:Object.assign({},e)})}onResourceRemove(t){this.isEnabled&&!0===t._sync&&this.channel.broadcast({type:"resource_remove",resType:t.type})}shouldIgnoreComponent(t){return!!this.shouldIgnoreEntity(t.entity)||this.shouldIgnoreComponent0(t)}shouldIgnoreComponent0(t){return!1===t.clientVisible||!this.ecs.storages.get(t.type).sync}shouldIgnoreEntity(t){return this.ecs.hasAllComponents(t,"host_hidden")}createEntitySpawnPacket(t){this.ecs.events.emit("serialize_entity",t);let e=this.ecs.getAllComponents(t),i=[];for(let t of e)this.shouldIgnoreComponent0(t)||i.push(o(t));return{type:"entity_spawn",entityId:t,components:i}}destroy(){}}class s{constructor(t,e){this.ecs=t,this.channel=e,e.eventEmitter.on("ecs_bootstrap",this.onEcsBootstrap,this),e.eventEmitter.on("entity_spawn",this.onEntitySpawn,this),e.eventEmitter.on("entity_despawn",this.onEntityDespawn,this),e.eventEmitter.on("component_add",this.onComponentAdd,this),e.eventEmitter.on("component_edit",this.onComponentEdit,this),e.eventEmitter.on("component_remove",this.onComponentRemove,this),e.eventEmitter.on("resource_add",this.onResourceAdd,this),e.eventEmitter.on("resource_edit",this.onResourceEdit,this),e.eventEmitter.on("resource_remove",this.onResourceRemove,this)}onEcsBootstrap(t,e){0===e.sender&&this.ecs.deserialize(t.payload)}onEntitySpawn(t,e){0===e.sender&&this.ecs.spawnEntityManual(t.entityId,t.components)}onEntityDespawn(t,e){0===e.sender&&this.ecs.despawnEntity(t.entityId)}onComponentAdd(t,e){0===e.sender&&this.ecs.addComponent(t.entityId,t.payload)}onComponentEdit(t,e){0===e.sender&&this.ecs.editComponent(t.entityId,t.compType,t.changes,t.multiId)}onComponentRemove(t,e){if(0!==e.sender)return;let i=this.ecs.getComponent(t.entityId,t.compType,t.multiId);void 0!==i&&this.ecs.removeComponent(i)}onResourceAdd(t,e){0===e.sender&&this.ecs.addResource(t.payload)}onResourceEdit(t,e){0===e.sender&&this.ecs.editResource(t.resType,t.changes)}onResourceRemove(t,e){0===e.sender&&this.ecs.removeResource(t.resType)}destroy(){}}function o(t){let e={};for(let i in t)"_"!==i[0]&&"entity"!==i&&"clientVisible"!==i&&(e[i]=t[i]);return e}function a(t){let e={};for(let i in t)"_"!==i[0]&&(e[i]=t[i]);return e}},function(t,e,i){"use strict";i.d(e,"a",(function(){return ye})),i.d(e,"b",(function(){return ce}));var n=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"game"},[i("b-button-toolbar",{staticClass:"bg-dark",staticStyle:{width:"100%",height:"var(--topbar-height)","z-index":"1000"},attrs:{type:"dark",variant:"info",justify:""}},[t.isAdmin?i("b-button-group",{staticStyle:{"margin-right":"2rem"}},[i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Undo",squared:""}},[i("i",{staticClass:"fas fa-undo"})]),t._v(" "),i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Redo",squared:"",disabled:""}},[i("i",{staticClass:"fas fa-redo"})])],1):t._e(),t._v(" "),i("b-button-group",[i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Inspect",squared:""},on:{click:function(e){return t.changeTool("inspect")}}},[i("i",{staticClass:"fas fa-hand-pointer"})]),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Move",squared:""},on:{click:function(e){return t.changeTool("move")}}},[i("i",{staticClass:"fas fa-arrows-alt"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Add wall",squared:""},on:{click:function(e){return t.changeTool("create_wall")}}},[i("svg",{staticClass:"svg-inline--fa fa-w-16",attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 234.809 234.809","xml:space":"preserve"}},[i("path",{attrs:{fill:"currentColor",d:"M7.5,53.988c-4.135,0-7.5-3.364-7.5-7.5V20.571c0-4.136,3.365-7.5,7.5-7.5h94.904c4.135,0,7.5,3.364,7.5,7.5v25.917\n                  c0,4.136-3.365,7.5-7.5,7.5H7.5z M227.309,53.988c4.135,0,7.5-3.364,7.5-7.5V20.571c0-4.136-3.365-7.5-7.5-7.5h-94.904\n                  c-4.135,0-7.5,3.364-7.5,7.5v25.917c0,4.136,3.365,7.5,7.5,7.5H227.309z M164.856,109.904c4.135,0,7.5-3.365,7.5-7.5V76.488\n                  c0-4.136-3.365-7.5-7.5-7.5H69.952c-4.135,0-7.5,3.364-7.5,7.5v25.917c0,4.135,3.365,7.5,7.5,7.5H164.856z M39.952,109.904\n                  c4.136,0,7.5-3.364,7.5-7.5V76.488c0-4.136-3.364-7.5-7.5-7.5H8.048c-4.136,0-7.5,3.364-7.5,7.5v25.917c0,4.136,3.364,7.5,7.5,7.5\n                  H39.952z M226.761,109.904c4.136,0,7.5-3.364,7.5-7.5V76.488c0-4.136-3.364-7.5-7.5-7.5h-31.904c-4.136,0-7.5,3.364-7.5,7.5v25.917\n                  c0,4.136,3.364,7.5,7.5,7.5H226.761z M102.404,165.821c4.135,0,7.5-3.364,7.5-7.5v-25.917c0-4.135-3.365-7.5-7.5-7.5H7.5\n                  c-4.135,0-7.5,3.365-7.5,7.5v25.917c0,4.136,3.365,7.5,7.5,7.5H102.404z M227.309,165.821c4.135,0,7.5-3.364,7.5-7.5v-25.917\n                  c0-4.135-3.365-7.5-7.5-7.5h-94.904c-4.135,0-7.5,3.365-7.5,7.5v25.917c0,4.136,3.365,7.5,7.5,7.5H227.309z M164.856,221.738\n                  c4.135,0,7.5-3.364,7.5-7.5v-25.917c0-4.136-3.365-7.5-7.5-7.5H69.952c-4.135,0-7.5,3.364-7.5,7.5v25.917c0,4.136,3.365,7.5,7.5,7.5\n                  H164.856z M39.952,221.738c4.136,0,7.5-3.364,7.5-7.5v-25.917c0-4.136-3.364-7.5-7.5-7.5H8.048c-4.136,0-7.5,3.364-7.5,7.5v25.917\n                  c0,4.136,3.364,7.5,7.5,7.5H39.952z M226.761,221.738c4.136,0,7.5-3.364,7.5-7.5v-25.917c0-4.136-3.364-7.5-7.5-7.5h-31.904\n                  c-4.136,0-7.5,3.364-7.5,7.5v25.917c0,4.136,3.364,7.5,7.5,7.5H226.761z"}})])]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Add object",squared:""},on:{click:function(e){return t.changeTool("create_prop")}}},[i("i",{staticClass:"fas fa-plus"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Add pin",squared:""},on:{click:function(e){return t.changeTool("create_pin")}}},[i("i",{staticClass:"fas fa-thumbtack"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Edit grid",squared:""},on:{click:function(e){return t.changeTool("grid")}}},[i("i",{staticClass:"fas fa-border-all"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Light settings",squared:""},on:{click:function(e){return t.changeTool("light")}}},[i("i",{staticClass:"fas fa-lightbulb"})]):t._e()],1),t._v(" "),t.isAdmin?i("b-button",{staticClass:"btn-xs",attrs:{title:"Export map",squared:"",variant:"success"},on:{click:function(e){return t.phase.exportMap()}}},[i("i",{staticClass:"fas fa-download"})]):t._e(),t._v(" "),i("div",{staticStyle:{flex:"1 1 0"}}),t._v(" "),i("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.sidebar-right",modifiers:{"sidebar-right":!0}}],staticClass:"btn-xs",attrs:{title:"Toggle sidebar",variant:"warning"}},[i("i",{staticClass:"fas fa-angle-double-right"})])],1),t._v(" "),i("div",{staticStyle:{width:"100%",height:"calc(100vh - var(--topbar-height))"},attrs:{id:"canvas-container"}}),t._v(" "),i("b-sidebar",{attrs:{id:"sidebar-right",title:"Sidebar","bg-variant":"dark","text-variant":"light",right:"",visible:"","no-header":"",shadow:"","sidebar-class":"under-navbar"},scopedSlots:t._u([{key:"footer",fn:function(){return[i("div",{staticClass:"sidebar-footer"},[t._v("\n                "+t._s(t.connectionCount)+"\n                "),i("div",{class:{rotate:t.connectionBuffering},staticStyle:{"margin-left":"0.2rem"}},[i("i",{staticClass:"fas fa-sync-alt"})])])]},proxy:!0}])},[i("div",{directives:[{name:"show",rawName:"v-show",value:"grid"===t.tool,expression:"tool === 'grid'"}],staticClass:"px-3 py-2"},[t._v("\n            Type:\n            "),i("b-radio-group",{attrs:{id:"grid-type-radio",buttons:""},model:{value:t.grid.type,callback:function(e){t.$set(t.grid,"type",e)},expression:"grid.type"}},[i("b-radio",{attrs:{value:"none"}},[i("i",{staticClass:"fas fa-border-none"})]),t._v(" "),i("b-radio",{attrs:{value:"square"}},[i("i",{staticClass:"far fa-square"})]),t._v(" "),i("b-radio",{attrs:{value:"hex"}},[i("svg",{staticClass:"svg-inline--fa fa-hexagon fa-w-18",attrs:{role:"img",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 576 512"}},[i("path",{attrs:{fill:"currentColor",d:"M441.5 39.8C432.9 25.1 417.1 16 400 16H176c-17.1 0-32.9 9.1-41.5 23.8l-112 192c-8.7 14.9-8.7 33.4 0 48.4l112 192c8.6 14.7 24.4 23.8 41.5 23.8h224c17.1 0 32.9-9.1 41.5-23.8l112-192c8.7-14.9 8.7-33.4 0-48.4l-112-192zM400 448H176L64 256 176 64h224l112 192-112 192z"}})])])],1),t._v(" "),"none"!==t.grid.type?i("div",[i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Size:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"10",max:"512",size:"sm"},model:{value:t.grid.size,callback:function(e){t.$set(t.grid,"size",e)},expression:"grid.size"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"10",max:"512"},model:{value:t.grid.size,callback:function(e){t.$set(t.grid,"size",e)},expression:"grid.size"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",[t._v("Xoffset:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"0",max:"1",step:"0.001",size:"sm"},model:{value:t.grid.offX,callback:function(e){t.$set(t.grid,"offX",e)},expression:"grid.offX"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"0",max:"1",step:"0.001"},model:{value:t.grid.offX,callback:function(e){t.$set(t.grid,"offX",e)},expression:"grid.offX"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Yoffset:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"0",max:"1",step:"0.001",size:"sm"},model:{value:t.grid.offY,callback:function(e){t.$set(t.grid,"offY",e)},expression:"grid.offY"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"0",max:"1",step:"0.001"},model:{value:t.grid.offY,callback:function(e){t.$set(t.grid,"offY",e)},expression:"grid.offY"}}),t._v("\n\n                Color: "+t._s(t.grid.color)+"\n                "),i("b-input",{attrs:{type:"color"},model:{value:t.grid.color,callback:function(e){t.$set(t.grid,"color",e)},expression:"grid.color"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Opacity:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"0",max:"1",step:"0.001",size:"sm"},model:{value:t.grid.opacity,callback:function(e){t.$set(t.grid,"opacity",e)},expression:"grid.opacity"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"0",max:"1",step:"0.001"},model:{value:t.grid.opacity,callback:function(e){t.$set(t.grid,"opacity",e)},expression:"grid.opacity"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Thickness:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"1",max:"200",size:"sm"},model:{value:t.grid.thick,callback:function(e){t.$set(t.grid,"thick",e)},expression:"grid.thick"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"1",max:"200"},model:{value:t.grid.thick,callback:function(e){t.$set(t.grid,"thick",e)},expression:"grid.thick"}})],1):t._e()],1),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:"inspect"===t.tool,expression:"tool === 'inspect'"}]},[i("entity-inspect",{attrs:{components:this.selectedComponents,entity:this.selectedEntityOpts,isAdmin:t.isAdmin,selectedAddable:t.selectedAddable},on:{"ecs-property-change":t.onEcsPropertyChange}})],1),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:"light"===t.tool,expression:"tool === 'light'"}],staticClass:"px-3 py-2"},[i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Light:")]),t._v(" "),i("b-input",{attrs:{type:"color",readonly:!t.isAdmin},on:{change:t.onAmbientLightChange},model:{value:t.light.ambientLight,callback:function(e){t.$set(t.light,"ambientLight",e)},expression:"light.ambientLight"}})],1),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Needs light:")]),t._v(" "),i("b-form-checkbox",{attrs:{readonly:!t.isAdmin},on:{input:t.onAmbientLightChange},model:{value:t.light.needsLight,callback:function(e){t.$set(t.light,"needsLight",e)},expression:"light.needsLight"}})],1),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Vision type:")]),t._v(" "),i("b-button",{attrs:{pressed:t.light.roleplayVision,readonly:!t.isAdmin},on:{"update:pressed":function(e){return t.$set(t.light,"roleplayVision",e)}}},[t._v("\n                    "+t._s(t.light.roleplayVision?"Roleplayer":"Master")+"\n                ")])],1),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Background:")]),t._v(" "),i("b-input",{attrs:{type:"color",readonly:!t.isAdmin},on:{change:t.onAmbientLightChange},model:{value:t.light.background,callback:function(e){t.$set(t.light,"background",e)},expression:"light.background"}})],1),t._v(" "),i("div",[i("b-button",{on:{click:t.onLightSettingsReset}},[t._v("Reset")])],1)])]),t._v(" "),i("a",{staticStyle:{display:"none"},attrs:{id:"hidden-download-link"}})],1)};n._withStripped=!0;var s,o=i(13);!function(t){t[t.SQUARE=0]="SQUARE",t[t.HEXAGON=1]="HEXAGON"}(s||(s={}));const a={visible:!0,gridType:s.SQUARE,color:0,thick:10,opacity:.75,size:128,offX:0,offY:0};var r=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{directives:[{name:"show",rawName:"v-show",value:t.components.length>0,expression:"components.length > 0"}]},[i("div",{staticClass:"component-btn-header"},[t.isAdmin?i("b-dropdown",{attrs:{"toggle-class":"rounded-0",variant:"success"},scopedSlots:t._u([{key:"button-content",fn:function(){return[i("i",{staticClass:"fas fa-plus"})]},proxy:!0}],null,!1,1774554641)},[t._v(" "),t._l(t.selectedAddable,(function(e){return i("b-dropdown-item",{key:e.type,on:{click:function(i){return t.emitSpecial("addComponent",e.type)}}},[t._v(t._s(e.name))])}))],2):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticStyle:{display:"grid"},attrs:{squared:"",title:t.entity.hidden?"Show entity":"Hide entity"},on:{click:function(e){return t.emitSpecial("hidden",!t.entity.hidden)}}},[i("div",{staticClass:"g11",style:{visibility:t.entity.hidden?"visible":"hidden"}},[i("i",{staticClass:"fas fa-eye-slash"})]),t._v(" "),i("div",{staticClass:"g11",style:{visibility:t.entity.hidden?"hidden":"visible"}},[i("i",{staticClass:"fas fa-eye"})])]):t._e(),t._v(" "),t.isAdmin?i("b-button",{attrs:{variant:"danger",title:"Delete entity",squared:""},on:{click:function(e){return t.emitSpecial("delete")}}},[i("i",{staticClass:"fas fa-trash"})]):t._e()],1),t._v(" "),t._l(t.renderedComponents,(function(e){return i("ecs-component-wrapper",{key:e.type+(e.multiId||""),attrs:{component:e,isAdmin:t.isAdmin,allComps:t.allComponents},on:{"ecs-property-change":function(e){return t.$emit("ecs-property-change",arguments[0],arguments[1],arguments[2],arguments[3])}}})}))],2)};r._withStripped=!0;var l=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",[i("div",{staticClass:"component-header"},[i("div",{staticStyle:{width:"100%"},on:{click:function(e){t.visible=!t.visible}}},[t._v(" "+t._s(t.component.type)+" ")]),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:void 0!==t.component.clientVisible,expression:"component.clientVisible !== undefined"}],staticStyle:{display:"grid"},attrs:{squared:"",size:"sm",title:t.component.clientVisible?"Hide component":"Show component"},on:{click:function(e){return t.$emit("ecs-property-change",t.component.type,"clientVisible",!t.component.clientVisible)}}},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.component.clientVisible,expression:"component.clientVisible"}],staticClass:"g11"},[i("i",{staticClass:"fas fa-eye"})]),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:!t.component.clientVisible,expression:"!component.clientVisible"}],staticClass:"g11"},[i("i",{staticClass:"fas fa-eye-slash"})])]):t._e(),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:void 0!==t.component._isFullscreen,expression:"component._isFullscreen !== undefined"}],attrs:{squared:"",size:"sm",variant:"primary",title:"Fullscreen"},on:{click:function(e){t.component._isFullscreen=!0}}},[i("i",{staticClass:"fas fa-expand"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:t.component._canDelete,expression:"component._canDelete"}],attrs:{squared:"",size:"sm",variant:"danger",title:"Delete"},on:{click:function(e){return t.$emit("ecs-property-change","$","removeComponent",t.component.type,t.component.multiId)}}},[i("i",{staticClass:"fas fa-trash"})]):t._e()],1)]),t._v(" "),i("b-collapse",{staticClass:"component-body",attrs:{visible:""},model:{value:t.visible,callback:function(e){t.visible=e},expression:"visible"}},[i(t.componentType,{tag:"component",attrs:{component:t.component,isAdmin:t.isAdmin,allComps:t.allComps},on:{"ecs-property-change":function(e){return t.$emit("ecs-property-change",arguments[0],arguments[1],arguments[2],arguments[3])}}})],1)],1)};l._withStripped=!0;var h=function(){var t=this,e=t.$createElement;return(t._self._c||e)("b-input",{attrs:{readonly:!t.isAdmin,placeholder:"Entity name"},on:{change:t.onChange},model:{value:t.component.name,callback:function(e){t.$set(t.component,"name",e)},expression:"component.name"}})};h._withStripped=!0;var c={name:"ecs-name",props:["component","isAdmin"],data:function(){return{name:this.component.name}},watch:{"component.name":function(t){this.name=t}},methods:{onChange:function(){this.$emit("ecs-property-change","name","name",this.name,this.component.multiId)}}},d=i(6),p=Object(d.a)(c,h,[],!1,null,"3e768912",null);p.options.__file="src/app/ui/ecs/ecsName.vue";var u=p.exports,m=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("b-textarea",{attrs:{placeholder:"Write something here...",readonly:!t.isAdmin},on:{change:t.onChange},model:{value:t.note,callback:function(e){t.note=e},expression:"note"}}),t._v(" "),i("b-modal",{attrs:{title:"Note","dialog-class":"modal-fullscreen modal-xxl","hide-footer":"","hide-header":""},scopedSlots:t._u([{key:"modal-footer",fn:function(){},proxy:!0}]),model:{value:t.component._isFullscreen,callback:function(e){t.$set(t.component,"_isFullscreen",e)},expression:"component._isFullscreen"}},[i("b-textarea",{staticStyle:{height:"100%",resize:"none"},attrs:{placeholder:"Write something here...",readonly:!t.isAdmin},on:{change:t.onChange},model:{value:t.note,callback:function(e){t.note=e},expression:"note"}})],1)],1)};m._withStripped=!0;var y={name:"ecs-note",props:["component","isAdmin"],data:function(){return{note:this.component.note,console:console}},watch:{"component.note":function(t){this.note=t}},methods:{onChange:function(){this.$emit("ecs-property-change","note","note",this.note,this.component.multiId)}}},g=Object(d.a)(y,m,[],!1,null,"2effb2f9",null);g.options.__file="src/app/ui/ecs/ecsNote.vue";var f=g.exports,v=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        X: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(t._s(t.x))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"0.001",size:"sm"},on:{change:t.onChange},model:{value:t.x,callback:function(e){t.x=e},expression:"x"}}):t._e()],1),t._v(" "),i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        Y: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(" "+t._s(t.y))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"0.001",size:"sm"},on:{change:t.onChange},model:{value:t.y,callback:function(e){t.y=e},expression:"y"}}):t._e()],1)])};v._withStripped=!0;var b={name:"ecs-position",props:["component","isAdmin"],data:function(){return{x:this.component.x,y:this.component.y}},methods:{onChange:function(){this.component.x!==this.x&&""!==this.x&&this.$emit("ecs-property-change","position","x",parseFloat(this.x)),this.component.y!==this.y&&""!==this.y&&this.$emit("ecs-property-change","position","y",parseFloat(this.y))}},watch:{"component.x":function(t){this.x=t},"component.y":function(t){this.y=t}}},_=Object(d.a)(b,v,[],!1,null,"e81e4da0",null);_.options.__file="src/app/ui/ecs/ecsPosition.vue";var C=_.exports,w=function(){var t=this.$createElement;return(this._self._c||t)("div")};w._withStripped=!0;var x={name:"ecs-wall",props:["component"]},E=Object(d.a)(x,w,[],!1,null,"37e22e5e",null);E.options.__file="src/app/ui/ecs/ecsWall.vue";var S=E.exports,T=function(){var t=this.$createElement;return(this._self._c||t)("span",[this._v("Your regular background image")])};T._withStripped=!0;var P={name:"ecs-background-image",props:["component"]},A=Object(d.a)(P,T,[],!1,null,"5efd7016",null);A.options.__file="src/app/ui/ecs/ecsBackgroundImage.vue";var I=A.exports,O=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("b-input",{attrs:{type:"color",readonly:!t.isAdmin},on:{change:t.onChange},model:{value:t.color,callback:function(e){t.color=e},expression:"color"}}),t._v(" "),i("b-input",{attrs:{readonly:!t.isAdmin,placeholder:"Label"},on:{change:t.onChange},model:{value:t.label,callback:function(e){t.label=e},expression:"label"}})],1)};O._withStripped=!0;var L=i(0),M=L.a.utils.hex2string,k=L.a.utils.string2hex,N={name:"ecs-pin",props:["component","isAdmin"],data:function(){return{color:M(this.component.color),label:this.component.label}},methods:{onChange:function(){if(this.component.color!==this.color&&""!==this.color){let t=k(this.color);this.$emit("ecs-property-change","pin","color",t)}this.label!==this.component.label&&this.$emit("ecs-property-change","pin","label",this.label)}},watch:{"component.color":function(t){this.color=M(t)},"component.label":function(t){this.label=t}}},R=Object(d.a)(N,O,[],!1,null,"26d88e5e",null);R.options.__file="src/app/ui/ecs/ecsPin.vue";var Y=R.exports,X=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        Angle: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(t._s(t.rotation))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"0.001",size:"sm"},on:{change:t.onChange},model:{value:t.rotation,callback:function(e){t.rotation=e},expression:"rotation"}}):t._e()],1),t._v(" "),i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        Scale: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(t._s(t.scale))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"0.001",size:"sm"},on:{change:t.onChange},model:{value:t.scale,callback:function(e){t.scale=e},expression:"scale"}}):t._e()],1)])};X._withStripped=!0;var V=i(10),D={name:"ecs-position",props:["component","isAdmin"],data:function(){return{rotation:this.component.rotation*V.RAD_TO_DEG,scale:this.component.scale}},methods:{onChange:function(){if(""!==this.rotation){let t=Math.min(Math.max(parseFloat(this.rotation),0),360);this.component.rotation!==t&&this.$emit("ecs-property-change","transform","rotation",t*V.DEG_TO_RAD)}if(""!==this.scale){let t=parseFloat(this.scale);this.component.scale!==t&&this.$emit("ecs-property-change","transform","scale",t)}}},watch:{"component.rotation":function(t){this.rotation=t*V.RAD_TO_DEG},"component.scale":function(t){this.scale=t}}},B=Object(d.a)(D,X,[],!1,null,"4ee87bf5",null);B.options.__file="src/app/ui/ecs/ecsTransform.vue";var z=B.exports,j=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",[t._v("\n        Color:\n        "),i("b-input",{attrs:{type:"color",readonly:!t.isAdmin},on:{change:t.onChange},model:{value:t.color,callback:function(e){t.color=e},expression:"color"}})],1),t._v(" "),i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        Visibility Range: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(t._s(t.range))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"1",min:"0",size:"sm"},on:{change:t.onChange},model:{value:t.range,callback:function(e){t.range=e},expression:"range"}}):t._e()],1)])};j._withStripped=!0;var F=L.a.utils.hex2string,U=L.a.utils.string2hex,G={name:"ecs-light",props:["component","isAdmin"],data:function(){return{color:F(this.component.color),range:this.component.range}},methods:{onChange:function(){if(this.component.color!==this.color&&""!==this.color){let t=U(this.color);this.$emit("ecs-property-change","light","color",t)}if(this.component.range!==this.range&&""!==this.range){let t=parseInt(this.range);this.$emit("ecs-property-change","light","range",t)}}},watch:{"component.color":function(t){this.color=F(t)},"component.range":function(t){this.range=t}}},W=Object(d.a)(G,j,[],!1,null,"724e011f",null);W.options.__file="src/app/ui/ecs/ecsLight.vue";var H=W.exports,$=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        Night vision:\n        "),i("b-form-checkbox",{attrs:{readonly:!t.isAdmin},on:{input:t.onChange},model:{value:t.nightVision,callback:function(e){t.nightVision=e},expression:"nightVision"}})],1),t._v(" "),i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        Visibility Range: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(t._s(t.range))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"1",min:"0",size:"sm"},on:{change:t.onChange},model:{value:t.range,callback:function(e){t.range=e},expression:"range"}}):t._e()],1)])};$._withStripped=!0;var q={name:"ecs-player",props:["component","isAdmin"],data:function(){return{nightVision:this.component.nightVision,range:this.component.range}},methods:{onChange:function(){if(this.component.nightVision!==this.nightVision&&this.$emit("ecs-property-change","player","nightVision",this.nightVision),this.component.range!==this.range&&""!==this.range){let t=parseInt(this.range);this.$emit("ecs-property-change","player","range",t)}}},watch:{"component.nightVision":function(t){this.nightVision=t},"component.range":function(t){this.range=t}}},Q=Object(d.a)(q,$,[],!1,null,"636ceea8",null);Q.options.__file="src/app/ui/ecs/ecsPlayer.vue";var K=Q.exports,J=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",[t._v("\n    Type:\n    "),t.isAdmin?t._e():i("span",[t._v("\n      "+t._s(this.doorTypeName)+"\n    ")]),t._v(" "),t.isAdmin?i("b-form-select",{staticClass:"mb-3",model:{value:t.doorType,callback:function(e){t.doorType=e},expression:"doorType"}},[i("b-form-select-option",{attrs:{value:"normall"}},[t._v("Normal")]),t._v(" "),i("b-form-select-option",{attrs:{value:"normalr"}},[t._v("Normal right")]),t._v(" "),i("b-form-select-option",{attrs:{value:"rotate"}},[t._v("Rotating")])],1):t._e()],1),t._v(" "),i("div",{staticStyle:{display:"flex","align-items":"center"}},[t.isAdmin?t._e():i("span",[t._v(t._s(t.open?"Open":"Closed"))]),t._v(" "),t.isAdmin?t._e():i("span",{directives:[{name:"show",rawName:"v-show",value:this.locked,expression:"this.locked"}],staticStyle:{"margin-left":"0.5rem"}},[i("i",{staticClass:"fas fa-lock"})]),t._v(" "),t.isAdmin?i("b-button",{attrs:{pressed:t.open},on:{"update:pressed":function(e){t.open=e}}},[t._v(t._s(t.open?"Open":"Closed"))]):t._e(),t._v(" "),t.isAdmin?i("b-button",{attrs:{pressed:t.locked},on:{"update:pressed":function(e){t.locked=e}}},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.locked,expression:"locked"}]},[i("i",{staticClass:"fas fa-lock"})]),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:!t.locked,expression:"!locked"}]},[i("i",{staticClass:"fas fa-lock-open"})])]):t._e()],1)])};J._withStripped=!0;var Z,tt=i(7),et=i(4),it=i(11),nt=i(3),st=i(9),ot=i(2);!function(t){t.NORMAL_LEFT="normall",t.NORMAL_RIGHT="normalr",t.ROTATE="rotate"}(Z||(Z={}));class at{constructor(t,e){this.storage=new tt.c("door",!0,!0),this.ecs=t,this.phase=e,this.ecs.addStorage(this.storage),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edited",this.onComponentEdited,this),this.ecs.events.on("component_remove",this.onComponentRemove,this)}redrawComponent(t){let e=this.ecs.getComponent(t.entity,"wall"),i=this.ecs.getComponent(t.entity,"position");if(!(e.visible||"dm"===this.phase.lightSystem.localLightSettings.visionType))return void t._display.clear();let n=new it.a(i.x,i.y,i.x+e.vec[0],i.y+e.vec[1]);this.drawLines(t,n)}drawLines(t,e){let i=t._display;if(void 0!==i)switch(i.clear(),i.lineStyle(2,0,.5),t.doorType){case Z.NORMAL_LEFT:{let n=e.distance(),s=Math.atan2(e.toY-e.fromY,e.toX-e.fromX);t.open&&(s-=Math.PI/2),i.arc(e.fromX,e.fromY,n,s,s+Math.PI/2);break}case Z.NORMAL_RIGHT:{let n=e.distance(),s=Math.atan2(e.fromY-e.toY,e.fromX-e.toX);t.open||(s-=Math.PI/2),i.arc(e.toX,e.toY,n,s,s+Math.PI/2);break}case Z.ROTATE:{let t=e.distance()/2,n=(e.fromX+e.toX)/2,s=(e.fromY+e.toY)/2;i.drawCircle(n,s,t);break}default:console.warn("Unknown door type: "+t.doorType)}}openDoor(t,e,i){if(!this.ecs.isMaster)return;let n=this.ecs.getComponent(t.entity,"wall"),s=this.ecs.getComponent(t.entity,"position"),o=void 0,a=void 0;switch(e){case Z.NORMAL_LEFT:a=Object(nt.u)({x:0,y:0},Math.PI/2*(i?-1:1),{x:n.vec[0],y:n.vec[1]});break;case Z.NORMAL_RIGHT:{let t=Math.PI/2*(i?1:-1);o=Object(nt.u)({x:s.x+n.vec[0],y:s.y+n.vec[1]},t,{x:s.x,y:s.y}),a=Object(nt.u)({x:0,y:0},t,{x:n.vec[0],y:n.vec[1]});break}case Z.ROTATE:{let t=n.vec[0]/2,e=n.vec[1]/2,r={x:s.x+t,y:s.y+e},l=Math.PI/2*(i?1:-1);o=Object(nt.u)(r,l,{x:s.x,y:s.y}),a=Object(nt.u)(r,l,{x:s.x+n.vec[0],y:s.y+n.vec[1]}),a.x-=o.x,a.y-=o.y;break}default:console.warn("Unknown door type: "+e)}void 0!==o&&this.ecs.editComponent(t.entity,"position",{x:o.x,y:o.y}),void 0!==a&&this.ecs.editComponent(t.entity,"wall",{vec:[a.x,a.y]})}onComponentAdd(t){if("door"===t.type){let e=t;e._display=new L.a.Graphics,this.displayContainer.addChild(e._display),e.open&&this.openDoor(e,e.doorType,!0),this.redrawComponent(e),this.ecs.getComponent(t.entity,"wall")._dontMerge++}}onComponentEdited(t,e){if("door"===t.type){let i=t;"open"in e&&this.openDoor(i,i.doorType,i.open),"doorType"in e&&i.open&&(this.openDoor(i,e.doorType,!1),this.openDoor(i,i.doorType,!0)),this.redrawComponent(i)}else if("wall"===t.type){let e=this.storage.getComponent(t.entity);void 0!==e&&this.redrawComponent(e)}else if("position"===t.type){let e=this.storage.getComponent(t.entity);void 0!==e&&this.redrawComponent(e)}}onComponentRemove(t){if("door"===t.type){let e=t;e.open&&this.openDoor(e,e.doorType,!1),e._display.destroy(et.b),this.ecs.getComponent(t.entity,"wall")._dontMerge--}}enable(){this.layer=new L.a.display.Layer,this.layer.zIndex=st.a.WALL+1,this.layer.interactive=!1,ot.app.stage.addChild(this.layer),this.displayContainer=new L.a.Container,this.displayContainer.parentLayer=this.layer,this.displayContainer.interactive=!1,this.displayContainer.interactiveChildren=!1,this.phase.board.addChild(this.displayContainer)}destroy(){this.displayContainer.destroy(et.b),this.layer.destroy(et.b)}}var rt={name:"ecs-door",props:["component","isAdmin"],data:function(){return{doorType:this.component.doorType,open:this.component.open,locked:this.component.locked}},methods:{onChange:function(){this.component.doorType!==this.doorType&&this.$emit("ecs-property-change","door","doorType",this.doorType),this.component.open!==this.open&&this.$emit("ecs-property-change","door","open",this.open),this.component.locked!==this.locked&&this.$emit("ecs-property-change","door","locked",this.locked)}},computed:{doorTypeName:function(){switch(this.doorType){case Z.NORMAL_LEFT:return"Normal";case Z.NORMAL_RIGHT:return"Normal right";case Z.ROTATE:return"Rotating";default:return"Unknown??"}}},watch:{"component.doorType":function(t){this.doorType=t},"component.open":function(t){this.open=t},"component.locked":function(t){this.locked=t},doorType:function(t){this.onChange()},open:function(t){this.onChange()},locked:function(t){this.onChange()}}},lt=Object(d.a)(rt,J,[],!1,null,"1862e8b5",null);lt.options.__file="src/app/ui/ecs/ecsDoor.vue";var ht=lt.exports,ct=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n      Target: "),i("span",{on:{click:t.focusTarget}},[t._v(t._s(this.component.targetProp))])]),t._v(" "),i("b-button",{on:{click:t.link}},[t._v("Link")]),t._v(" "),i("b-button",{on:{click:t.use}},[t._v("Use")])],1)};ct._withStripped=!0;var dt=L.a.utils.hex2string,pt=L.a.utils.string2hex,ut={name:"ecs-prop-teleport",props:["component","isAdmin"],data:function(){return{}},methods:{onChange:function(){if(this.component.color!==this.color&&""!==this.color){let t=pt(this.color);this.$emit("ecs-property-change","pin","color",t)}this.label!==this.component.label&&this.$emit("ecs-property-change","pin","label",this.label)},focusTarget:function(){console.warn("TODO: focus target")},link:function(){this.$emit("ecs-property-change","@","prop_teleport_link",this.component.entity)},use:function(){this.$emit("ecs-property-change","@","prop_use",this.component.entity)}},watch:{"component.color":function(t){this.color=dt(t)},"component.label":function(t){this.label=t}}},mt=Object(d.a)(ut,ct,[],!1,null,"08b2d1b5",null);mt.options.__file="src/app/ui/ecs/ecsPropTeleport.vue";var yt={name:"ecs-component-wrapper",props:["component","isAdmin","allComps"],data:function(){return{visible:!0}},computed:{componentType:function(){return"ecs-"+this.component.type.replace("_","-")}},components:{ecsName:u,ecsNote:f,ecsPosition:C,ecsWall:S,ecsBackgroundImage:I,ecsPin:Y,ecsTransform:z,ecsLight:H,ecsPlayer:K,ecsDoor:ht,ecsPropTeleport:mt.exports}},gt=(i(74),Object(d.a)(yt,l,[],!1,null,"03d324d6",null));gt.options.__file="src/app/ui/ecs/compWrapper.vue";var ft={name:"entity-inspect",components:{EcsComponentWrapper:gt.exports},props:["entity","components","isAdmin","selectedAddable"],methods:{emitSpecial:function(t,e){this.$emit("ecs-property-change","$",t,e)}},computed:{renderedComponents:function(){return this.components.filter(t=>t._save)},allComponents:function(){let t={};for(let e of this.components)t[e.type]=e;return t}}},vt=(i(76),Object(d.a)(ft,r,[],!1,null,"c407dbfa",null));vt.options.__file="src/app/ui/ecs/entityInspect.vue";var bt=vt.exports,_t=i(24),Ct=L.a.utils.hex2string,wt=L.a.utils.string2hex,xt=o.default.extend({components:{EntityInspect:bt},data:()=>({tool:"inspect",isAdmin:!1,connectionCount:0,connectionBuffering:!1,disableWatchSave:!1,grid:{type:"none",size:1,offX:0,offY:0,color:"#000000",opacity:.5,thick:2},light:{ambientLight:"#000000",needsLight:!0,roleplayVision:!1,background:"#000000"},selectedComponents:new Array,selectedEntityOpts:{},selectedAddable:new Array,phase:null}),methods:{changeTool(t){this.phase.changeTool(t)},onEcsPropertyChange(t,e,i,n){this.phase.selection.setProperty(t,e,i,n)},onAmbientLightChange(){this.phase.ecs.addResource({type:"light_settings",ambientLight:wt(this.light.ambientLight),needsLight:this.light.needsLight,background:wt(this.light.background)},"update")},onLightSettingsReset(){this.phase.ecs.addResource(Object.assign({type:"light_settings"},_t.b),"update"),this.reloadLight()},reloadLight(){let t=this.phase.ecs.getResource("light_settings");this.light.ambientLight=Ct(t.ambientLight),this.light.needsLight=t.needsLight,this.light.background=Ct(t.background);let e=this.phase.ecs.getResource("local_light_settings");this.light.roleplayVision="rp"===e.visionType},reloadGrid(){this.disableWatchSave=!0;let t=this.phase.ecs.getResource("grid");switch(t.gridType){case s.HEXAGON:this.grid.type="hex";break;case s.SQUARE:this.grid.type="square"}t.visible||(this.grid.type="none");let e=t;this.grid.size=e.size,this.grid.offX=e.offX,this.grid.offY=e.offY,this.grid.color=Ct(e.color),this.grid.opacity=e.opacity,this.grid.thick=e.thick,this.disableWatchSave=!1},onResourceEdited(t){"grid"===t.type?this.reloadGrid():"light_settings"!==t.type&&"local_light_settings"!==t.type||this.reloadLight()}},watch:{grid:{handler:function(t){if(this.disableWatchSave)return;let e;switch(t.offX=Math.min(t.offX,t.size),t.offY=Math.min(t.offY,t.size),t.type){case"none":e=void 0;break;case"hex":e=s.HEXAGON;break;case"square":e=s.SQUARE}void 0!==e?this.phase.ecs.editResource("grid",{visible:!0,gridType:e,size:t.size,offX:t.offX,offY:t.offY,color:wt(t.color),opacity:parseFloat(t.opacity),thick:t.thick}):this.phase.ecs.editResource("grid",{visible:!1})},deep:!0},"light.roleplayVision":function(){let t=this.light.roleplayVision?"rp":"dm";this.phase.ecs.editResource("local_light_settings",{visionType:t})}},mounted(){this.reloadGrid(),this.reloadLight(),this.phase.ecs.events.on("resource_edited",this.onResourceEdited),this.eventEmitter.on("changeTool",t=>{this.tool=t})}}),Et=(i(78),Object(d.a)(xt,n,[],!1,null,"53b46051",null));Et.options.__file="src/app/ui/edit/editMap.vue";var St=Et.exports,Tt=i(20),Pt=L.a.utils.EventEmitter;class At{constructor(t){this.storages=new Map,this.storageList=new Array,this.entities=new Set,this.resources=new Map,this.isDeserializing=!1,this.events=new Pt,this.isMaster=t}spawnEntity(...t){let e=-1;do{e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}while(this.entities.has(e));return this.spawnEntityManual(e,t),e}spawnEntityManual(t,e){this.entities.add(t),this.events.emit("entity_spawn",t);for(let i of e)this.addComponent(t,i);this.events.emit("entity_spawned",t)}despawnEntity(t){this.events.emit("entity_despawn",t);for(let e=this.storageList.length-1;e>=0;--e){let i=this.storageList[e],n=[...i.getComponents(t)];if(0!==n.length){for(let t of n)this.events.emit("component_remove",t);i.unregisterAllOf(t);for(let t of n)this.events.emit("component_removed",t)}}this.entities.delete(t),this.events.emit("entity_despawned",t)}hasAllComponents(t,...e){for(let i of e)if(void 0===this.getComponent(t,i))return!1;return!0}addComponent(t,e){e.entity=t;let i=this.storages.get(e.type);if(void 0===i)throw"Cannot register component of type "+e.type+", no storage found";i.register(e),this.events.emit("component_add",e)}removeComponent(t){this.events.emit("component_remove",t),this.storages.get(t.type).unregister(t),this.events.emit("component_removed",t)}addStorage(t){this.storages.set(t.type,t),this.storageList.push(t)}getComponent(t,e,i){return this.storages.get(e).getFirstComponent(t,i)}getAllComponents(t){let e=new Array;for(let i of this.storages.values())e.push(...i.getComponents(t));return e}editComponent(t,e,i,n){let s=this.getComponent(t,e,n);if(!Ot(s,i))return;this.events.emit("component_edit",s,i);let o=It(s,i);this.events.emit("component_edited",s,o)}addResource(t,e="fail"){if(this.resources.has(t.type))switch(e){case"ignore":break;case"update":this.editResource(t.type,t);break;default:throw"Resource type already present"}else{if(this.events.emit("resource_add",t),this.resources.has(t.type))throw'"resource_add" event has added a resource of the same type!';this.resources.set(t.type,t),this.events.emit("resource_added",t)}}getResource(t){return this.resources.get(t)}editResource(t,e){let i=this.getResource(t);Ot(i,e)&&(this.events.emit("resource_edit",i,e),It(i,e),this.events.emit("resource_edited",i,e))}removeResource(t,e=!0){let i=this.resources.get(t);if(void 0!==i)this.events.emit("resource_remove",i),this.resources.delete(t),this.events.emit("resource_removed",i);else if(e)throw"Resource type not found"}serialize(){this.events.emit("serialize","save");let t={};for(let e of this.storages.values())e.save&&(t[e.type]=e.serialize());let e={};for(let t of this.resources.values()){if(!1===t._save)continue;let i={};for(let e in t)"_"!==e[0]&&"type"!==e&&(i[e]=t[e]);e[t.type]=i}let i={entities:[...this.entities],storages:t,resources:e};return this.events.emit("serialized",i),i}serializeClient(){this.events.emit("serialize","client");let t={},e=this.storages.get("host_hidden");for(let i of this.storages.values())i.save&&i.sync&&(t[i.type]=i.serializeClient(t=>void 0!==e.getFirstComponent(t)));let i={};for(let t of this.resources.values()){if(!1===t._save||!1===t._sync)continue;let e={};for(let i in t)"_"!==i[0]&&"type"!==i&&(e[i]=t[i]);i[t.type]=e}let n={entities:[...this.entities].filter(t=>void 0===e.getFirstComponent(t)),storages:t,resources:i};return this.events.emit("serialized",n),n}deserialize(t){this.clear(),this.isDeserializing=!0,this.events.emit("deserialize",t);for(let e in t.resources){let i=t.resources[e];i.type=e,this.addResource(i,"update")}for(let e of t.entities)this.entities.add(e),this.events.emit("entity_spawn",e);for(let e in t.storages){let i=this.storages.get(e);void 0!==i?i.deserialize(this,t.storages[e]):console.error("Cannot deserialize storage type: "+e+", ignoring")}for(let e of t.entities)this.events.emit("entity_spawned",e);this.isDeserializing=!1,this.events.emit("deserialized")}clear(){this.events.emit("clear");for(let t of[...this.entities])this.despawnEntity(t);for(let t of[...this.entities])this.despawnEntity(t);if(0!==this.entities.size)throw"Entities spawned while clearing!";this.events.emit("cleared")}}function It(t,e){for(let i in e){let n=e[i];e[i]=t[i],t[i]=n}return e}function Ot(t,e){let i=0;for(let n in e)t[n]===e[n]?delete e[n]:i++;return 0!==i}var Lt=i(12);const Mt=Math.sqrt(3);class kt{constructor(t){this.type="grid",this.posX=0,this.posY=0,this.scaleX=1,this.scaleY=1,this.ecs=t,this.sprite=new L.a.TilingSprite(L.a.Texture.EMPTY,ot.app.screen.width,ot.app.screen.height),this.sprite.zIndex=st.a.GRID,t.events.on("resource_edited",this.onResourceEdited,this),t.events.on("resource_remove",this.onResourceRemove,this),ot.app.renderer.on("resize",this.onResize,this),this.gridRes=Object.assign({type:"grid",_save:!0,_sync:!0},a),t.addResource(this.gridRes),this.updateTex(),this.updatePos()}onResourceEdited(t,e){"grid"===t.type&&(this.updateTex(),this.updatePos())}onResourceRemove(t){if("grid"===t.type)throw"Fool! Thou shall not remove thy grid!"}onResize(t,e){this.sprite.width=t,this.sprite.height=e}updateTex(){if(this.sprite.texture.destroy(!0),!this.gridRes.visible)return void(this.sprite.texture=L.a.Texture.WHITE);let t=function(t,e,i){let n;switch(e){case s.HEXAGON:n=function(t,e){let i=t/Mt,n=Math.floor(3*i),s=document.createElement("canvas");s.width=n,s.height=t;let o=s.getContext("2d"),a=t;return o.lineWidth=e.thick,o.strokeStyle=Nt(e.color,e.opacity),o.moveTo(0,0),o.lineTo(i,0),o.lineTo(i+i/2,a/2),o.lineTo(2*i+i/2,a/2),o.lineTo(3*i,0),o.moveTo(0,a),o.lineTo(i,a),o.lineTo(i+i/2,a/2),o.moveTo(2*i+i/2,a/2),o.lineTo(3*i,a),o.moveTo(0,0),o.lineTo(-i/2,a/2),o.lineTo(0,a),o.stroke(),o.getImageData(0,0,n,t)}(t,i);break;case s.SQUARE:n=function(t,e){let i=document.createElement("canvas");i.width=t,i.height=t;let n=i.getContext("2d");return n.lineWidth=e.thick,n.strokeStyle=Nt(e.color,e.opacity),n.strokeRect(0,0,t+1,t+1),n.getImageData(0,0,t,t)}(t,i);break;default:throw"Cannot draw unknown type: "+e}return L.a.BaseTexture.fromBuffer(new Uint8Array(n.data.buffer),n.width,n.height)}(512,this.gridRes.gridType,this.gridRes);this.internalScale=this.gridRes.size/512,this.sprite.texture=new L.a.Texture(t)}updatePos(){this.sprite.tileScale.set(this.scaleX*this.internalScale,this.scaleY*this.internalScale),this.sprite.tilePosition.set(this.posX+this.scaleX*this.gridRes.offX*this.gridRes.size,this.posY+this.scaleY*this.gridRes.offY*this.gridRes.size)}closestPoint(t){if(void 0===this.gridRes)return;let e=new L.a.Point(t[0],t[1]);this.sprite.worldTransform.apply(e,e);let i,n,o=e.x/this.gridRes.size-this.gridRes.offX,a=e.y/this.gridRes.size-this.gridRes.offY;switch(this.gridRes.gridType){case s.SQUARE:{let t=Math.floor(o),e=Math.floor(a);i=t,n=e,o>t+.5&&(i+=1),a>e+.5&&(n+=1),Object(Lt.a)(o,a,t+.5,e+.5)<Object(Lt.a)(o,a,i,n)&&(i=t+.5,n=e+.5)}break;case s.HEXAGON:{const t=1/Mt;let e=2*(o-t/2)/Mt,s=a,r=Math.floor(e),l=Math.floor(s),h=e-r,c=s-l,d=r*Mt/2+t/2;r%2==0?c<.5-h/2?(n=l,i=d+t/2):c>h/2+.5?(n=l+1,i=d+t/2):(n=l+.5,i=d+t):c>1-h/2?(n=l+1,i=d+t):c<h/2?(n=l,i=d+t):(n=l+.5,i=d+t/2)}}return e.set((i+this.gridRes.offX)*this.gridRes.size,(n+this.gridRes.offY)*this.gridRes.size),this.sprite.worldTransform.applyInverse(e,e),[e.x,e.y]}destroy(){this.sprite.destroy(et.b),ot.app.renderer.off("resize",this.onResize,this)}}function Nt(t,e){return"#"+(t<<8|255*e).toString(16).padStart(8,"0")}class Rt extends Tt.a{constructor(t,e){super(t),this.isDraggingBoard=!1,this.pointers=new Map,this.ecs=new At(e),this.board=new L.a.Container,this.board.interactive=!1,this.board.interactiveChildren=!1,this.board.position.set(0,0)}setupEcs(){var t;(t=this.ecs).addStorage(new tt.c("position")),t.addStorage(new tt.c("transform")),t.addStorage(new tt.b("name")),t.addStorage(new tt.b("note")),this.gridSystem=new kt(this.ecs)}zoom(t,e,i){if(this.board.scale.x<.05&&t<1||this.board.scale.x>3&&t>1)return;let n=this.board.position.x-e,s=this.board.position.y-i;n*=t,s*=t;const o=new L.a.Point(n+e,s+i),a=new L.a.Point(this.board.scale.x*t,this.board.scale.y*t);this.board.position.copyFrom(o),this.board.scale.copyFrom(a),this.gridSystem.posX=o.x,this.gridSystem.posY=o.y,this.gridSystem.scaleX=a.x,this.gridSystem.scaleY=a.y,this.gridSystem.updatePos()}onMouseWheel(t){const e=1-.1*Math.sign(t.deltaY);this.zoom(e,t.clientX,t.clientY)}onPointerDown(t){if("mouse"===t.data.pointerType&&2===t.data.button)return void this.onPointerRightDown(t);let e=t.data.global;this.pointers.set(t.data.pointerId,{firstX:e.x,firstY:e.y,lastX:e.x,lastY:e.y}),1===this.pointers.size&&(this.isDraggingBoard=!0),this.lastMouseDownTime=Date.now()}onPointerUp(t){let e=this.pointers.get(t.data.pointerId);if(void 0!==e&&(this.pointers.delete(t.data.pointerId),void 0!==this.lastMouseDownTime&&0===this.pointers.size)){this.isDraggingBoard=!1;let i=Date.now()-this.lastMouseDownTime,n=Math.abs(t.data.global.x-e.firstX),s=Math.abs(t.data.global.y-e.firstY);Math.sqrt(n*n+s*s)<5&&i<500&&this.onPointerClick(t)}}onPointerUpOutside(t){this.onPointerUp(t)}onPointerMove(t){let e=this.pointers.get(t.data.pointerId);if(void 0===e)return;let i=t.data.global;if(1===this.pointers.size&&this.isDraggingBoard){const t=this.board.position.x+(i.x-e.lastX),n=this.board.position.y+(i.y-e.lastY);this.board.position.x=t,this.board.position.y=n,this.gridSystem.posX=t,this.gridSystem.posY=n,this.gridSystem.updatePos()}let n=0;if(2===this.pointers.size){let[t,e]=this.pointers.values(),i=t.lastX-e.lastX,s=t.lastY-e.lastY;n=Math.sqrt(i*i+s*s)}if(e.lastX=i.x,e.lastY=i.y,2===this.pointers.size){let[t,e]=this.pointers.values(),i=t.lastX-e.lastX,s=t.lastY-e.lastY,o=Math.sqrt(i*i+s*s),a=new L.a.Point((t.lastX+e.lastX)/2,(t.lastY+e.lastY)/2);this.zoom(o/n,a.x,a.y)}}onPointerClick(t){}onPointerRightDown(t){}centerBoard(){let t=ot.app.renderer.width/2,e=ot.app.renderer.height/2,i=this.board.getBounds();this.board.position.set(t-i.x-i.width/2,e-i.y-i.height/2)}applyCanvasStyle(t){const e=t.style;e.width="100%",e.height="100%"}enable(){super.enable();const t=ot.app.view;this.applyCanvasStyle(t);let e=document.getElementById("canvas-container");ot.app.resizeTo=e,e.appendChild(t);let i=new L.a.display.Stage;ot.app.stage=i,i.group.enableSort=!0,i.addChild(this.board),i.addChild(this.gridSystem.sprite),ot.app.stage.interactive=!0,ot.app.stage.hitArea={contains:(t,e)=>!0},ot.app.stage.on("pointermove",this.onPointerMove,this),ot.app.stage.on("pointerdown",this.onPointerDown,this),ot.app.stage.on("pointerup",this.onPointerUp,this),ot.app.stage.on("pointerupoutside",this.onPointerUpOutside,this),this.wheelListener=this.onMouseWheel.bind(this),t.addEventListener("wheel",this.wheelListener)}disable(){this.gridSystem.destroy(),ot.app.stage.off("pointermove",this.onPointerMove,this),ot.app.stage.off("pointerdown",this.onPointerDown,this),ot.app.stage.off("pointerup",this.onPointerUp,this),ot.app.stage.off("pointerupoutside",this.onPointerUpOutside,this),ot.app.view.removeEventListener("wheel",this.wheelListener),document.getElementById("canvas-container").removeChild(ot.app.view),ot.app.resizeTo=void 0,super.disable()}}class Yt{constructor(t){if("number"==typeof t)this.data=new Uint32Array(Math.ceil(length/32));else if(4===t.BYTES_PER_ELEMENT)this.data=t;else{let e=Math.floor(t.byteLength/Uint32Array.BYTES_PER_ELEMENT);this.data=new Uint32Array(t.buffer,t.byteOffset,e)}}get size(){return this.data.length<<5}get(t){let e=(t|=0)>>>5;return!(e>=this.data.length)&&!!(this.data[e]>>>t&1)}ensureCapacity(t){let e=this.data.length;for(;e<t;)e*=2;if(e===this.data.length)return;let i=new Uint32Array(e);i.set(this.data),this.data=i}set(t){let e=(t|=0)>>>5;this.ensureCapacity(e),this.data[e]|=1<<t}reset(t){let e=(t|=0)>>>5;this.ensureCapacity(e),this.data[e]&=~(1<<t)}isAll(t,e){let i=0;t&&(i=4294967295);let n=void 0===e?this.data.length:e>>>5;for(let t=0;t<n;t++)if(this.data[t]!==i)return!1;if(void 0===e)return!0;let s=1+(e-1>>5),o=(1<<(31&e))-1,a=this.data[s];return t&&(a=~a),0==(a&o)}}var Xt=i(8),Vt=i(5),Dt=i(21),Bt=function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function r(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,r)}l((n=n.apply(t,e||[])).next())}))};class zt{constructor(t,e){this.renderTexturePool=new V.RenderTexturePool,this.ecs=t,this.phase=e,this.storage=new tt.c("background_image",!0,!0),this.ecs.addStorage(this.storage),this.ecs.events.on("entity_spawned",this.onEntitySpawned,this),this.ecs.events.on("component_edited",this.onComponentEdit,this),this.ecs.events.on("component_remove",this.onComponentRemove,this),this.ecs.events.on("resource_edited",this.onResourceEdited,this),this.ecs.events.on("selection_begin",this.onSelectionBegin,this),this.ecs.events.on("selection_end",this.onSelectionEnd,this),this.ecs.events.on("visibility_spread",this.onVisibilitySpread,this),this.ecs.events.on("serialize",this.onSerialize,this),this.ecs.events.on("serialize_entity",this.onSerializeEntity,this)}onSelectionBegin(t){let e=this.storage.getComponent(t);void 0!==e&&(e._display.tint=7964363)}onSelectionEnd(t){let e=this.storage.getComponent(t);void 0!==e&&(e._display.tint=16777215)}onEntitySpawned(t){return Bt(this,void 0,void 0,(function*(){let e=this.storage.getComponent(t);if(void 0===e)return;let i=this.ecs.getComponent(t,"position");if(void 0===i)return;let n=this.ecs.getComponent(t,"transform");if(void 0===n&&(n={type:"transform",entity:-1,rotation:0,scale:1},this.ecs.addComponent(t,n)),void 0===n.scale&&(n.scale=1),0!==e.image.byteOffset&&(e.image=new Uint8Array(e.image)),void 0!==e.visibilityMap){let t=new Uint8Array(e.visibilityMap);e.visibilityMap=new Uint32Array(t.buffer)}let[s,o]=yield Object(et.e)(e.image,e.imageType);e._texture=s,this.loadVisibility(e);let a="dm"===this.phase.lightSystem.localLightSettings.visionType?e._texture:e._renTex,r=new L.a.Sprite(a);r.anchor.set(.5),r.position.set(i.x,i.y),r.rotation=n.rotation,r.scale.set(n.scale),r.interactive=!1,r.interactiveChildren=!1,r.parentLayer=this.displayLayer,e._display=r,e._html=o,this.displayMaps.addChild(r);let l=e._texture.width/2,h=e._texture.height/2,c=new Xt.a(i.x-l,i.y-h,i.x+l,i.y+h);c.scale(n.scale,n.scale,c);let d=Dt.a.rotateAabb(c.copy(),n.rotation);c.wrapPolygon(d.rotVertex),this.phase.playerSystem.getSpreadDataForAabb(new Xt.a(i.x-s.width/2,i.y-s.height/2,i.x+s.width/2,i.y+s.height/2),t=>this.updateVisibility(t,e)),this.ecs.addComponent(t,{type:"interaction",entity:-1,shape:Object(Vt.g)(d),selectPriority:st.a.BACKGROUND}),console.log("Sprite added")}))}onComponentEdit(t){let e=!1,i=this.storage.getComponent(t.entity);if(void 0!==i){if("position"===t.type){e=!0;let n=t;i._display.position.set(n.x,n.y)}else if("transform"===t.type){e=!0;let n=t;i._display.rotation=n.rotation,i._display.scale.set(n.scale)}if(e){let e=this.ecs.getComponent(t.entity,"interaction").shape.data.rotVertex,n=Xt.a.zero();n.wrapPolygon(e),this.phase.playerSystem.getSpreadDataForAabb(n,t=>this.updateVisibility(t,i))}}}onComponentRemove(t){if("background_image"===t.type){t._display.destroy(et.b)}else if("host_hidden"===t.type){let e=this.storage.getComponent(t.entity);if(void 0===e)return;let i=this.ecs.getComponent(t.entity,"position"),n=e._texture;this.phase.playerSystem.getSpreadDataForAabb(new Xt.a(i.x-n.width/2,i.y-n.height/2,i.x+n.width/2,i.y+n.height/2),t=>this.updateVisibility(t,e))}}onResourceEdited(t,e){if("local_light_settings"===t.type&&"visionType"in e){let e="dm"===t.visionType;for(let t of this.storage.allComponents())t._display.texture=e?t._texture:t._renTex}}onSerialize(){for(let t of this.storage.allComponents())this.extractVisibility(t)}onSerializeEntity(t){let e=this.storage.getComponent(t);void 0!==e&&this.extractVisibility(e)}onVisibilitySpread(t){let e=this.phase.interactionSystem.query(Object(Vt.c)(t.aabb),t=>void 0!==this.storage.getComponent(t.entity));for(let i of e){let e=this.storage.getComponent(i.entity);this.updateVisibility(t,e)}}extractVisibility(t){if(!0!==t._visibilityMapChanged)return;t.visibilityMap=void 0;const e=ot.app.renderer,i=t._renTex;let n=i.frame;e.renderTexture.bind(i);let s=new Uint8Array(i.width*i.height*4);const o=e.gl;o.readPixels(n.x,n.y,n.width,n.height,o.RGBA,o.UNSIGNED_BYTE,s);let a=s.length/4,r=1+(s.length/4-1>>>5),l=new Uint32Array(r);for(let t=0;t<a;t++){0!=(128&s[4*t+3])&&(l[t>>>5]|=1<<(31&t))}t.visibilityMap=l,t._visibilityMapChanged=!1}loadVisibility(t){const e=t._texture.width,i=t._texture.height;if(void 0===t._renTex){t._renTex=L.a.RenderTexture.create({width:e,height:i,scaleMode:t._texture.baseTexture.scaleMode}),t._renTex.baseTexture.clearColor=[0,0,0,0]}if(void 0===t.visibilityMap)return;let n={width:e,height:i,format:L.a.FORMATS.RGBA},s=new Uint32Array(t._texture.width*t._texture.height),o=new Yt(t.visibilityMap),a=s.length;for(let t=0;t<a;t++)s[t]=o.get(t)?4294967295:0;let r=new Uint8Array(s.buffer),l=new L.a.resources.BufferResource(r,{width:e,height:i}),h=new L.a.BaseTexture(l,n),c=new L.a.Texture(h),d=new L.a.Sprite(c);d.blendMode=L.a.BLEND_MODES.SRC_IN;let p=new L.a.Sprite(t._texture),u=new L.a.Container;u.addChild(p,d),ot.app.renderer.render(u,t._renTex,!0),d.destroy(et.b),t._visibilityMapChanged=!1}updateVisibility(t,e){if(this.ecs.getComponent(e.entity,"host_hidden"))return;let i=ot.app.renderer,n=new L.a.Container,s=new V.Matrix;s.translate(-e._display.position.x,-e._display.position.y),s.rotate(-e._display.rotation);let o=1/e._display.scale.x;s.scale(o,o),s.translate(e._texture.width/2,e._texture.height/2),n.transform.setFromMatrix(s);let a,r,l,h=new L.a.Container;if(0!==t.players.length&&0!==t.lights.length){a=this.renderTexturePool.getOptimalTexture(e._display.width,e._display.height),r=this.renderTexturePool.getOptimalTexture(e._display.width,e._display.height);for(let e of t.players)n.addChild(e.mesh);i.render(n,a,!0),n.removeChildren();for(let e of t.lights)e.mesh.blendMode=L.a.BLEND_MODES.ADD,n.addChild(e.mesh);let s=new L.a.Sprite(a);s.blendMode=V.BLEND_MODES.SRC_IN,h.addChild(n,s),i.render(h,r,!0),h.removeChildren(),n.removeChildren(),l=new L.a.Sprite(r),l.blendMode=L.a.BLEND_MODES.ADD,h.addChild(l)}for(let e of t.nightVisPlayers)n.addChild(e.mesh);let c=new L.a.Sprite(e._texture);c.blendMode=L.a.BLEND_MODES.SRC_IN,h.addChild(n,c),ot.app.renderer.render(h,e._renTex,!1),e._visibilityMapChanged=!0,h.destroy(et.c),c.destroy(et.c),void 0!==a&&this.renderTexturePool.returnTexture(a),void 0!==r&&this.renderTexturePool.returnTexture(r),void 0!==l&&l.destroy(et.c)}enable(){this.displayMaps=new L.a.Container,this.displayMaps.zIndex=st.a.BACKGROUND,this.displayMaps.interactive=!0,this.displayMaps.interactiveChildren=!0,this.displayLayer=new L.a.display.Layer,this.displayLayer.zIndex=st.a.BACKGROUND,this.displayLayer.interactive=!1,this.displayLayer.interactiveChildren=!1,this.phase.board.addChild(this.displayMaps),ot.app.stage.addChild(this.displayLayer)}destroy(){this.displayLayer.destroy(et.b),this.displayMaps.destroy(et.b)}}const jt=["name","note"],Ft=["name","note","player","light"],Ut=["note"];class Gt{constructor(t){this.selectedEntities=new Set,this.dataByType=new Map,this.isTranslating=!1,this.translateDirty=!1,this.ecs=t,this.ecs.events.on("tool_move_begin",()=>this.isTranslating=!0),this.ecs.events.on("tool_move_end",()=>{this.isTranslating=!1,this.translateDirty&&(this.translateDirty=!1,this.update())}),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edited",this.onComponentUpdate,this),this.ecs.events.on("component_removed",this.onComponentRemove,this),this.ecs.events.on("entity_despawn",this.onEntityDespawn,this)}update(){this.isTranslating?this.translateDirty=!0:this.ecs.events.emit("selection_update",this)}onComponentAdd(t){this.selectedEntities.has(t.entity)&&(this.getOrCreateData(t.type).entities.add(t),this.update())}onComponentUpdate(t){this.selectedEntities.has(t.entity)&&this.update()}onComponentRemove(t){if(!this.selectedEntities.has(t.entity))return;let e=this.dataByType.get(t.type);e.entities.delete(t),0===e.entities.size&&this.dataByType.delete(t.type),this.update()}onEntityDespawn(t){this.selectedEntities.has(t)&&this.removeEntities([t])}clear(t=!0,e=!0){if(t)for(let t of this.selectedEntities)this.ecs.events.emit("selection_end",t);this.selectedEntities.clear(),this.dataByType.clear(),e&&this.update()}setOnlyEntity(t){this.clear(!0,!1),this.addEntities([t])}setOnlyEntities(t){let e=new Set(t),i=new Array;for(let t of this.selectedEntities)e.has(t)||i.push(t);this.removeEntities(i,!1),this.addEntities(t,!1),this.update()}toggleEntities(t,e=!0){for(let e of t)this.selectedEntities.has(e)?this.removeEntities([e],!1):this.addEntities([e],!1);e&&this.update()}addEntities(t,e=!0){let i=0;for(let e of t){if(this.selectedEntities.has(e))continue;i++,this.selectedEntities.add(e);let t=this.ecs.getAllComponents(e);for(let e of t)this.getOrCreateData(e.type).entities.add(e);this.ecs.events.emit("selection_begin",e)}e&&0!==i&&this.update()}removeEntities(t,e=!0){let i=0;for(let e of t){if(!this.selectedEntities.has(e))continue;i++,this.selectedEntities.delete(e);let t=this.ecs.getAllComponents(e);for(let e of t){let t=this.dataByType.get(e.type);t.entities.delete(e),0===t.entities.size&&this.dataByType.delete(e.type)}this.ecs.events.emit("selection_end",e)}e&&0!==i&&this.update()}getSelectedByType(t){let e=this.dataByType.get(t);return void 0===e?[]:e.entities}initialComponent(t){let e=this.ecs.storages.get(t);return{_canDelete:Ft.indexOf(t)>=0,_isFullscreen:!(Ut.indexOf(t)>=0)&&void 0,_sync:e.sync,_save:e.save}}getSingleComponents(){let t=new Array,e=this.selectedEntities.values().next().value;for(let i of this.ecs.storages.keys()){if(i.startsWith("host_"))continue;let n=this.ecs.storages.get(i).getComponents(e);for(let e of n)t.push(Wt(this.initialComponent(i),e))}return t}getCommonComponents(){if(0===this.selectedEntities.size)return[];let t=this.selectedEntities.size;if(1===t)return this.getSingleComponents();let e=new Array;for(let i of this.ecs.storages.keys()){if("host_hidden"===i)continue;let n=this.dataByType.get(i);null!=n&&n.entities.size===t&&-1===jt.indexOf(i)&&e.push(i)}let i=new Array;for(let t of e){if("host_hidden"===t)continue;let e=void 0;for(let i of this.selectedEntities){let n=this.ecs.storages.get(t).getComponents(i);for(let i of n)void 0===e?e=Wt(this.initialComponent(t),i):Ht(e,i)}i.push(e)}return i}getCommonEntityOpts(){let t=this.dataByType.get("host_hidden");return{hidden:void 0!==t&&t.entities.size===this.selectedEntities.size}}getAddableComponents(){let t=new Array;return t.push({type:"name",name:"Name"},{type:"note",name:"Note"}),!this.hasEveryoneType("pin")||this.hasComponentType("light")||this.hasComponentType("player")?this.hasEveryoneType("wall")&&!this.hasComponentType("door")?t.push({type:"door",name:"Door"}):this.hasEveryoneType("prop")&&!this.hasComponentType("prop_teleport")&&t.push({type:"prop_teleport",name:"Teleporter"}):t.push({type:"light",name:"Light"},{type:"player",name:"Player"}),t}setProperty(t,e,i,n){if("$"!==t)if("@"!==t){for(let s of this.selectedEntities){let o={};o[e]=i,this.ecs.editComponent(s,t,o,n)}this.update()}else this.ecs.events.emit(e,i,n);else switch(e){case"hidden":for(let t of this.selectedEntities){let e=this.ecs.getComponent(t,"host_hidden");void 0!==e?this.ecs.removeComponent(e):this.ecs.addComponent(t,{type:"host_hidden",entity:-1})}break;case"delete":for(let t of[...this.selectedEntities])this.ecs.despawnEntity(t);this.clear();break;case"addComponent":let t;switch(i){case"name":t={type:"name",name:"",clientVisible:!0};break;case"note":t={type:"note",note:"",clientVisible:!0};break;case"light":t={type:"light",color:16777215,range:5};break;case"player":t={type:"player",nightVision:!1,range:50};break;case"door":t={type:"door",doorType:Z.NORMAL_LEFT,locked:!1,open:!1,clientVisible:!0};break;case"prop_teleport":t={type:"prop_teleport"};break;default:throw"Cannot add unknown component: "+i}for(let e of[...this.selectedEntities])this.ecs.addComponent(e,Object.assign({},t));break;case"removeComponent":for(let t of[...this.selectedEntities]){let e=this.ecs.getComponent(t,i,n);void 0!==e&&this.ecs.removeComponent(e)}break;default:console.warn("Unknown special event: "+e)}}moveAll(t,e){for(let i of this.selectedEntities){let n=this.ecs.getComponent(i,"position");void 0!==n&&this.ecs.editComponent(i,"position",{x:n.x+t,y:n.y+e})}this.isTranslating?this.translateDirty=!0:this.update()}getOrCreateData(t){let e=this.dataByType.get(t);return void 0===e&&(e={entities:new Set},this.dataByType.set(t,e)),e}hasComponentType(t){let e=this.dataByType.get(t);return void 0!==e&&e.entities.size>0}hasEveryoneType(t){let e=this.dataByType.get(t);return void 0!==e&&e.entities.size===this.selectedEntities.size}}function Wt(t,e){for(let i in e)"_"!==i[0]&&(t[i]=e[i]);return t}function Ht(t,e){for(let i in e)"_"!==i[0]&&t[i]!==e[i]&&(t[i]=null);for(let i in t)"_"!==i[0]&&void 0===e[i]&&(t[i]=null)}var $t=i(52),qt=i.n($t),Qt=i(19);class Kt{constructor(t){this.connections=[],this.connectionsById=new Map,this.myId=-1,this.nextBroadcastPacketId=0,this.eventEmitter=new Qt,this.bufferingChannels=0,this.isHost=t,this.isHost&&(this.myId=0)}onMessage(t,e){let i=t;if(this.isHost&&(i.sender=e.channelId),i.payload.type.startsWith("_"))console.error("Invalid payload type");else{if(this.isHost&&i.receiver!==this.myId){let t=i.id;if(void 0===i.receiver){i.id=this.nextBroadcastPacketId++;for(let t of this.connectionsById.values())t!==e&&t.send(i)}else{let t=this.connectionsById.get(i.receiver);if(void 0===t)return void this.send({type:"error",errorType:"unknown_receiver",requestId:i.id},e.channelId);i.id=t.nextPacketId++,t.send(i)}i.id=t}if(void 0===i.receiver||i.receiver===this.myId){let t=i.payload.type;0,this.eventEmitter.emit("any",i.payload,i),this.eventEmitter.emit(t,i.payload,i)}}}broadcast(t){const e={id:this.nextBroadcastPacketId,payload:t,sender:this.myId};for(let t of this.connectionsById.values())t.send(e);this.nextBroadcastPacketId++}send(t,e){const i={id:0,payload:t,sender:this.myId};if(this.isHost){let t=this.connectionsById.get(e);if(void 0===t)throw"Unknown receiver";i.id=t.channelId++,t.send(i)}else{i.id=this.nextBroadcastPacketId++;for(let t of this.connectionsById.values())t.send(i)}}onConnectionStatusUpdate(t){t?this.bufferingChannels+=1:this.bufferingChannels-=1,this.eventEmitter.emit("_buffering_update",this.bufferingChannels)}registerNewConnection(t){this.connectionsById.set(t.channelId,t),this.connections.push(t),t.ondata=this.onMessage.bind(this),t.nextPacketId=0,t.onBufferChange=this.onConnectionStatusUpdate.bind(this),this.eventEmitter.emit("_device_join",t.channelId)}removeConnection(t){this.connectionsById.delete(t.channelId);const e=this.connections.indexOf(t);e>-1&&this.connections.splice(e,1),this.eventEmitter.emit("_device_left",t.channelId)}}var Jt=L.a.utils.EventEmitter;class Zt extends Jt{constructor(t){super(),this.myId=-1,this.nextConnectionId=1,this.isHost=t,this.channel=new Kt(t),this.peer=new qt.a(void 0,{host:"peerjs.92k.de",secure:!0,debug:2}),this.isHost&&(this.myId=0,this.connections=new Map),this.peer.on("connection",this.onConnection.bind(this)),this.peer.on("open",this.onPeerConnectionOpen.bind(this)),this.peer.on("error",this.onPeerConnectionError.bind(this))}onConnection(t){let e=0;this.isHost&&(e=this.nextConnectionId++);let i=new te(this,e,t);this.isHost?this.connections.set(e,i):this.hostConnection=i}onPeerConnectionOpen(){void 0!==this.connectId&&this.connectReady(),this.emit("ready")}onPeerConnectionError(t){this.emit("error",t)}getId(){return this.peer.id}connectTo(t){if(this.isHost)throw"A host cannot open a connection, for now!";if(void 0!==this.connectId)throw"Cannot connect to multiple hosts";this.connectId=t,null!=this.peer.id&&this.connectReady()}connectReady(){let t=this.peer.connect(this.connectId,{reliable:!0});this.hostConnection=new te(this,void 0,t)}}class te{constructor(t,e,i){this.bootstrap=!1,this.buffered=!1,this.parent=t,this.channelId=e,this.connection=i,t.isHost&&(this.bootstrap=!0),i.on("open",this.onOpen.bind(this)),i.on("data",this.onData.bind(this)),i.on("close",this.onClose.bind(this))}onOpen(){this.connection.dataChannel.onbufferedamountlow=this.updateBuffered.bind(this),this.parent.isHost&&(this.connection.send(this.channelId),this.parent.channel.registerNewConnection(this))}onData(t){if(!this.bootstrap)return this.parent.myId=t,this.parent.channel.myId=t,this.bootstrap=!0,void this.parent.channel.registerNewConnection(this);void 0!==this.ondata&&this.ondata(t,this)}onClose(){this.parent.channel.removeConnection(this)}send(t){this.connection.send(t),this.updateBuffered()}bufferedBytes(){return this.connection.dataChannel.bufferedAmount}updateBuffered(){let t=this.buffered;this.buffered=this.connection.bufferSize+this.connection.dataChannel.bufferedAmount!==0,t!==this.buffered&&void 0!==this.onBufferChange&&this.onBufferChange(this.buffered)}}var ee=i(26),ie=i(25);class ne{constructor(t,e){this.storage=new tt.c("pin",!0,!0),this.ecs=t,this.phase=e,this.textSystem=e.textSystem,this.useVisibility=!this.ecs.isMaster,t.addStorage(this.storage),t.events.on("component_add",this.onComponentAdd,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_remove",this.onComponentRemove,this),t.events.on("selection_begin",this.onSelectionBegin,this),t.events.on("selection_end",this.onSelectionEnd,this),t.events.on("resource_edited",this.onResourceEdited,this)}setVisible(t,e){e?(t._display.visible||(t._display.visible=!0,this.displayPins.addChild(t._display)),void 0!==t._labelDisplay&&(t._labelDisplay.visible=!0),this.redrawComponent(t,void 0)):(t._display.visible&&(t._display.visible=!1,this.displayPins.removeChild(t._display)),void 0!==t._labelDisplay&&(t._labelDisplay.visible=!1))}onComponentAdd(t){if("pin"!==t.type)return;let e=t,i=this.ecs.getComponent(t.entity,"position");void 0!==i&&(this.addPin(i,e),this.ecs.addComponent(t.entity,{type:"interaction",entity:-1,snapEnabled:!0,selectPriority:st.a.PINS,shape:Object(Vt.h)(new L.a.Point(i.x,i.y))}),this.ecs.addComponent(t.entity,{type:"player_visible",entity:-1,visible:!1}))}onComponentEdited(t,e){if("pin"===t.type||"position"===t.type){let e,i;if("pin"===t.type?(e=t,i=this.ecs.getComponent(t.entity,"position")):(e=this.storage.getComponent(t.entity),i=t),void 0===e||void 0===i)return;this.redrawComponent(e,i)}else if("player_visible"===t.type){if(!this.useVisibility)return;let e=t,i=this.storage.getComponent(e.entity);void 0!==i&&this.setVisible(i,e.visible)}}onComponentRemove(t){"pin"===t.type&&t._display.destroy({children:!0,texture:!1,baseTexture:!1})}onSelectionBegin(t){let e=this.storage.getComponent(t);void 0!==e&&(e._selected=!0,this.redrawComponent(e,void 0))}onSelectionEnd(t){let e=this.storage.getComponent(t);void 0!==e&&(e._selected=void 0,this.redrawComponent(e,void 0))}onResourceEdited(t,e){if("local_light_settings"!==t.type)return;let i=t;if("visionType"in e)if("dm"===i.visionType){this.useVisibility=!1;for(let t of this.storage.allComponents())this.setVisible(t,!0)}else{if("rp"!==i.visionType)throw"Unknown vision type";this.useVisibility=!0;for(let t of this.storage.allComponents()){let e=this.ecs.getComponent(t.entity,"player_visible");this.setVisible(t,e.visible)}}}addPin(t,e){if(void 0===e._display){let t=new L.a.Sprite(this.circleTex);t.visible=!1,e._display=t}this.setVisible(e,!this.useVisibility),this.redrawComponent(e,t)}redrawComponent(t,e){void 0===e&&(e=this.ecs.getComponent(t.entity,"position"));let i=t._display,n=t.color;var s,o,a;t._selected&&(n=((s=n)>>16&255)*(1-(a=.3))+((o=7964363)>>16&255)*a<<16|(s>>8&255)*(1-a)+(o>>8&255)*a<<8|(255&s)*(1-a)+(255&o)*a),i.tint=n,i.position.set(e.x,e.y),void 0===t.label?void 0!==t._labelDisplay&&(t._labelDisplay.destroy(et.b),t._labelDisplay=void 0):(void 0===t._labelDisplay&&(t._labelDisplay=new L.a.Text("TEST"),t._labelDisplay.parentLayer=this.textSystem.textLayer,t._labelDisplay.anchor.set(.5,1),t._labelDisplay.visible=t._display.visible,this.displayLabels.addChild(t._labelDisplay)),t._labelDisplay.position.set(e.x,e.y-12),t._labelDisplay.text=t.label)}initCreation(){this.cancelCreation();let t=Math.floor(16777215*Math.random());this.createPin=new L.a.Sprite(this.circleTex),this.createPin.tint=t,this.createPin.position.set(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),this.displayPins.addChild(this.createPin)}cancelCreation(){void 0!==this.createPin&&(this.createPin.destroy({children:!0,texture:!1,baseTexture:!1}),this.createPin=void 0)}redrawCreation(t){void 0!==this.createPin&&this.createPin.position.set(t.x,t.y)}confirmCreation(t){if(void 0===this.createPin)return;let e=this.ecs.spawnEntity({type:"position",x:t.x,y:t.y},{type:"pin",color:this.createPin.tint,_display:this.createPin});this.createPin=void 0,this.phase.changeTool(ce.INSPECT),this.phase.selection.setOnlyEntity(e)}enable(){this.useVisibility="dm"!==this.phase.lightSystem.localLightSettings.visionType,this.layerPin=new L.a.display.Layer,this.layerPin.zIndex=st.a.PINS,ot.app.stage.addChild(this.layerPin);let t=new L.a.Container;this.displayPins=new L.a.ParticleContainer(1e4,{vertices:!1,position:!0,rotation:!1,uvs:!1,tint:!0}),t.parentLayer=this.layerPin,t.addChild(this.displayPins),this.displayLabels=new L.a.Container,this.phase.board.addChild(t,this.displayLabels);let e=new L.a.Graphics;e.beginFill(16777215),e.lineStyle(0),e.drawCircle(12,12,12),this.circleTex=ot.app.renderer.generateTexture(e,L.a.SCALE_MODES.LINEAR,1),this.circleTex.defaultAnchor.set(.5,.5)}destroy(){this.circleTex.destroy(!0),this.displayLabels.destroy(et.b),this.displayPins.destroy(et.b),this.layerPin.destroy(et.b)}}class se{constructor(t,e){this.storage=new tt.c("wall"),this.createdIds=[],this.isTranslating=!1,this.ecs=t,this.phase=e,t.addStorage(this.storage),t.events.on("component_add",this.onComponentAdd,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_remove",this.onComponentRemove,this),t.events.on("resource_edited",this.onResourceEdited,this),t.events.on("selection_begin",this.onSelectionBegin,this),t.events.on("selection_end",this.onSelectionEnd,this),t.events.on("tool_move_begin",this.onToolMoveBegin,this),t.events.on("tool_move_end",this.onToolMoveEnd,this)}onComponentAdd(t){if("wall"!==t.type)return;let e=t,i=this.ecs.getComponent(e.entity,"position");void 0!==i?(e._dontMerge=0,void 0===e.visible&&(e.visible=!1),this.addWallDisplay(i,e),this.ecs.addComponent(t.entity,{type:"interaction",entity:-1,shape:Object(Vt.f)(new it.a(i.x,i.y,i.x+e.vec[0],i.y+e.vec[1])),snapEnabled:!0,selectPriority:st.a.WALL}),e.visible||this.ecs.addComponent(t.entity,{type:"player_visible",entity:-1,visible:!1,isWall:!0}),this.ecs.addComponent(t.entity,{type:"visibility_blocker",entity:-1})):console.warn("Found wall without position, please add first the position, then the wall")}fixWallPreTranslation(t){for(let e of t){let t=this.ecs.getComponent(e.entity,"visibility_blocker");void 0!==t&&this.ecs.removeComponent(t)}let e=new Map,i=this.ecs.storages.get("position"),n=(t,i)=>{let n=e.get(t);void 0===n&&(n=[],e.set(t,n)),n.push(i)};for(let s of t){if(0!==s._dontMerge)continue;let t=i.getComponent(s.entity),o=t.x+"@"+t.y,a=t.x+s.vec[0]+"@"+(t.y+s.vec[1]),r=o=>{let r=void 0,l=e.get(o);if(void 0===l)return;let h=l.length;for(let t=0;t<h;t++){let e=l[t];if(Object(nt.e)(s.vec[0],s.vec[1],e.vec[0],e.vec[1])){r=t;break}}if(void 0===r)return!1;let c,d=l[r],p=i.getComponent(d.entity),u=!1,m=t.x,y=t.y,g=s.vec[0],f=s.vec[1];return a===o&&(m+=g,y+=f,g=-g,f=-f),p.x===m&&p.y===y?(p.x+=g,p.y+=f,u=!0):(d.vec[0]+=s.vec[0],d.vec[1]+=s.vec[1]),l.splice(r,1),c=u?p.x+"@"+p.y:p.x+d.vec[0]+"@"+(p.y+d.vec[1]),n(c,d),this.ecs.despawnEntity(s.entity),this.redrawWall(p,d),!0};r(o)||r(a)||(n(o,s),n(a,s))}}fixWallPostTranslation(t){let e=this.ecs.storages.get("position");for(let i of t){let t=e.getComponent(i.entity),n=[t.x,t.y,t.x+i.vec[0],t.y+i.vec[1]];this.fixIntersections(n,0),this.ecs.editComponent(t.entity,"interaction",{shape:Object(Vt.f)(new it.a(n[0],n[1],n[2],n[3]))}),n.length>4&&(t.x=n[0],t.y=n[1],i.vec[0]=n[2]-t.x,i.vec[1]=n[3]-t.y),this.redrawWall(t,i);let s=n.length,o=[];for(let t=4;t<s;t+=2)o.push(this.createWall(n[t-2],n[t-1],n[t],n[t+1]));o.length>0&&this.phase.selection.addEntities(o)}for(let e of t)this.ecs.addComponent(e.entity,{type:"visibility_blocker",entity:-1})}onComponentEdited(t,e){if("player_visible"===t.type){let e=t,i=this.storage.getComponent(t.entity);if(void 0===i||!e.visible)return;return this.ecs.editComponent(t.entity,"wall",{visible:!0}),i._display.visible=!0,void this.ecs.removeComponent(t)}if("wall"!==t.type&&"position"!==t.type)return;let i,n;"wall"===t.type?(i=t,n=this.ecs.getComponent(t.entity,"position")):(i=this.storage.getComponent(t.entity),n=t),void 0!==i&&void 0!==n&&(this.isTranslating||(this.fixWallPreTranslation([i]),this.fixWallPostTranslation([i])),"wall"===t.type&&"vec"in e&&this.ecs.editComponent(i.entity,"interaction",{shape:Object(Vt.f)(new it.a(n.x,n.y,n.x+i.vec[0],n.y+i.vec[1]))}),"position"===t.type?i._display.position.set(n.x,n.y):this.redrawWall(n,i))}findLocationOnWall(t,e){let i=this.phase.interactionSystem.query(Object(Vt.c)(new Xt.a(t.x-e,t.y-e,t.x+e,t.y+e)),t=>void 0!==this.storage.getComponent(t.entity)),n=new L.a.Point,s=Number.POSITIVE_INFINITY,o=new L.a.Point;for(let a of i){if(!a.shape.data.projectPoint(t,o))continue;let i=Object(Lt.a)(o.x,o.y,t.x,t.y);i<s&&i<e&&(n.copyFrom(o),s=i)}return s!==Number.POSITIVE_INFINITY?n:void 0}onComponentRemove(t){if("wall"!==t.type)return;t._display.destroy(et.b)}onResourceEdited(t,e){if("local_light_settings"===t.type&&"visionType"in e){let e="dm"===t.visionType;for(let t of this.storage.allComponents())t._display.visible=e||t.visible}}onSelectionBegin(t){let e=this.storage.getComponent(t);if(void 0===e)return;e._selected=!0;let i=this.ecs.getComponent(e.entity,"position");this.redrawWall(i,e)}onSelectionEnd(t){let e=this.storage.getComponent(t);if(void 0===e)return;e._selected=void 0;let i=this.ecs.getComponent(e.entity,"position");this.redrawWall(i,e)}onToolMoveBegin(){this.isTranslating=!0;let t=[...this.phase.selection.getSelectedByType("wall")];this.fixWallPreTranslation(t)}onToolMoveEnd(){this.isTranslating=!1;let t=[...this.phase.selection.getSelectedByType("wall")];this.fixWallPostTranslation(t)}fixIntersections(t,e,i){let n=new Xt.a(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);i=void 0===i?t.length:i;for(let s=e;s<i;s+=2)n.minX=Math.min(n.minX,t[s]),n.minY=Math.min(n.minY,t[s+1]),n.maxX=Math.max(n.maxX,t[s]),n.maxY=Math.max(n.maxY,t[s+1]);let s=new it.a(0,0,0,0),o=new L.a.Point,a=this.phase.interactionSystem.query(Object(Vt.c)(n),t=>void 0!==this.storage.getComponent(t.entity));for(let n of a)for(let a=e+2;a<i;a+=2){s.fromX=t[a-2],s.fromY=t[a-1],s.toX=t[a],s.toY=t[a+1];let e=n.shape.data;Object(nt.d)(s,e,o)===nt.a.INTERN&&(t.splice(a,0,o.x,o.y),a+=2,i+=2)}return i}createWall(t,e,i,n){return this.ecs.spawnEntity({type:"position",entity:-1,x:t,y:e},{type:"wall",vec:[i-t,n-e],visible:!1,_selected:!0})}addVertex(t){let e=this.createdLastPos;if(void 0===e)this.createdLastPos=[t.x,t.y];else if(t.x==e[0]&&t.y==e[1])this.endCreation();else{let i=[e[0],e[1],t.x,t.y];this.fixIntersections(i,0);let n=i.length;for(let t=2;t<n;t+=2)this.createdIds.push(this.createWall(i[t-2],i[t-1],i[t],i[t+1]));this.createdLastPos=[t.x,t.y]}}undoVertex(t){if(void 0!==this.createdLastPos){if(0===this.createdIds.length)this.createdLastPos=void 0;else{let t=this.createdIds.pop(),e=this.ecs.getComponent(t,"position"),i=this.storage.getComponent(t);e.x===this.createdLastPos[0]&&e.y==this.createdLastPos[1]?this.createdLastPos=[e.x+i.vec[0],e.y+i.vec[1]]:this.createdLastPos=[e.x,e.y],this.ecs.despawnEntity(t)}this.redrawCreationLastLine(t)}}initCreation(){this.endCreation()}endCreation(){this.createLastLineDisplay.clear(),this.createdLastPos=void 0,0!==this.createdIds.length&&(this.phase.selection.setOnlyEntities(this.createdIds),this.createdIds.length=0,this.phase.changeTool(ce.INSPECT))}addWallDisplay(t,e){let i=new L.a.Graphics;this.displayWalls.addChild(i),e._display=i,this.redrawWall(t,e)}redrawWall(t,e){e._display.visible=e.visible||"dm"===this.phase.lightSystem.localLightSettings.visionType,e._display.position.set(t.x,t.y);let i=0;e._selected&&(i=7964363);let n=[0,0,e.vec[0],e.vec[1]];this.redrawWall0(e._display,n,e._selected,i)}redrawWall0(t,e,i,n){if(t.clear(),0!==e.length){t.moveTo(e[0],e[1]),t.lineStyle(5,n);for(let i=2;i<e.length;i+=2)t.lineTo(e[i],e[i+1]);if(i){t.lineStyle(0),t.beginFill(15011856),t.drawCircle(e[0],e[1],10),t.endFill(),t.beginFill(n);for(let i=2;i<e.length;i+=2)t.drawCircle(e[i],e[i+1],10);t.endFill()}}}redrawCreationLastLine(t){let e=this.createLastLineDisplay;e.clear(),void 0!==this.createdLastPos&&(e.moveTo(this.createdLastPos[0],this.createdLastPos[1]),e.lineStyle(5,7964363),e.lineTo(t.x,t.y)),e.lineStyle(0),0===this.createdIds.length&&void 0!==this.createdLastPos&&(e.beginFill(15011856),e.drawCircle(this.createdLastPos[0],this.createdLastPos[1],10)),e.beginFill(4218878),e.drawCircle(t.x,t.y,10)}enable(){this.layer=new L.a.display.Layer,this.layer.zIndex=st.a.WALL,this.layer.interactive=!1,ot.app.stage.addChild(this.layer),this.displayWalls=new L.a.Container,this.displayWalls.parentLayer=this.layer,this.displayWalls.interactive=!1,this.displayWalls.interactiveChildren=!1,this.createLastLineDisplay=new L.a.Graphics,this.createLastLineDisplay.parentLayer=this.layer,this.createLastLineDisplay.zOrder=2,this.phase.board.addChild(this.displayWalls,this.createLastLineDisplay)}destroy(){this.layer.destroy(et.b),this.displayWalls.destroy(et.b),this.createLastLineDisplay.destroy(et.b)}}class oe{constructor(t){this.ecs=t}enable(){this.textLayer=new L.a.display.Layer,this.textLayer.zIndex=st.a.TEXT,this.textLayer.interactive=!1,this.textLayer.interactiveChildren=!1,ot.app.stage.addChild(this.textLayer)}destroy(){this.textLayer.destroy(et.b)}}var ae=i(28),re=i(38),le=i(14);class he{constructor(t,e){this.storage=new tt.c("visibility",!1,!1),this.blockerStorage=new tt.c("visibility_blocker",!1,!1),this.aabbTree=new re.a,this.ecs=t,this.interactionSystem=e.interactionSystem,t.addStorage(this.storage),t.addStorage(this.blockerStorage),t.events.on("component_add",this.onComponentAdd,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_removed",this.onComponentRemoved,this)}removeTreePolygon(t){void 0!==t._aabbTreeId&&(this.aabbTree.destroyProxy(t._aabbTreeId),t._aabbTreeId=void 0)}updatePolygon(t){let e=this.ecs.getComponent(t.entity,"position");if(void 0===e)return;if(this.removeTreePolygon(t),t.range<=0)return void this.ecs.editComponent(t.entity,t.type,{polygon:void 0,polygonAabb:void 0,aabb:void 0});let i,n=50*t.range,s=new Xt.a(e.x-n,e.y-n,e.x+n,e.y+n),o=new Array,a=new Array,r=this.interactionSystem.query(Object(Vt.c)(s),t=>void 0!==this.blockerStorage.getComponent(t.entity));for(let t of r){let e=t.shape;if(e.type!==Vt.b.LINE)throw"Only line is supported as light blocker shape";o.push(e.data),a.push(t.entity)}i=!0===t.trackWalls?new Array:void 0;let l=Object(le.b)(o,s,e,i);if(s.wrapPolygon(l),void 0!==i)for(let t=0;t<i.length;t++)i[t]=a[i[t]];this.ecs.editComponent(t.entity,t.type,{polygon:l,aabb:s,_canSeeWalls:i}),t._aabbTreeId=this.aabbTree.createProxy(s,t)}recomputeArea(t){for(let e of[...this.aabbTree.query(t)])this.updatePolygon(e.tag)}onComponentAdd(t){if("visibility"===t.type){let e=t;e._canSee=[],this.updatePolygon(e)}else if("visibility_blocker"===t.type){let e=this.ecs.getComponent(t.entity,"interaction");void 0!==e&&this.recomputeArea(Object(Vt.j)(e.shape))}else"interaction"===t.type&&void 0!==this.blockerStorage.getComponent(t.entity)&&this.recomputeArea(Object(Vt.j)(t.shape))}onComponentEdited(t,e){if("visibility"===t.type)"range"in e&&this.updatePolygon(t);else if("position"===t.type){let e=this.storage.getComponent(t.entity);void 0!==e&&this.updatePolygon(e);let i=this.blockerStorage.getComponent(t.entity);if(void 0!==i){let t=this.ecs.getComponent(i.entity,"interaction");this.recomputeArea(Object(Vt.j)(t.shape))}}else if("interaction"===t.type&&"shape"in e&&void 0!==this.blockerStorage.getComponent(t.entity)){let e=t;this.recomputeArea(Object(Vt.j)(e.shape))}}onComponentRemoved(t){if("visibility"===t.type)this.removeTreePolygon(t);else if("visibility_blocker"===t.type){let e=this.ecs.getComponent(t.entity,"interaction");void 0!==e&&this.recomputeArea(Object(Vt.j)(e.shape))}else if("interaction"===t.type&&void 0!==this.blockerStorage.getComponent(t.entity)){let e=t;this.recomputeArea(Object(Vt.j)(e.shape))}}enable(){}destroy(){}}var ce,de=i(15),pe=i(39);class ue{constructor(t,e){this.storage=new tt.c("player",!0,!0),this.visibleStorage=new tt.c("player_visible",!1,!1),this.ecs=t,this.phase=e,this.ecs.addStorage(this.storage),this.ecs.addStorage(this.visibleStorage),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edited",this.onComponentEdited,this),this.ecs.events.on("component_remove",this.onComponentRemove,this),this.ecs.events.on("resource_edited",this.onResourceEdited,this),e.visibilityAwareSystem.events.on("aware_update",this.onVisibilityAwareUpdate,this)}onPlayerVisibleCountersUpdate(t){let e=t._playerNightVisionCount>0||(this.ambientIlluminated||t._lightCount>0||t.isWall)&&t._playerCount>0;e!==t.visible&&this.ecs.editComponent(t.entity,t.type,{visible:e})}onVisibilityAwareUpdate(t,e,i){let n=this.visibleStorage.getComponent(t.entity);if(void 0!==n){for(let t of e){let e=this.storage.getComponent(t);void 0===e?void 0!==this.ecs.getComponent(t,"light")&&(n._lightCount+=1):(n._playerCount+=1,e.nightVision&&(n._playerNightVisionCount+=1))}for(let t of i){let e=this.storage.getComponent(t);void 0===e?void 0!==this.ecs.getComponent(t,"light")&&(n._lightCount-=1):(n._playerCount-=1,e.nightVision&&(n._playerNightVisionCount-=1))}this.onPlayerVisibleCountersUpdate(n)}}onNightVisionUpdate(t){let e=this.ecs.getComponent(t.entity,"visibility"),i=t.nightVision?1:-1,n=t=>{let e=this.visibleStorage.getComponent(t);void 0!==e&&(e._playerNightVisionCount+=i,this.onPlayerVisibleCountersUpdate(e))};for(let t of e._canSee)n(t);for(let t of e._canSeeWalls)n(t)}createVisMeshFrom(t,e){let i=de.a("const");de.c(i,t,e.polygon);let n=50*e.range;return de.d(i,t,n*n,16777215),i}spreadPlayerVisibility(t,e,i,n){let s=de.a("const");de.c(s,e,i.polygon);let o=50*i.range;de.d(s,e,o*o,16777215);let a,r=this.ecs.storages.get("light"),l=this.ecs.storages.get("position"),h={mesh:s,vis:i,pos:e},c=[],d=[],p=[];if(!n&&this.phase.lightSystem.lightSettings.needsLight){c.push(h),a=void 0;for(let t of this.phase.visibilitySystem.aabbTree.query(i.aabb)){let e=t.tag;if(void 0===r.getComponent(e.entity)||e.range<=0)continue;let i=l.getComponent(e.entity);void 0===a?a=e.aabb.copy():a.combine(e.aabb,a);let n=this.createVisMeshFrom(i,e);p.push({mesh:n,pos:i,vis:e})}if(0===p.length)return;a.intersect(i.aabb,a)}else d.push(h),a=i.aabb;let u={aabb:a,lights:p,players:c,nightVisPlayers:d};this.ecs.events.emit("visibility_spread",u),h.mesh.destroy(et.b);for(let t of u.lights)t.mesh.destroy(et.b)}spreadLightVisibility(t){if(!this.phase.lightSystem.lightSettings.needsLight)return;let e=this.ecs.storages.get("visibility"),i=this.ecs.storages.get("position"),n=this.ecs.getComponent(t.entity,"position"),s=[{mesh:this.createVisMeshFrom(n,t),pos:n,vis:t}],o=void 0,a=[];for(let n of this.phase.visibilitySystem.aabbTree.query(t.aabb)){let t=n.tag,s=this.storage.getComponent(t.entity);if(void 0===s||t.range<=0||s.nightVision)continue;void 0===o?o=t.aabb:o.combine(t.aabb,o);let r=e.getComponent(s.entity),l=i.getComponent(s.entity),h=this.createVisMeshFrom(l,r);a.push({mesh:h,pos:l,vis:r})}if(0===a.length)return;o.intersect(t.aabb,o);let r={aabb:o,lights:s,players:a,nightVisPlayers:[]};this.ecs.events.emit("visibility_spread",r),s[0].mesh.destroy(et.b);for(let t of a)t.mesh.destroy(et.b)}spreadAfterLightNotNeeded(){let t=[],e=this.ecs.storages.get("visibility"),i=this.ecs.storages.get("position"),n=void 0;for(let s of this.storage.allComponents()){if(s.nightVision)continue;let o=e.getComponent(s.entity),a=i.getComponent(o.entity),r=this.createVisMeshFrom(a,o);void 0===n?n=o.aabb.copy():n.combine(o.aabb,n);let l={mesh:r,pos:a,vis:o};t.push(l)}if(void 0===n)return;let s={aabb:n,lights:[],players:[],nightVisPlayers:t};this.ecs.events.emit("visibility_spread",s);for(let e of t)e.mesh.destroy(et.b)}getSpreadDataForAabb(t,e){let i=[],n=[],s=[],o=this.phase.lightSystem.lightSettings.needsLight,a=this.ecs.storages.get("light"),r=this.ecs.storages.get("position");for(let e of this.phase.visibilitySystem.aabbTree.query(t)){let t=e.tag,l=this.storage.getComponent(t.entity);if(void 0===l){if(o){if(void 0!==a.getComponent(t.entity)){let e=r.getComponent(t.entity),i={mesh:this.createVisMeshFrom(e,t),pos:e,vis:t};s.push(i)}}}else{let e=r.getComponent(t.entity),s={mesh:this.createVisMeshFrom(e,t),pos:e,vis:t};l.nightVision||!o?i.push(s):n.push(s)}}let l=n,h=s;0!==n.length&&0!=s.length||(l=[],h=[]),e({aabb:t,lights:h,players:l,nightVisPlayers:i});for(let t of s)t.mesh.destroy(et.b);for(let t of n)t.mesh.destroy(et.b);for(let t of i)t.mesh.destroy(et.b)}onComponentAdd(t){if("player"===t.type){let e=t,i=this.visibleStorage.getComponent(t.entity);i._playerNightVisionCount++,this.onPlayerVisibleCountersUpdate(i);let n=this.ecs.getComponent(e.entity,"visibility");void 0===n&&(n={type:"visibility",range:e.range,trackWalls:!0},this.ecs.addComponent(t.entity,n))}else if("player_visible"===t.type){let e=t;e._lightCount=0,e._playerCount=0,e._playerNightVisionCount=0,this.ecs.addComponent(e.entity,Object(pe.b)(!0===e.isWall))}}onComponentEdited(t,e){if("player"===t.type){let i=t;if("nightVision"in e&&this.onNightVisionUpdate(i),"range"in e)this.ecs.editComponent(i.entity,"visibility",{range:i.range});else{let e=this.ecs.getComponent(i.entity,"visibility");if(void 0!==e.polygon){let n=this.ecs.getComponent(t.entity,"position");this.spreadPlayerVisibility(t.entity,n,e,i.nightVision)}}}else if("visibility"===t.type){let i=t;if(!("polygon"in e))return;let n=this.storage.getComponent(i.entity);if(void 0!==n){if(void 0!==i.polygon){let e=this.ecs.getComponent(t.entity,"position");this.spreadPlayerVisibility(t.entity,e,i,n.nightVision)}return}void 0!==this.ecs.getComponent(i.entity,"light")&&this.spreadLightVisibility(i)}}onComponentRemove(t){if("player"===t.type){let e=this.visibleStorage.getComponent(t.entity);if(void 0===e)return;e._playerNightVisionCount--,this.onPlayerVisibleCountersUpdate(e)}}onResourceEdited(t,e){if("light_settings"===t.type&&"needsLight"in e){let e=t;this.ambientIlluminated=!e.needsLight;for(let t of this.visibleStorage.allComponents())this.onPlayerVisibleCountersUpdate(t);e.needsLight||this.spreadAfterLightNotNeeded()}}enable(){de.b()}destroy(){}}class me{constructor(t,e){this.storage=new tt.c("prop",!0,!0),this.teleportStorage=new tt.c("prop_teleport",!0,!0),this.defaultPropType="ladder_down",this.ecs=t,this.phase=e,this.useVisibility=!this.ecs.isMaster,this.propTypes=new Map,this.loadPropTypes(),this.useVisibility=!this.ecs.isMaster,t.addStorage(this.storage),t.addStorage(this.teleportStorage),t.events.on("component_add",this.onComponentAdd,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_remove",this.onComponentRemove,this),t.events.on("selection_begin",this.onSelectionBegin,this),t.events.on("selection_end",this.onSelectionEnd,this),t.events.on("resource_edited",this.onResourceEdited,this),t.events.on("prop_use",this.onPropUse,this),t.events.on("prop_teleport_link",this.onPropTeleportLink,this)}getGridDimensions(t){return Math.ceil(t/a.size)}registerPropType(t){let e=this.getGridDimensions(t.texture.width),i=this.getGridDimensions(t.texture.height);t.gridSize={x:e,y:i},this.propTypes.set(t.id,t)}loadPropTypes(){const t=L.a.Loader.shared.resources.props.spritesheet,e=[{id:"ladder_up",name:"Ladder Up",texture:t.textures["ladder_up.png"]},{id:"ladder_down",name:"Ladder Down",texture:t.textures["ladder_down.png"]}];for(let t of e)this.registerPropType(t)}computeShape(t,e,i){let n=this.ecs.getResource("grid"),s=t.gridSize.x*n.size/2,o=t.gridSize.y*n.size/2,a=new Xt.a(e.x-s,e.y-o,e.x+s,e.y+o);return Object(Vt.g)(Dt.a.rotateAabb(a,i.rotation))}createSprite(){let t=new V.Sprite;return t.anchor.set(.5),t.interactive=!1,t.interactiveChildren=!1,this.display.addChild(t),t}onComponentAdd(t){if("prop"!==t.type)return;let e=t;void 0===e._display&&(e._display=this.createSprite(),this.redrawComponent(e,void 0,void 0));let i=this.ecs.getComponent(t.entity,"position"),n=this.ecs.getComponent(t.entity,"transform"),s=this.propTypes.get(e.propType);this.ecs.addComponent(t.entity,{type:"interaction",entity:-1,selectPriority:st.a.PROP,shape:this.computeShape(s,i,n)}),e.known||this.ecs.addComponent(t.entity,{type:"player_visible",entity:-1,visible:!1})}onComponentEdited(t,e){if("prop"===t.type){let i=t;if(this.redrawComponent(i,void 0,void 0),"propType"in e){let e=this.ecs.getComponent(t.entity,"position"),n=this.propTypes.get(i.propType).texture;this.ecs.editComponent(t.entity,"interaction",{shape:Object(Vt.c)(new Xt.a(e.x,e.y,e.x+n.width,e.y+n.height))})}}else if("position"===t.type){let e=t,i=this.storage.getComponent(t.entity);void 0!==i&&this.redrawComponent(i,e,void 0)}else if("transform"===t.type){let e=t,i=this.storage.getComponent(t.entity);void 0!==i&&this.redrawComponent(i,void 0,e)}else if("player_visible"===t.type){if(!t.visible)return;if(void 0===this.storage.getComponent(t.entity))return;this.ecs.editComponent(t.entity,"prop",{known:!0}),this.ecs.removeComponent(t)}}onComponentRemove(t){if("prop"===t.type){t._display.destroy({children:!0,texture:!1,baseTexture:!1});let e=this.teleportStorage.getComponent(t.entity);void 0!==e&&this.ecs.removeComponent(e)}}onSelectionBegin(t){let e=this.storage.getComponent(t);void 0!==e&&(e._selected=!0,e._display.tint=7964363)}onSelectionEnd(t){let e=this.storage.getComponent(t);void 0!==e&&(e._selected=!1,e._display.tint=16777215)}onResourceEdited(t,e){if("local_light_settings"===t.type){let i=t;if(!("visionType"in e))return;if("dm"===i.visionType){this.useVisibility=!1;for(let t of this.storage.allComponents())t._display.visible=!0}else{if("rp"!==i.visionType)throw"Unknown vision type";this.useVisibility=!0;for(let t of this.storage.allComponents()){if(t.known)continue;let e=this.ecs.getComponent(t.entity,"player_visible");t._display.visible=e.visible}}}else if("grid"===t.type){if(!("width"in e))return;let t=this.ecs.storages.get("position"),i=this.ecs.storages.get("transform");for(let e of this.storage.allComponents()){let n=t.getComponent(e.entity),s=i.getComponent(e.entity);this.ecs.editComponent(e.entity,"interaction",{shape:this.computeShape(this.propTypes.get(e.propType),n,s)}),this.redrawComponent(e,n,s)}}}onPropUse(t){let e=this.storage.getComponent(t),i=this.teleportStorage.getComponent(t);if(void 0===e||void 0===i)return;if(void 0===this.storage.getComponent(i.entity))return void console.warn("Unlinked teleporter!");let n=this.ecs.storages.get("position"),s=n.getComponent(t),o=n.getComponent(i.targetProp),a=o.x-s.x,r=o.y-s.y,l=this.ecs.getComponent(t,"interaction").shape,h=this.ecs.storages.get("pin"),c=this.phase.interactionSystem.query(l,t=>void 0!==h.getComponent(t.entity));for(let t of c){let e=n.getComponent(t.entity);this.ecs.editComponent(t.entity,e.type,{x:e.x+a,y:e.y+r})}}onPropTeleportLink(t){void 0!==this.teleportStorage.getComponent(t)?(this.currentLinkTarget=t,this.phase.changeTool(ce.PROP_TELEPORT_LINK)):console.warn("Called teleport link on a non-teleport prop, ignoring")}teleportLinkTo(t){if(void 0===this.storage.getComponent(t))return void console.warn("Trying to link teleport to a non-prop, ignoring");let e=this.teleportStorage.getComponent(this.currentLinkTarget);void 0!==e?(e.targetProp=t,this.currentLinkTarget=void 0):console.warn("Teleporter has been destroyed")}teleportLinkCancel(){this.currentLinkTarget=void 0}redrawComponent(t,e,i){void 0===e&&(e=this.ecs.getComponent(t.entity,"position")),void 0===i&&(i=this.ecs.getComponent(t.entity,"transform"));let n=t._display,s=this.propTypes.get(t.propType);if(void 0===s)throw"Illegal prop type: "+t.propType;this.redrawComponent0(n,s,t.known,e,i)}redrawComponent0(t,e,i,n,s){t.visible=!this.useVisibility||i,t.texture=e.texture,t.position.set(n.x,n.y),t.rotation=s.rotation;let o=this.ecs.getResource("grid");t.scale.set(e.gridSize.x*o.size*s.scale/t.texture.width,e.gridSize.y*o.size*s.scale/t.texture.height)}initCreation(){this.cancelCreation(),this.createPropType=this.defaultPropType;let t=this.propTypes.get(this.createPropType);if(void 0===t)throw"Illegal prop type: "+this.createPropType;this.createProp=this.createSprite(),this.redrawComponent0(this.createProp,t,!0,{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY},{scale:1,rotation:0}),this.display.addChild(this.createProp)}cancelCreation(){void 0!==this.createProp&&(this.createProp.destroy({children:!0,texture:!1,baseTexture:!1}),this.createProp=void 0)}redrawCreation(t){void 0!==this.createProp&&this.createProp.position.set(t.x,t.y)}confirmCreation(t){if(void 0===this.createProp)return;let e=this.ecs.spawnEntity({type:"position",x:t.x,y:t.y},{type:"transform",rotation:0,scale:1},{type:"prop",propType:this.createPropType,_display:this.createProp});this.createProp=void 0,this.phase.changeTool(ce.INSPECT),this.phase.selection.setOnlyEntity(e)}enable(){this.useVisibility="dm"!==this.phase.lightSystem.localLightSettings.visionType,this.displayLayer=new L.a.display.Layer,this.displayLayer.zIndex=st.a.PROP,this.displayLayer.interactive=!1,this.displayLayer.interactiveChildren=!1,this.display=new L.a.Container,this.display.zIndex=st.a.PROP,this.display.interactive=!1,this.display.interactiveChildren=!1,this.display.parentLayer=this.displayLayer,this.phase.board.addChild(this.display),ot.app.stage.addChild(this.displayLayer)}destroy(){this.display.destroy(et.b),this.displayLayer.destroy(et.b)}}class ye extends Rt{constructor(t,e){super(t,e),this.tool=ce.INSPECT,this.isMovingSelection=!1,this.movingStart=new L.a.Point(0,0),this.lastMove=new L.a.Point(0,0),this.isHost=e,this.selection=new Gt(this.ecs)}setupEcs(){this.setupNetworkManager(),super.setupEcs(),this.interactionSystem=new Vt.a(this.ecs,this),this.backgroundSystem=new zt(this.ecs,this),this.textSystem=new oe(this.ecs),this.wallSystem=new se(this.ecs,this),this.doorSystem=new at(this.ecs,this),this.visibilitySystem=new he(this.ecs,this),this.visibilityAwareSystem=new pe.a(this.ecs,this),this.pinSystem=new ne(this.ecs,this),this.propSystem=new me(this.ecs,this),this.lightSystem=new _t.c(this.ecs,this),this.playerSystem=new ue(this.ecs,this),this.ecs.events.on("selection_update",t=>{this.vue.selectedEntityOpts=t.getCommonEntityOpts(),this.vue.selectedComponents=t.getCommonComponents(),this.vue.selectedAddable=t.getAddableComponents()})}setupBoard(){ot.app.stage.sortableChildren=!0,ot.app.stage.addChild(this.board)}setupNetworkManager(){this.networkManager=new Zt(this.isHost),this.networkManager.on("ready",this.onNetworkReady,this),this.networkManager.on("error",this.onNetworkError,this);let t=()=>{this.vue.connectionCount=this.networkManager.channel.connections.length},e=this.networkManager.channel.eventEmitter;e.on("_device_join",t),e.on("_device_left",t),e.on("_buffering_update",()=>{this.vue.connectionBuffering=this.networkManager.channel.bufferingChannels>0})}changeTool(t){let e=this.tool;e===ce.CREATE_WALL?this.wallSystem.endCreation():e===ce.CREATE_PIN?this.pinSystem.cancelCreation():e===ce.CREATE_PROP?this.propSystem.cancelCreation():e===ce.PROP_TELEPORT_LINK&&(this.propSystem.teleportLinkCancel(),document.body.style.cursor="auto"),t!==ce.MOVE&&t!==ce.INSPECT&&this.selection.clear(),t===ce.CREATE_WALL?this.wallSystem.initCreation():t===ce.CREATE_PIN?this.pinSystem.initCreation():t===ce.CREATE_PROP?this.propSystem.initCreation():t===ce.PROP_TELEPORT_LINK&&(document.body.style.cursor="crosshair"),this.tool=t,console.log("Changing tool from "+e+" to "+t),this.uiEventEmitter.emit("changeTool",this.tool)}getMapPointFromMouseInteraction(t,e){let i=t.data.getLocalPosition(this.board,e);if(this.tool===ce.MOVE&&this.selection.hasComponentType("pin")||this.tool==ce.CREATE_PIN)return i;let n=this.interactionSystem.snapDb.findNearest([i.x,i.y]);if(void 0!==n&&n[1]<100)i.set(n[0][0],n[0][1]);else{let t=this.wallSystem.findLocationOnWall(i,50);void 0!==t&&i.copyFrom(t)}return i}onPointerDown(t){if(super.onPointerDown(t),this.tool===ce.MOVE&&(1!==t.data.button||"mouse"!==t.data.pointerType)){this.isDraggingBoard=!1,this.isMovingSelection=!0;let e=this.getMapPointFromMouseInteraction(t);this.movingStart.copyFrom(e),this.lastMove.set(0,0),this.ecs.events.emit("tool_move_begin")}}onPointerMove(t){if(super.onPointerMove(t),this.tool===ce.CREATE_WALL){let e=this.getMapPointFromMouseInteraction(t);this.wallSystem.redrawCreationLastLine(e)}else if(this.isMovingSelection){let e=this.getMapPointFromMouseInteraction(t),i=e.x-this.movingStart.x,n=e.y-this.movingStart.y,s=i-this.lastMove.x,o=n-this.lastMove.y;this.lastMove.set(i,n),this.selection.moveAll(s,o)}else if(this.tool===ce.CREATE_PIN){let e=this.getMapPointFromMouseInteraction(t);this.pinSystem.redrawCreation(e)}else if(this.tool===ce.CREATE_PROP){let e=this.getMapPointFromMouseInteraction(t);this.propSystem.redrawCreation(e)}}onPointerUp(t){super.onPointerUp(t),this.isMovingSelection&&(this.isMovingSelection=!1,this.ecs.events.emit("tool_move_end"))}onPointerUpOutside(t){super.onPointerUpOutside(t)}findEntitiesAt(t,e){let i=ae.b.queryPoint(t,e);return this.ecs.events.emit("query_hit",i),[...i.hits]}onPointerClick(t){super.onPointerClick(t);let e=this.getMapPointFromMouseInteraction(t);if(this.tool===ce.CREATE_WALL)return void this.wallSystem.addVertex(e);if(this.tool===ce.CREATE_PIN)return void this.pinSystem.confirmCreation(e);if(this.tool===ce.CREATE_PROP)return void this.propSystem.confirmCreation(e);if(this.tool===ce.PROP_TELEPORT_LINK){let t=this.interactionSystem.query(Object(Vt.h)(e),t=>void 0!==this.ecs.getComponent(t.entity,"prop"));for(let e of t){let t=this.propSystem.currentLinkTarget;return this.propSystem.teleportLinkTo(e.entity),this.selection.setOnlyEntity(t),void this.changeTool(ce.INSPECT)}}let i=!!t.data.originalEvent.ctrlKey,n=this.findEntitiesAt(e,i);this.tool===ce.INSPECT&&(i?this.selection.toggleEntities(n):0!==n.length?this.selection.setOnlyEntity(n[0]):this.selection.clear())}onNetworkReady(){console.log("Network is ready! "+this.networkManager.isHost),this.networkManager.isHost&&history.replaceState(null,null,"#p"+this.networkManager.peer.id)}onNetworkError(t){console.error("Error from peerjs: ",t.type),"server-error"===t.type?(alert("Error connecting to peerjs instance, you're offline now"),this.isHost||ot.stage.setPhase(new ee.a(new ie.a))):"peer-unavailable"===t.type?(console.log("Invalid invite link"),alert("Invalid invite link"),history.replaceState(null,null," "),this.isHost||ot.stage.setPhase(new ee.a(new ie.a))):"network"===t.ty?alert("Connection lost"):alert(t)}onPointerRightDown(t){if(super.onPointerRightDown(t),this.tool===ce.CREATE_WALL){let e=this.getMapPointFromMouseInteraction(t);this.wallSystem.undoVertex(e)}}ui(){let t=new St;return t.phase=this,t.isAdmin=this.isHost,t}enable(){super.enable(),this.setupBoard(),this.interactionSystem.enable(),this.backgroundSystem.enable(),this.textSystem.enable(),this.wallSystem.enable(),this.doorSystem.enable(),this.visibilitySystem.enable(),this.visibilityAwareSystem.enable(),this.pinSystem.enable(),this.propSystem.enable(),this.lightSystem.enable(),this.playerSystem.enable()}disable(){this.playerSystem.destroy(),this.lightSystem.destroy(),this.propSystem.destroy(),this.pinSystem.destroy(),this.visibilityAwareSystem.destroy(),this.visibilitySystem.destroy(),this.doorSystem.destroy(),this.wallSystem.destroy(),this.textSystem.destroy(),this.backgroundSystem.destroy(),this.interactionSystem.destroy(),super.disable()}}!function(t){t.INSPECT="inspect",t.MOVE="move",t.CREATE_WALL="create_wall",t.CREATE_PIN="create_pin",t.CREATE_PROP="create_prop",t.GRID="grid",t.LIGHT="light",t.PROP_TELEPORT_LINK="prop_teleport_link"}(ce||(ce={}))},,,,,,,,,,,,function(t){t.exports=JSON.parse('{"frames":{"ladder_down.png":{"frame":{"x":0,"y":0,"w":64,"h":64},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":64,"h":64},"sourceSize":{"w":64,"h":64}},"ladder_up.png":{"frame":{"x":64,"y":0,"w":64,"h":64},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":64,"h":64},"sourceSize":{"w":64,"h":64}}},"meta":{"app":"https://www.codeandweb.com/texturepacker","version":"1.0","image":"props.png","format":"RGBA8888","size":{"w":128,"h":64},"scale":"1","smartupdate":"$TexturePacker:SmartUpdate:e4f96f20e593ddd42c4cf1d50d2d8f26:7e60e2d391e00eeed0a16270f3c0f13d:f4c39b94f5b79b4c461da96ae5609d50$"}}')},,function(t,e,i){"use strict";i.d(e,"a",(function(){return a}));class n{constructor(t,e,i){this.left=void 0,this.right=void 0,this.point=t,this.parent=e,this.dimension=i}}class s{constructor(){this.root=void 0}distance(t,e){let i=t[0]-e[0],n=t[1]-e[1];return i*i+n*n}lastSearch(t,e,i){for(;void 0!==e;)i=e,e=t[e.dimension]<e.point[e.dimension]?e.left:e.right;return i}nodeSearch(t){let e=this.root;for(;void 0!==e;){if(t[0]===e.point[0]&&t[1]===e.point[1])return e;e=t[e.dimension]<e.point[e.dimension]?e.left:e.right}}insert(t){let e=this.lastSearch(t,this.root,void 0);if(void 0===e)return void(this.root=new n(t,void 0,0));let i=new n(t,e,e.dimension+1&1),s=e.dimension;t[s]<e.point[s]?e.left=i:e.right=i}findMin(t,e){if(void 0===t)return;if(t.dimension===e)return void 0!==t.left?this.findMin(t.left,e):t;let i=t.point[e],n=this.findMin(t.left,e),s=this.findMin(t.right,e),o=t;return void 0!==n&&n.point[e]<i&&(o=n),void 0!==s&&s.point[e]<o.point[e]&&(o=s),o}removeNode(t){if(void 0!==t.left||void 0!==t.right)if(void 0!==t.right){let e=this.findMin(t.right,t.dimension),i=e.point;this.removeNode(e),t.point=i}else{let e=this.findMin(t.left,t.dimension),i=e.point;this.removeNode(e),t.right=t.left,t.left=void 0,t.point=i}else{if(void 0===t.parent)return void(this.root=void 0);let e=t.parent.dimension;t.point[e]<t.parent.point[e]?t.parent.left=void 0:t.parent.right=void 0}}remove(t){let e=this.nodeSearch(t);return void 0!==e&&(this.removeNode(e),!0)}nearestPoint(t,e){if(void 0===(e=e||this.root))return;let i,n=this.distance(e.point,t);if(void 0===e.left&&void 0===e.right)return[e.point,n];i=void 0===e.right?e.left:void 0===e.left?e.right:t[e.dimension]<e.point[e.dimension]?e.left:e.right;let s,o,[a,r]=this.nearestPoint(t,i);r<n?(s=a,o=r):(s=e.point,o=n);let l=[t[0],t[1]];if(l[e.dimension]=e.point[e.dimension],this.distance(l,t)<o){let n;if(n=i===e.left?e.right:e.left,void 0!==n){let[e,i]=this.nearestPoint(t,n);i<o&&(s=e,o=i)}}return[s,o]}}var o=i(12);class a{constructor(t){this.counter=new Map,this.tree=new s,this.count=0,this.grid=t}insert(t){let e=t[0]+"|"+t[1],i=this.counter.get(e)||0;this.counter.set(e,i+1),0==i&&this.tree.insert(t),this.count++}remove(t){let e=t[0]+"|"+t[1],i=(this.counter.get(e)||0)-1;if(0==i)this.counter.delete(e),this.tree.remove(t)||console.error("Failed to remove node: "+t);else{if(!(i>0))return!1;this.counter.set(e,i)}return this.count--,!0}findNearest(t){let e=this.tree.nearestPoint(t),i=void 0;if(void 0!==this.grid&&(i=this.grid.closestPoint(t)),void 0!==i){let n=Object(o.a)(t[0],t[1],i[0],i[1]);if(void 0===e||n<e[1])return[i,n]}return e}}},,,,,,,,,,function(t,e,i){"use strict";var n=i(32);i.n(n).a},function(t,e,i){var n=i(18),s=i(49),o=i(67);e=n(!1);var a=s(o);e.push([t.i,"\n.credits[data-v-539f2bff] {\n    text-align: right;\n    padding: 20px;\n}\n.github[data-v-539f2bff] {\n    display: inline-block;\n    width: 32px;\n    height: 32px;\n    background-image: url("+a+");\n}\n.github[data-v-539f2bff]:hover {\n    opacity: 0.5;\n}\n.profile[data-v-539f2bff] {\n    color: white;\n}\n.profile[data-v-539f2bff]:hover {\n    opacity: 0.5;\n}\n\n",""]),t.exports=e},function(t,e,i){"use strict";i.r(e),e.default=i.p+"266ca63177bca6f330a74e83fdc63178.png"},function(t,e,i){"use strict";var n=i(33);i.n(n).a},function(t,e,i){(e=i(18)(!1)).push([t.i,"\n.btn-entry[data-v-d8550b4a] {\n    margin-bottom: 10px;\n}\n\n",""]),t.exports=e},,,,,function(t,e,i){"use strict";var n=i(34);i.n(n).a},function(t,e,i){(e=i(18)(!1)).push([t.i,"\n.component-header[data-v-03d324d6] {\n    display: flex;\n    align-items: center;\n    margin-left: 5px;\n    margin-bottom: 2px;\n}\n.component-header button[data-v-03d324d6]:last-child {\n    margin-right: 10px;\n}\n.component-body[data-v-03d324d6] {\n    margin-left: 12px;\n    margin-right: 12px;\n}\n.g11[data-v-03d324d6] {\n    grid-row: 1;\n    grid-column: 1;\n}\n",""]),t.exports=e},function(t,e,i){"use strict";var n=i(35);i.n(n).a},function(t,e,i){(e=i(18)(!1)).push([t.i,"\n.component-btn-header[data-v-c407dbfa] {\n    margin: 0.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: right;\n}\n.g11[data-v-c407dbfa] {\n    grid-column: 1;\n    grid-row: 1;\n}\n",""]),t.exports=e},function(t,e,i){"use strict";var n=i(36);i.n(n).a},function(t,e,i){(e=i(18)(!1)).push([t.i,"\n.game[data-v-53b46051] {\n    user-select: none;\n}\n.toolbar-btn[data-v-53b46051] {\n    color: #fff;\n    background-color: #2C3E50;\n    border-color: #2C3E50;\n}\n.sidebar-footer[data-v-53b46051] {\n    display: flex;\n    align-items: center;\n    justify-content: right;\n}\n",""]),t.exports=e},function(t,e){function i(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}i.keys=function(){return[]},i.resolve=i,t.exports=i,i.id=80},,,,,,,,,,,,,,,,,,,function(t,e,i){var n=i(100);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(22).default)("511f390e",n,!1,{})},function(t,e,i){var n=i(18),s=i(101),o=i(102);(e=n(!1)).push([t.i,"@import url(https://fonts.googleapis.com/css2?family=Merienda+One&display=swap);"]),e.i(s),e.i(o),e.push([t.i,":root {\n    --topbar-height: 40px;\n}\n\n* {\n    font-family: 'Merienda One', cursive;\n}\n\nbody {\n    color: white;\n\n    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAPklEQVQoU2NkYGAwZmBgOMsAASD2cwYGhmcwPiOUIcXAwCCJpBDOhynA0AkzCaQA2QoMk0AKQIJwO+nvBmMAk2YWvDhYBRoAAAAASUVORK5CYII=);\n    background-color: #6e472c !important;\n}\n\n.phase-container {\n}\n\n\n@media screen and (max-height: 890px) {\n    .footer {\n        position: static;\n    }\n}\n\n@media screen and (min-height: 890px) {\n    .footer {\n        position: fixed;\n        bottom: 0;\n    }\n}\n\n.under-navbar {\n    margin-top: var(--topbar-height) !important;\n}\n\ndiv.under-navbar {\n    margin-top: var(--topbar-height) !important;\n}\n\n.b-sidebar.under-navbar {\n    height: calc(100vh - var(--topbar-height));\n}\n\n.footer, .game-footer {\n    width: 100%;\n    background-color: rgba(0, 0, 0, 0.25);\n}\n\n.btn-xs {\n    padding: .25rem .4rem;\n    font-size: .875rem;\n    line-height: .5;\n    border-radius: .2rem;\n}\n\n.modal-fullscreen {\n    height: 92%;\n}\n.modal-fullscreen .modal-content {\n    height: 100%;\n}\n.modal-xxl {\n    width: 92% !important;\n    max-width: 92% !important;\n}\n\n#canvas-container canvas {\n    vertical-align: top;\n}\n\n.rotate {\n    animation: rotation 1s infinite linear;\n}\n\n/** ANIMATIONS **/\n\n@keyframes rotation {\n    from {\n        transform: rotate(0deg);\n    }\n    to {\n        transform: rotate(359deg);\n    }\n}\n\n\n",""]),t.exports=e}]);
!function(t){function e(e){for(var n,r,a=e[0],l=e[1],d=e[2],c=0,p=[];c<a.length;c++)r=a[c],Object.prototype.hasOwnProperty.call(o,r)&&o[r]&&p.push(o[r][0]),o[r]=0;for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(t[n]=l[n]);for(h&&h(e);p.length;)p.shift()();return s.push.apply(s,d||[]),i()}function i(){for(var t,e=0;e<s.length;e++){for(var i=s[e],n=!0,a=1;a<i.length;a++){var l=i[a];0!==o[l]&&(n=!1)}n&&(s.splice(e--,1),t=r(r.s=i[0]))}return t}var n={},o={0:0},s=[];function r(e){if(n[e])return n[e].exports;var i=n[e]={i:e,l:!1,exports:{}};return t[e].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=n,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="";var a=window.webpackJsonp=window.webpackJsonp||[],l=a.push.bind(a);a.push=e,a=a.slice();for(var d=0;d<a.length;d++)e(a[d]);var h=l;s.push([76,1]),i()}([,,,,,,,,,,,,,function(t,e,i){var n=i(39);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("7c681468",n,!1,{})},function(t,e,i){var n=i(42);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("6123dedb",n,!1,{})},function(t,e,i){var n=i(48);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("20adba36",n,!1,{})},function(t,e,i){var n=i(50);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("0e8a47b6",n,!1,{})},function(t,e,i){var n=i(52);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("cf98b6ba",n,!1,{})},,,,,,,,,,,,,,,,,,,,,function(t,e,i){"use strict";var n=i(13);i.n(n).a},function(t,e,i){var n=i(6),o=i(25),s=i(40);e=n(!1);var r=o(s);e.push([t.i,"\n.credits[data-v-539f2bff] {\n    text-align: right;\n    padding: 20px;\n}\n.github[data-v-539f2bff] {\n    display: inline-block;\n    width: 32px;\n    height: 32px;\n    background-image: url("+r+");\n}\n.github[data-v-539f2bff]:hover {\n    opacity: 0.5;\n}\n.profile[data-v-539f2bff] {\n    color: white;\n}\n.profile[data-v-539f2bff]:hover {\n    opacity: 0.5;\n}\n\n",""]),t.exports=e},function(t,e,i){"use strict";i.r(e),e.default=i.p+"266ca63177bca6f330a74e83fdc63178.png"},function(t,e,i){"use strict";var n=i(14);i.n(n).a},function(t,e,i){(e=i(6)(!1)).push([t.i,"\n.btn-entry[data-v-d8550b4a] {\n    margin-bottom: 10px;\n}\n\n",""]),t.exports=e},,,,,function(t,e,i){"use strict";var n=i(15);i.n(n).a},function(t,e,i){(e=i(6)(!1)).push([t.i,"\n.component-header[data-v-03d324d6] {\n    display: flex;\n    align-items: center;\n    margin-left: 5px;\n    margin-bottom: 2px;\n}\n.component-header button[data-v-03d324d6]:last-child {\n    margin-right: 10px;\n}\n.component-body[data-v-03d324d6] {\n    margin-left: 12px;\n    margin-right: 12px;\n}\n.g11[data-v-03d324d6] {\n    grid-row: 1;\n    grid-column: 1;\n}\n",""]),t.exports=e},function(t,e,i){"use strict";var n=i(16);i.n(n).a},function(t,e,i){(e=i(6)(!1)).push([t.i,"\n.component-btn-header[data-v-c407dbfa] {\n    margin: 0.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: right;\n}\n.g11[data-v-c407dbfa] {\n    grid-column: 1;\n    grid-row: 1;\n}\n",""]),t.exports=e},function(t,e,i){"use strict";var n=i(17);i.n(n).a},function(t,e,i){(e=i(6)(!1)).push([t.i,"\n.game[data-v-53b46051] {\n    user-select: none;\n}\n.toolbar-btn[data-v-53b46051] {\n    color: #fff;\n    background-color: #2C3E50;\n    border-color: #2C3E50;\n}\n.sidebar-footer[data-v-53b46051] {\n    display: flex;\n    align-items: center;\n    justify-content: right;\n}\n",""]),t.exports=e},function(t,e){function i(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}i.keys=function(){return[]},i.resolve=i,t.exports=i,i.id=53},,,,,,,,,,,,,,,,,,,function(t,e,i){var n=i(73);"string"==typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);(0,i(8).default)("511f390e",n,!1,{})},function(t,e,i){var n=i(6),o=i(74),s=i(75);(e=n(!1)).push([t.i,"@import url(https://fonts.googleapis.com/css2?family=Merienda+One&display=swap);"]),e.i(o),e.i(s),e.push([t.i,":root {\n    --topbar-height: 40px;\n}\n\n* {\n    font-family: 'Merienda One', cursive;\n}\n\nbody {\n    color: white;\n\n    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAPklEQVQoU2NkYGAwZmBgOMsAASD2cwYGhmcwPiOUIcXAwCCJpBDOhynA0AkzCaQA2QoMk0AKQIJwO+nvBmMAk2YWvDhYBRoAAAAASUVORK5CYII=);\n    background-color: #6e472c !important;\n}\n\n.phase-container {\n}\n\n\n@media screen and (max-height: 890px) {\n    .footer {\n        position: static;\n    }\n}\n\n@media screen and (min-height: 890px) {\n    .footer {\n        position: fixed;\n        bottom: 0;\n    }\n}\n\n.under-navbar {\n    margin-top: var(--topbar-height) !important;\n}\n\ndiv.under-navbar {\n    margin-top: var(--topbar-height) !important;\n}\n\n.b-sidebar.under-navbar {\n    height: calc(100vh - var(--topbar-height));\n}\n\n.footer, .game-footer {\n    width: 100%;\n    background-color: rgba(0, 0, 0, 0.25);\n}\n\n.btn-xs {\n    padding: .25rem .4rem;\n    font-size: .875rem;\n    line-height: .5;\n    border-radius: .2rem;\n}\n\n.modal-fullscreen {\n    height: 92%;\n}\n.modal-fullscreen .modal-content {\n    height: 100%;\n}\n.modal-xxl {\n    width: 92% !important;\n    max-width: 92% !important;\n}\n\n#canvas-container canvas {\n    vertical-align: top;\n}\n\n.rotate {\n    animation: rotation 1s infinite linear;\n}\n\n/** ANIMATIONS **/\n\n@keyframes rotation {\n    from {\n        transform: rotate(0deg);\n    }\n    to {\n        transform: rotate(359deg);\n    }\n}\n\n\n",""]),t.exports=e},,,function(t,e,i){"use strict";i.r(e),i.d(e,"windowEventEmitter",(function(){return he})),i.d(e,"app",(function(){return ce})),i.d(e,"stage",(function(){return pe}));var n=i(3),o=i(7);class s{constructor(t){this.name=t,this.uiEventEmitter=new o}log(t){console.log(`[${this.name}] `+t)}ui(){}enable(){this.log("Enabling"),n.default.prototype.eventEmitter=this.uiEventEmitter,this.vue=this.ui(),this.vue&&(this.vue.$mount(),document.body.appendChild(this.vue.$el))}disable(){console.log(`[${this.name}] Disabling`),this.vue&&document.body.removeChild(this.vue.$el)}get[Symbol.toStringTag](){return"ObjectNoObserve"}}var r=i(1),a=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"phase-container text-center"},[t._m(0),t._v(" "),i("div",[i("b-button",{staticClass:"btn-entry",attrs:{variant:"warning",size:"lg"},on:{click:t.onCreateMap}},[t._v("Create Map")])],1),t._v(" "),i("div",[i("b-button",{staticClass:"btn-entry",attrs:{variant:"info",size:"lg"},on:{click:t.onEditMap}},[t._v("Edit Map")])],1),t._v(" "),i("b-modal",{ref:"map-load-modal",attrs:{"hide-footer":"",title:"Gimme the map"}},[i("b-form-file",{attrs:{state:Boolean(t.file),placeholder:"Choose a file or drop it here...","drop-placeholder":"Drop file here...",accept:".dndm"},model:{value:t.file,callback:function(e){t.file=e},expression:"file"}})],1),t._v(" "),i("footer-component")],1)};a._withStripped=!0;var l=function(){var t=this.$createElement;this._self._c;return this._m(0)};l._withStripped=!0;var d=n.default.extend({}),h=(i(38),i(2)),c=Object(h.a)(d,l,[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"footer"},[e("div",{staticClass:"credits"},[e("div",{staticClass:"links"},[e("a",{staticClass:"github",attrs:{href:"https://github.com/SnowyCoder/dndme",target:"_blank"}})]),this._v(" "),e("small",{staticStyle:{color:"lightgray"}},[this._v("\n            Developed by "),e("a",{staticClass:"profile",attrs:{href:"https://github.com/SnowyCoder",target:"_blank"}},[this._v("Rossi Lorenzo")]),this._v(" /\n            Drawings by "),e("span",{staticStyle:{color:"white"}},[this._v("Giorgia Nizzoli")])])])])}],!1,null,"539f2bff",null);c.options.__file="src/app/ui/footer.vue";var p=c.exports,m=function(){var t=this.$createElement,e=this._self._c||t;return e("b-modal",{ref:"my-modal",attrs:{"hide-footer":"",title:"Gimme the map"}},[e("div",{staticClass:"d-block text-center"},[e("h3",[this._v("Insert map to load")])]),this._v(" "),e("b-button",{staticClass:"mt-3",attrs:{variant:"outline-danger",block:""},on:{click:this.hideModal}},[this._v("Cancel")])],1)};m._withStripped=!0;var u={name:"mapInput",data:()=>({file:null}),methods:{onDrop:function(t){},hideModal:function(t){this.$emit("close")}}},f=Object(h.a)(u,m,[],!1,null,"7e9d406c",null);f.options.__file="src/app/ui/home/mapInput.vue";var y=f.exports,v=n.default.extend({data:()=>({file:null,pendingOp:""}),components:{MapInput:y,FooterComponent:p},methods:{onCreateMap(){this.eventEmitter.emit("create_map")},onEditMap(){this.pendingOp="edit",this.$refs["map-load-modal"].show(),this.eventEmitter.emit("edit_map")},mapLoadCancel(){this.$refs["map-load-modal"].hide()}},watch:{file:function(t){null!=t&&(console.log("File dropped, loading: "+this.pendingOp),this.eventEmitter.emit(this.pendingOp,this.file),this.file=null,this.mapLoadCancel())}}}),g=(i(41),Object(h.a)(v,a,[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title-container"},[e("h1",{staticClass:"title h1"},[this._v("DrawNDice")]),this._v(" "),e("p",{},[this._v("Dnd made ez!")])])}],!1,null,"d8550b4a",null));g.options.__file="src/app/ui/home/home.vue";var b=g.exports;class w{constructor(t){this.id=t}loadInto(t){t.clear(),void 0!==this.ecs&&t.deserialize(this.ecs)}saveFrom(t){this.ecs=void 0,this.ecs=t.serialize()}serialize(){return{name:this.name,ecs:this.ecs}}static deserialize(t,e){let i=new w(t);return i.name=e.name,i.ecs=e.ecs,i}}var _=i(21),C=i(20),E=i.n(C),x=function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function r(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class S{constructor(){this.levels=new Map}createDataJson(){let t={};for(let[e,i]of this.levels.entries())t[e]=i.serialize();let e={version:S.SER_VERSION,levels:t};return Object(_.encode)(e)}saveToFile(){let t=this.createDataJson(),e=new E.a;return e.file("data.msgpack",t),e.generateAsync({type:"blob"})}static loadFromFile(t){return x(this,void 0,void 0,(function*(){let e=yield E.a.loadAsync(t),i=yield e.file("data.msgpack").async("arraybuffer"),n=yield Object(_.decode)(i);if(n.version!==this.SER_VERSION)throw"Version not supported";let o=new S,s=n.levels;for(let t in s){let e=s[t],i=yield w.deserialize(parseInt(t),e);o.levels.set(i.id,i)}return o}))}}S.SER_VERSION="1.0";var M=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"game"},[i("b-button-toolbar",{staticClass:"bg-dark",staticStyle:{width:"100%",height:"var(--topbar-height)","z-index":"1000"},attrs:{type:"dark",variant:"info",justify:""}},[t.isAdmin?i("b-button-group",{staticStyle:{"margin-right":"2rem"}},[i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Undo",squared:""}},[i("i",{staticClass:"fas fa-undo"})]),t._v(" "),i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Redo",squared:"",disabled:""}},[i("i",{staticClass:"fas fa-redo"})])],1):t._e(),t._v(" "),i("b-button-group",[i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Inspect",squared:""},on:{click:function(e){return t.changeTool("inspect")}}},[i("i",{staticClass:"fas fa-hand-pointer"})]),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Move",squared:""},on:{click:function(e){return t.changeTool("move")}}},[i("i",{staticClass:"fas fa-arrows-alt"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Add room",squared:""},on:{click:function(e){return t.changeTool("create_room")}}},[i("i",{staticClass:"fas fa-plus"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Add pin",squared:""},on:{click:function(e){return t.changeTool("create_pin")}}},[i("i",{staticClass:"fas fa-thumbtack"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticClass:"toolbar-btn",attrs:{title:"Edit grid",squared:""},on:{click:function(e){return t.changeTool("grid")}}},[i("i",{staticClass:"fas fa-border-all"})]):t._e()],1),t._v(" "),t.isAdmin?i("b-button",{staticClass:"btn-xs",attrs:{title:"Export map",squared:"",variant:"success"},on:{click:function(e){return t.phase.exportMap()}}},[i("i",{staticClass:"fas fa-download"})]):t._e(),t._v(" "),i("div",{staticStyle:{flex:"1 1 0"}}),t._v(" "),i("b-button",{directives:[{name:"b-toggle",rawName:"v-b-toggle.sidebar-right",modifiers:{"sidebar-right":!0}}],staticClass:"btn-xs",attrs:{title:"Toggle sidebar",variant:"warning"}},[i("i",{staticClass:"fas fa-angle-double-right"})])],1),t._v(" "),i("div",{staticStyle:{width:"100%",height:"calc(100vh - var(--topbar-height))"},attrs:{id:"canvas-container"}}),t._v(" "),i("b-sidebar",{attrs:{id:"sidebar-right",title:"Sidebar","bg-variant":"dark","text-variant":"light",right:"",visible:"","no-header":"",shadow:"","sidebar-class":"under-navbar"},scopedSlots:t._u([{key:"footer",fn:function(){return[i("div",{staticClass:"sidebar-footer"},[t._v("\n                "+t._s(t.connectionCount)+"\n                "),i("div",{class:{rotate:t.connectionBuffering},staticStyle:{"margin-left":"0.2rem"}},[i("i",{staticClass:"fas fa-sync-alt"})])])]},proxy:!0}])},[i("div",{directives:[{name:"show",rawName:"v-show",value:"grid"===t.tool,expression:"tool === 'grid'"}],staticClass:"px-3 py-2"},[t._v("\n            Type:\n            "),i("b-radio-group",{attrs:{id:"grid-type-radio",buttons:""},model:{value:t.grid.type,callback:function(e){t.$set(t.grid,"type",e)},expression:"grid.type"}},[i("b-radio",{attrs:{value:"none"}},[i("i",{staticClass:"fas fa-border-none"})]),t._v(" "),i("b-radio",{attrs:{value:"square"}},[i("i",{staticClass:"far fa-square"})]),t._v(" "),i("b-radio",{attrs:{value:"hex"}},[i("svg",{staticClass:"svg-inline--fa fa-hexagon fa-w-18",attrs:{role:"img",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 576 512"}},[i("path",{attrs:{fill:"currentColor",d:"M441.5 39.8C432.9 25.1 417.1 16 400 16H176c-17.1 0-32.9 9.1-41.5 23.8l-112 192c-8.7 14.9-8.7 33.4 0 48.4l112 192c8.6 14.7 24.4 23.8 41.5 23.8h224c17.1 0 32.9-9.1 41.5-23.8l112-192c8.7-14.9 8.7-33.4 0-48.4l-112-192zM400 448H176L64 256 176 64h224l112 192-112 192z"}})])])],1),t._v(" "),"none"!==t.grid.type?i("div",[i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Size:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"10",max:"512",size:"sm"},model:{value:t.grid.size,callback:function(e){t.$set(t.grid,"size",e)},expression:"grid.size"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"10",max:"512"},model:{value:t.grid.size,callback:function(e){t.$set(t.grid,"size",e)},expression:"grid.size"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",[t._v("Xoffset:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"0",max:"1",step:"0.001",size:"sm"},model:{value:t.grid.offX,callback:function(e){t.$set(t.grid,"offX",e)},expression:"grid.offX"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"0",max:"1",step:"0.001"},model:{value:t.grid.offX,callback:function(e){t.$set(t.grid,"offX",e)},expression:"grid.offX"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Yoffset:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"0",max:"1",step:"0.001",size:"sm"},model:{value:t.grid.offY,callback:function(e){t.$set(t.grid,"offY",e)},expression:"grid.offY"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"0",max:"1",step:"0.001"},model:{value:t.grid.offY,callback:function(e){t.$set(t.grid,"offY",e)},expression:"grid.offY"}}),t._v("\n\n                Color: "+t._s(t.grid.color)+"\n                "),i("b-input",{attrs:{type:"color"},model:{value:t.grid.color,callback:function(e){t.$set(t.grid,"color",e)},expression:"grid.color"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Opacity:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"0",max:"1",step:"0.001",size:"sm"},model:{value:t.grid.opacity,callback:function(e){t.$set(t.grid,"opacity",e)},expression:"grid.opacity"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"0",max:"1",step:"0.001"},model:{value:t.grid.opacity,callback:function(e){t.$set(t.grid,"opacity",e)},expression:"grid.opacity"}}),t._v(" "),i("div",{staticClass:"d-flex flex-row align-items-center"},[i("div",{},[t._v("Width:")]),t._v(" "),i("div",{staticClass:"p-2"},[i("b-input",{attrs:{type:"number",min:"1",max:"200",size:"sm"},model:{value:t.grid.width,callback:function(e){t.$set(t.grid,"width",e)},expression:"grid.width"}})],1)]),t._v(" "),i("b-input",{attrs:{type:"range",min:"1",max:"200"},model:{value:t.grid.width,callback:function(e){t.$set(t.grid,"width",e)},expression:"grid.width"}})],1):t._e()],1),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:"inspect"===t.tool,expression:"tool === 'inspect'"}]},[i("entity-inspect",{attrs:{components:this.selectedComponents,entity:this.selectedEntityOpts,isAdmin:t.isAdmin},on:{"ecs-property-change":t.onEcsPropertyChange}})],1)]),t._v(" "),i("a",{staticStyle:{display:"none"},attrs:{id:"hidden-download-link"}})],1)};M._withStripped=!0;const R={color:0,width:10,opacity:.75,size:100,offX:0,offY:0};var T;!function(t){t[t.SQUARE=0]="SQUARE",t[t.HEXAGON=1]="HEXAGON"}(T||(T={}));var I=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{directives:[{name:"show",rawName:"v-show",value:t.components.length>0,expression:"components.length > 0"}]},[i("div",{staticClass:"component-btn-header"},[t.isAdmin?i("b-dropdown",{attrs:{"toggle-class":"rounded-0",variant:"success"},scopedSlots:t._u([{key:"button-content",fn:function(){return[i("i",{staticClass:"fas fa-plus"})]},proxy:!0}],null,!1,1774554641)},[t._v(" "),i("b-dropdown-item",{on:{click:function(e){return t.emitSpecial("addComponent","name")}}},[t._v("Name")]),t._v(" "),i("b-dropdown-item",{on:{click:function(e){return t.emitSpecial("addComponent","note")}}},[t._v("Note")])],1):t._e(),t._v(" "),t.isAdmin?i("b-button",{staticStyle:{display:"grid"},attrs:{squared:"",title:t.entity.hidden?"Show entity":"Hide entity"},on:{click:function(e){return t.emitSpecial("hidden",!t.entity.hidden)}}},[i("div",{staticClass:"g11",style:{visibility:t.entity.hidden?"visible":"hidden"}},[i("i",{staticClass:"fas fa-eye-slash"})]),t._v(" "),i("div",{staticClass:"g11",style:{visibility:t.entity.hidden?"hidden":"visible"}},[i("i",{staticClass:"fas fa-eye"})])]):t._e(),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:t.entity.forgettable,expression:"entity.forgettable"}],attrs:{variant:"danger",title:"Forget",squared:""},on:{click:function(e){return t.emitSpecial("forget")}}},[i("i",{staticClass:"fas fa-eraser"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{attrs:{variant:"danger",title:"Delete entity",squared:""},on:{click:function(e){return t.emitSpecial("delete")}}},[i("i",{staticClass:"fas fa-trash"})]):t._e()],1),t._v(" "),t._l(t.components,(function(e){return i("ecs-component-wrapper",{key:e.type+(e.multiId||""),attrs:{component:e,isAdmin:t.isAdmin},on:{"ecs-property-change":function(e){return t.$emit("ecs-property-change",arguments[0],arguments[1],arguments[2],arguments[3])}}})}))],2)};I._withStripped=!0;var P=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",[i("div",{staticClass:"component-header"},[i("div",{staticStyle:{width:"100%"},on:{click:function(e){t.visible=!t.visible}}},[t._v(" "+t._s(t.component.type)+" ")]),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:void 0!==t.component.clientVisible,expression:"component.clientVisible !== undefined"}],staticStyle:{display:"grid"},attrs:{squared:"",size:"sm",title:t.component.clientVisible?"Hide component":"Show component"},on:{click:function(e){return t.$emit("ecs-property-change",t.component.type,"clientVisible",!t.component.clientVisible)}}},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.component.clientVisible,expression:"component.clientVisible"}],staticClass:"g11"},[i("i",{staticClass:"fas fa-eye"})]),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:!t.component.clientVisible,expression:"!component.clientVisible"}],staticClass:"g11"},[i("i",{staticClass:"fas fa-eye-slash"})])]):t._e(),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:void 0!==t.component._isFullscreen,expression:"component._isFullscreen !== undefined"}],attrs:{squared:"",size:"sm",variant:"primary",title:"Fullscreen"},on:{click:function(e){t.component._isFullscreen=!0}}},[i("i",{staticClass:"fas fa-expand"})]):t._e(),t._v(" "),t.isAdmin?i("b-button",{directives:[{name:"show",rawName:"v-show",value:t.component._canDelete,expression:"component._canDelete"}],attrs:{squared:"",size:"sm",variant:"danger",title:"Delete"},on:{click:function(e){return t.$emit("ecs-property-change","$","removeComponent",t.component.type,t.component.multiId)}}},[i("i",{staticClass:"fas fa-trash"})]):t._e()],1)]),t._v(" "),i("b-collapse",{staticClass:"component-body",attrs:{visible:""},model:{value:t.visible,callback:function(e){t.visible=e},expression:"visible"}},[i(t.componentType,{tag:"component",attrs:{component:t.component,isAdmin:t.isAdmin},on:{"ecs-property-change":function(e){return t.$emit("ecs-property-change",arguments[0],arguments[1],arguments[2],arguments[3])}}})],1)],1)};P._withStripped=!0;var A=function(){var t=this,e=t.$createElement;return(t._self._c||e)("b-input",{attrs:{readonly:!t.isAdmin,placeholder:"Entity name"},on:{change:t.onChange},model:{value:t.component.name,callback:function(e){t.$set(t.component,"name",e)},expression:"component.name"}})};A._withStripped=!0;var k={name:"ecs-name",props:["component","isAdmin"],data:function(){return{name:this.component.name}},watch:{"component.name":function(t){this.name=t}},methods:{onChange:function(){this.$emit("ecs-property-change","name","name",this.name,this.component.multiId)}}},O=Object(h.a)(k,A,[],!1,null,"3e768912",null);O.options.__file="src/app/ui/ecs/ecsName.vue";var D=O.exports,N=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("b-textarea",{attrs:{placeholder:"Write something here...",readonly:!t.isAdmin},on:{change:t.onChange},model:{value:t.note,callback:function(e){t.note=e},expression:"note"}}),t._v(" "),i("b-modal",{attrs:{title:"Note","dialog-class":"modal-fullscreen modal-xxl","hide-footer":"","hide-header":""},scopedSlots:t._u([{key:"modal-footer",fn:function(){},proxy:!0}]),model:{value:t.component._isFullscreen,callback:function(e){t.$set(t.component,"_isFullscreen",e)},expression:"component._isFullscreen"}},[i("b-textarea",{staticStyle:{height:"100%",resize:"none"},attrs:{placeholder:"Write something here...",readonly:!t.isAdmin},on:{change:t.onChange},model:{value:t.note,callback:function(e){t.note=e},expression:"note"}})],1)],1)};N._withStripped=!0;var z={name:"ecs-note",props:["component","isAdmin"],data:function(){return{note:this.component.note,console:console}},watch:{"component.note":function(t){this.note=t}},methods:{onChange:function(){this.$emit("ecs-property-change","note","note",this.note,this.component.multiId)}}},B=Object(h.a)(z,N,[],!1,null,"2effb2f9",null);B.options.__file="src/app/ui/ecs/ecsNote.vue";var F=B.exports,j=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        X: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(t._s(t.x))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"0.001",size:"sm"},on:{change:t.onChange},model:{value:t.x,callback:function(e){t.x=e},expression:"x"}}):t._e()],1),t._v(" "),i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        Y: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(" "+t._s(t.y))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"0.001",size:"sm"},on:{change:t.onChange},model:{value:t.y,callback:function(e){t.y=e},expression:"y"}}):t._e()],1)])};j._withStripped=!0;var Y={name:"ecs-position",props:["component","isAdmin"],data:function(){return{x:this.component.x,y:this.component.y}},methods:{onChange:function(){this.component.x!==this.x&&""!==this.x&&this.$emit("ecs-property-change","position","x",parseFloat(this.x)),this.component.y!==this.y&&""!==this.y&&this.$emit("ecs-property-change","position","y",parseFloat(this.y))}},watch:{"component.x":function(t){this.x=t},"component.y":function(t){this.y=t}}},X=Object(h.a)(Y,j,[],!1,null,"e81e4da0",null);X.options.__file="src/app/ui/ecs/ecsPosition.vue";var $=X.exports,U=function(){var t=this,e=t.$createElement;return(t._self._c||e)("b-button",{on:{click:function(e){return t.$emit("ecs-property-change","room","visible",!t.component.visible)}}},[t._v("\n    "+t._s(t.component.visible?"Hide room":"Show room")+"\n")])};U._withStripped=!0;var L={name:"ecs-room",props:["component"]},V=Object(h.a)(L,U,[],!1,null,"7326313c",null);V.options.__file="src/app/ui/ecs/ecsRoom.vue";var H=V.exports,q=function(){var t=this.$createElement;return(this._self._c||t)("span",[this._v("Your regular background image")])};q._withStripped=!0;var G={name:"ecs-background-image",props:["component"]},W=Object(h.a)(G,q,[],!1,null,"5efd7016",null);W.options.__file="src/app/ui/ecs/ecsBackgroundImage.vue";var K=W.exports,J=function(){var t=this,e=t.$createElement;return(t._self._c||e)("b-input",{attrs:{type:"color",readonly:!t.isAdmin},on:{change:t.onChange},model:{value:t.color,callback:function(e){t.color=e},expression:"color"}})};J._withStripped=!0;var Q={name:"ecs-pin",props:["component","isAdmin"],data:function(){return{color:"#"+this.component.color.toString(16).padEnd(6,"0")}},methods:{onChange:function(){if(this.component.color!==this.color&&""!==this.color){let t=parseInt(this.color.substring(1),16);this.$emit("ecs-property-change","pin","color",t)}}},watch:{"component.color":function(t){this.color="#"+t.toString(16).padEnd(6,"0")}}},Z=Object(h.a)(Q,J,[],!1,null,"26d88e5e",null);Z.options.__file="src/app/ui/ecs/ecsPin.vue";var tt=Z.exports,et=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticStyle:{display:"flex","align-items":"center"}},[t._v("\n        Angle: "),t.isAdmin?t._e():i("span",{staticStyle:{"margin-left":"0.5rem"}},[t._v(t._s(t.rotation))]),t._v(" "),t.isAdmin?i("b-input",{attrs:{type:"number",step:"0.001",size:"sm"},on:{change:t.onChange},model:{value:t.rotation,callback:function(e){t.rotation=e},expression:"rotation"}}):t._e()],1)])};et._withStripped=!0;var it={name:"ecs-position",props:["component","isAdmin"],data:function(){return{rotation:this.component.rotation}},methods:{onChange:function(){if(""===this.rotation)return;let t=Math.min(Math.max(parseFloat(this.rotation),0),360);this.component.rotation!==t&&this.$emit("ecs-property-change","transform","rotation",t)}},watch:{"component.rotation":function(t){this.rotation=t}}},nt=Object(h.a)(it,et,[],!1,null,"4ee87bf5",null);nt.options.__file="src/app/ui/ecs/ecsTransform.vue";var ot={name:"ecs-component-wrapper",props:["component","isAdmin"],data:function(){return{visible:!0}},computed:{componentType:function(){return"ecs-"+this.component.type.replace("_","-")}},components:{ecsName:D,ecsNote:F,ecsPosition:$,ecsRoom:H,ecsBackgroundImage:K,ecsPin:tt,ecsTransform:nt.exports}},st=(i(47),Object(h.a)(ot,P,[],!1,null,"03d324d6",null));st.options.__file="src/app/ui/ecs/compWrapper.vue";var rt={name:"entity-inspect",components:{EcsComponentWrapper:st.exports},props:["entity","components","isAdmin"],methods:{emitSpecial:function(t,e){this.$emit("ecs-property-change","$",t,e)}}},at=(i(49),Object(h.a)(rt,I,[],!1,null,"c407dbfa",null));at.options.__file="src/app/ui/ecs/entityInspect.vue";var lt=at.exports,dt=n.default.extend({components:{EntityInspect:lt},data:()=>({tool:"inspect",isAdmin:!1,connectionCount:0,connectionBuffering:!1,grid:{type:"none",size:1,offX:0,offY:0,color:"#000000",opacity:.5,width:2},selectedComponents:new Array,selectedEntityOpts:{},phase:null}),methods:{changeTool(t){this.phase.changeTool(t)},onEcsPropertyChange(t,e,i,n){this.phase.selection.setProperty(t,e,i,n)}},watch:{grid:{handler:function(t){let e;switch(t.offX=Math.min(t.offX,t.size),t.offY=Math.min(t.offY,t.size),t.type){case"none":e=void 0;break;case"hex":e=T.HEXAGON;break;case"square":e=T.SQUARE}void 0!==e?this.phase.ecs.addResource({type:"grid",gridType:e,size:t.size,offX:t.offX,offY:t.offY,color:parseInt(t.color.substring(1),16),opacity:parseFloat(t.opacity),width:t.width},"update"):this.phase.ecs.removeResource("grid",!1)},deep:!0}},mounted(){let t=this.phase.ecs.getResource("grid");switch(void 0!==t?t.gridType:void 0){case void 0:this.grid.type="none";break;case T.HEXAGON:this.grid.type="hex";break;case T.SQUARE:this.grid.type="square"}let e=t||R;this.grid.size=e.size,this.grid.offX=e.offX,this.grid.offY=e.offY,this.grid.color="#"+e.color.toString(16).padEnd(6,"0"),this.grid.opacity=e.opacity,this.grid.width=e.width,this.eventEmitter.on("changeTool",t=>{this.tool=t})}}),ht=(i(51),Object(h.a)(dt,M,[],!1,null,"53b46051",null));ht.options.__file="src/app/ui/edit/editMap.vue";var ct=ht.exports,pt=r.o.EventEmitter;class mt{constructor(){this.storages=new Map,this.entities=new Set,this.resources=new Map,this.isDeserializing=!1,this.events=new pt}spawnEntity(...t){let e=-1;do{e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}while(this.entities.has(e));return this.spawnEntityManual(e,t),e}spawnEntityManual(t,e){this.entities.add(t),this.events.emit("entity_spawn",t);for(let i of e)this.addComponent(t,i);this.events.emit("entity_spawned",t)}despawnEntity(t){this.events.emit("entity_despawn",t);for(let e of this.storages.values()){let i=[...e.getComponents(t)];for(let t of i)this.events.emit("component_remove",t);e.unregisterAllOf(t);for(let t of i)this.events.emit("component_removed",t)}this.entities.delete(t),this.events.emit("entity_despawned",t)}hasAllComponents(t,...e){for(let i of e)if(void 0===this.getComponent(t,i))return!1;return!0}addComponent(t,e){e.entity=t;let i=this.storages.get(e.type);if(void 0===i)throw"Cannot register component of type "+e.type+", no storage found";i.register(e),this.events.emit("component_add",e)}removeComponent(t){this.events.emit("component_remove",t),this.storages.get(t.type).unregister(t),this.events.emit("component_removed",t)}addStorage(t){this.storages.set(t.type,t)}getComponent(t,e,i){return this.storages.get(e).getFirstComponent(t,i)}getAllComponents(t){let e=new Array;for(let i of this.storages.values())e.push(...i.getComponents(t));return e}editComponent(t,e,i,n){let o=this.getComponent(t,e,n);this.events.emit("component_edit",o,i);let s=ut(o,i);this.events.emit("component_edited",o,s)}addResource(t,e="fail"){if(this.resources.has(t.type))switch(e){case"ignore":break;case"update":this.editResource(t.type,t);break;default:throw"Resource type already present"}else{if(this.events.emit("resource_add",t),this.resources.has(t.type))throw'"resource_add" event has added a resource of the same type!';this.resources.set(t.type,t),this.events.emit("resource_added",t)}}getResource(t){return this.resources.get(t)}editResource(t,e){let i=this.getResource(t);this.events.emit("resource_edit",i,e),ut(i,e),this.events.emit("resource_edited",i,e)}removeResource(t,e=!0){let i=this.resources.get(t);if(void 0!==i)this.events.emit("resource_remove",i),this.resources.delete(t),this.events.emit("resource_removed",i);else if(e)throw"Resource type not found"}serialize(){let t={};for(let e of this.storages.values())t[e.type]=e.serialize();let e={};for(let t of this.resources.values()){let i={};for(let e in t)"_"!==e[0]&&"type"!==e&&(i[e]=t[e]);e[t.type]=i}return{entities:[...this.entities],storages:t,resources:e}}serializeClient(){let t={},e=this.storages.get("host_hidden");for(let i of this.storages.values())i.type.startsWith("host_")||(t[i.type]=i.serializeClient(t=>void 0!==e.getFirstComponent(t)));let i={};for(let t of this.resources.values()){if(!0===t._clientHide)continue;let e={};for(let i in t)"_"!==i[0]&&"type"!==i&&(e[i]=t[i]);i[t.type]=e}return{entities:[...this.entities].filter(t=>void 0===e.getFirstComponent(t)),storages:t,resources:i}}deserialize(t){this.clear(),this.isDeserializing=!0,this.events.emit("deserialize");for(let e in t.resources){let i=t.resources[e];i.type=e,this.addResource(i)}for(let e of t.entities)this.entities.add(e),this.events.emit("entity_spawn",e);for(let e in t.storages){let i=this.storages.get(e);void 0!==i?i.deserialize(this,t.storages[e]):console.error("Cannot deserialize storage type: "+e+", ignoring")}for(let e of t.entities)this.events.emit("entity_spawned",e);this.isDeserializing=!1,this.events.emit("deserialized")}clear(){this.events.emit("clear");for(let t of[...this.entities])this.despawnEntity(t);for(let t of[...this.entities])this.despawnEntity(t);if(0!==this.entities.size)throw"Entities spawned while clearing!";this.events.emit("cleared")}}function ut(t,e){for(let i in e){let n=e[i];e[i]=t[i],t[i]=n}return e}function ft(t){let e={};for(let i in t)"_"!==i[0]&&"entity"!==i&&"type"!==i&&(e[i]=t[i]);return e}class yt{constructor(t){this.data=new Map,this.type=t}getFirstComponent(t,e){if(void 0!==e)return this.getComponent(t,e);let i=this.data.get(t);return void 0!==i?i[0]:void 0}getComponent(t,e){let i=this.data.get(t);if(void 0!==i)for(let t of i)if(t.multiId===e)return t}getComponents(t){return void 0!==t?this.data.get(t)||[]:this.allComponents()}*allComponents(){for(let t of this.data.values())for(let e of t)yield e}register(t){let e=this.data.get(t.entity);if(t.multiId>=0)if(void 0===e)this.data.set(t.entity,[t]);else{for(let i of e)if(i.multiId===t.multiId)throw"Invalid pre-assigned multiId";e.push(t)}else if(void 0===e)t.multiId=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),this.data.set(t.entity,[t]);else{let i,n;do{i=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),n=!1;for(let t of e)if(t.multiId===i){n=!0;break}}while(n);t.multiId=i,e.push(t)}}unregister(t){let e=this.data.get(t.entity);void 0!==e&&(1===e.length&&e[0]===t?this.data.delete(t.entity):e.splice(e.indexOf(t),1))}unregisterAllOf(t){this.data.delete(t)}serialize(){let t={};for(let[e,i]of this.data.entries()){let n=new Array;for(let t of i)n.push(ft(t));t[e]=n}return t}serializeClient(t){let e={};for(let[i,n]of this.data.entries()){if(t(i))continue;let o=new Array;for(let t of n)!1!==t.clientVisible&&o.push(ft(t));0!==o.length&&(e[i]=o)}return e}deserialize(t,e){for(let i in e){let n=parseInt(i);for(let o of e[i]){let e=Object.assign({},o,{type:this.type});t.addComponent(n,e)}}}}class vt{constructor(t){this.data=new Map,this.type=t}getComponent(t){return this.data.get(t)}getFirstComponent(t){return this.data.get(t)}getComponents(t){if(void 0!==t){let e=this.data.get(t);return void 0===e?[]:[e]}return this.allComponents()}allComponents(){return this.data.values()}register(t){if(void 0!==this.data.get(t.entity))throw"Component of same type already registered";this.data.set(t.entity,t)}unregister(t){let e=this.data.get(t.entity);void 0!==e&&e===t&&this.data.delete(t.entity)}unregisterAllOf(t){this.data.delete(t)}serialize(){let t={};for(let e of this.data.values())t[e.entity]=ft(e);return t}serializeClient(t){let e={};for(let i of this.data.values())t(i.entity)||!1===i.clientVisible||(e[i.entity]=ft(i));return e}deserialize(t,e){for(let i in e){let n=Object.assign({},e[i],{type:this.type});t.addComponent(parseInt(i),n)}}}class gt{constructor(t){this.data=new Map,this.type=t}getComponent(t){return this.data.get(t)}getFirstComponent(t){return this.getComponent(t)}getComponents(t){if(void 0!==t){let e=this.getComponent(t);return void 0===e?[]:[e]}return this.allComponents()}allComponents(){return this.data.values()}register(t){if(this.data.has(t.entity))throw"Component of same type already registered";this.data.set(t.entity,t)}unregister(t){this.data.delete(t.entity)}unregisterAllOf(t){this.data.delete(t)}serialize(){return[...this.data.keys()]}serializeClient(t){return[...this.data.keys()].filter(e=>!t(e))}deserialize(t,e){for(let i of e)t.addComponent(i,{type:this.type,entity:-1})}}const bt={children:!0,texture:!0,baseTexture:!0},wt=["jpeg","png","x-jg","bmp","x-icon","ief","pjpeg","x-portable-bitmap","x-rgb","tiff","x-tiff"];function _t(t,e){!function(t){if(!t.startsWith("image/"))throw"Invalid type: it should be an image";if(wt.indexOf(t.substr("image/".length))<0)throw"Unsupported image type"}(e);let i=new Uint8Array(t),n="data:"+e+";base64,"+btoa(i.reduce((t,e)=>t+String.fromCharCode(e),""));return new Promise((t,e)=>{let i=new Image;i.onload=()=>{const e=new r.k(new r.c(new r.n.ImageResource(i)));t([e,i])},i.onerror=e,i.src=n})}const Ct=Math.sqrt(3);class Et{constructor(t){this.type="grid",this.posX=0,this.posY=0,this.scaleX=1,this.scaleY=1,this.ecs=t,this.sprite=new r.l(r.k.EMPTY,ce.screen.width,ce.screen.height),this.sprite.zIndex=5e3,t.events.on("resource_add",this.onResourceAdd,this),t.events.on("resource_edited",this.onResourceEdited,this),t.events.on("resource_remove",this.onResourceRemove,this)}onResourceAdd(t){"grid"===t.type&&(this.gridRes=t,this.updateTex(),this.updatePos())}onResourceEdited(t,e){"grid"===t.type&&(this.updateTex(),this.updatePos())}onResourceRemove(t){"grid"===t.type&&(this.gridRes=void 0,this.disable())}disable(){this.sprite.texture.destroy(!0),this.sprite.texture=r.k.EMPTY}updateTex(){if(void 0===this.gridRes)return;this.sprite.texture.destroy(!0);let t=function(t,e,i){let n;switch(e){case T.HEXAGON:n=function(t,e){let i=t/Ct,n=Math.floor(3*i),o=document.createElement("canvas");o.width=n,o.height=t;let s=o.getContext("2d"),r=t;return s.lineWidth=e.width,s.strokeStyle=xt(e.color,e.opacity),s.moveTo(0,0),s.lineTo(i,0),s.lineTo(i+i/2,r/2),s.lineTo(2*i+i/2,r/2),s.lineTo(3*i,0),s.moveTo(0,r),s.lineTo(i,r),s.lineTo(i+i/2,r/2),s.moveTo(2*i+i/2,r/2),s.lineTo(3*i,r),s.moveTo(0,0),s.lineTo(-i/2,r/2),s.lineTo(0,r),s.stroke(),s.getImageData(0,0,n,t)}(t,i);break;case T.SQUARE:n=function(t,e){let i=document.createElement("canvas");i.width=t,i.height=t;let n=i.getContext("2d");return n.lineWidth=e.width,n.strokeStyle=xt(e.color,e.opacity),n.strokeRect(0,0,t+1,t+1),n.getImageData(0,0,t,t)}(t,i);break;default:throw"Cannot draw unknown type: "+e}return r.c.fromBuffer(new Uint8Array(n.data.buffer),n.width,n.height)}(512,this.gridRes.gridType,this.gridRes);this.internalScale=this.gridRes.size/512,this.sprite.texture=new r.k(t)}updatePos(){void 0!==this.gridRes&&(this.sprite.tileScale.set(this.scaleX*this.internalScale,this.scaleY*this.internalScale),this.sprite.tilePosition.set(this.posX+this.scaleX*this.gridRes.offX*this.gridRes.size,this.posY+this.scaleY*this.gridRes.offY*this.gridRes.size))}closestPoint(t){if(void 0===this.gridRes)return;let e=new r.g(t[0],t[1]);this.sprite.worldTransform.apply(e,e);let i,n,o=e.x/this.internalScale/512-this.gridRes.offX,s=e.y/this.internalScale/512-this.gridRes.offY;switch(this.gridRes.gridType){case T.SQUARE:{let t=Math.floor(o),e=Math.floor(s);i=t,n=e,o>t+.5&&(i+=1),s>e+.5&&(n+=1)}break;case T.HEXAGON:{const t=1/Ct;let e=2*(o-t/2)/Ct,r=s,a=Math.floor(e),l=Math.floor(r),d=e-a,h=r-l,c=a*Ct/2+t/2;a%2==0?h<.5-d/2?(n=l,i=c+t/2):h>d/2+.5?(n=l+1,i=c+t/2):(n=l+.5,i=c+t):h>1-d/2?(n=l+1,i=c+t):h<d/2?(n=l,i=c+t):(n=l+.5,i=c+t/2)}}return e.set((i+this.gridRes.offX)*this.internalScale*512,(n+this.gridRes.offY)*this.internalScale*512),this.sprite.worldTransform.applyInverse(e,e),[e.x,e.y]}destroy(){this.sprite.destroy(bt)}}function xt(t,e){return"#"+(t<<8|255*e).toString(16).padStart(8,"0")}class St extends s{constructor(t){super(t),this.isDraggingBoard=!1,this.pointers=new Map,this.ecs=new mt,this.board=new r.d,this.board.interactive=!0,this.board.interactiveChildren=!0,this.board.sortableChildren=!0,this.board.position.set(0,0),this.board.zIndex=100}setupEcs(){var t;(t=this.ecs).addStorage(new vt("position")),t.addStorage(new vt("transform")),t.addStorage(new yt("name")),t.addStorage(new yt("note")),this.gridSystem=new Et(this.ecs)}zoom(t,e,i){if(this.board.scale.x<.05&&t<1||this.board.scale.x>3&&t>1)return;let n=this.board.position.x-e,o=this.board.position.y-i;n*=t,o*=t;const s=new r.g(n+e,o+i),a=new r.g(this.board.scale.x*t,this.board.scale.y*t);this.board.position.copyFrom(s),this.board.scale.copyFrom(a),this.gridSystem.posX=s.x,this.gridSystem.posY=s.y,this.gridSystem.scaleX=a.x,this.gridSystem.scaleY=a.y,this.gridSystem.updatePos()}onMouseWheel(t){const e=1-.1*Math.sign(t.deltaY);this.zoom(e,t.clientX,t.clientY)}onPointerDown(t){if("mouse"===t.data.pointerType&&2===t.data.button)return void this.onPointerRightDown(t);let e=t.data.global;this.pointers.set(t.data.pointerId,{firstX:e.x,firstY:e.y,lastX:e.x,lastY:e.y}),1===this.pointers.size&&(this.isDraggingBoard=!0),this.lastMouseDownTime=Date.now()}onPointerUp(t){let e=this.pointers.get(t.data.pointerId);if(void 0!==e&&(this.pointers.delete(t.data.pointerId),void 0!==this.lastMouseDownTime&&0===this.pointers.size)){this.isDraggingBoard=!1;let i=Date.now()-this.lastMouseDownTime,n=Math.abs(t.data.global.x-e.firstX),o=Math.abs(t.data.global.y-e.firstY);Math.sqrt(n*n+o*o)<5&&i<500&&this.onPointerClick(t)}}onPointerUpOutside(t){this.onPointerUp(t)}onPointerMove(t){let e=this.pointers.get(t.data.pointerId);if(void 0===e)return;let i=t.data.global;if(1===this.pointers.size&&this.isDraggingBoard){const t=this.board.position.x+(i.x-e.lastX),n=this.board.position.y+(i.y-e.lastY);this.board.position.x=t,this.board.position.y=n,this.gridSystem.posX=t,this.gridSystem.posY=n,this.gridSystem.updatePos()}let n=0;if(2===this.pointers.size){let[t,e]=this.pointers.values(),i=t.lastX-e.lastX,o=t.lastY-e.lastY;n=Math.sqrt(i*i+o*o)}if(e.lastX=i.x,e.lastY=i.y,2===this.pointers.size){let[t,e]=this.pointers.values(),i=t.lastX-e.lastX,o=t.lastY-e.lastY,s=Math.sqrt(i*i+o*o),a=new r.g((t.lastX+e.lastX)/2,(t.lastY+e.lastY)/2);this.zoom(s/n,a.x,a.y)}}onPointerClick(t){}onPointerRightDown(t){}centerBoard(){let t=ce.renderer.width/2,e=ce.renderer.height/2,i=this.board.getBounds();this.board.position.set(t-i.x-i.width/2,e-i.y-i.height/2)}applyCanvasStyle(t){const e=t.style;e.width="100%",e.height="100%"}enable(){super.enable();const t=ce.view;this.applyCanvasStyle(t);let e=document.getElementById("canvas-container");ce.resizeTo=e,e.appendChild(t),ce.stage=new r.d,ce.stage.addChild(this.board),ce.stage.addChild(this.gridSystem.sprite),ce.stage.interactive=!0,ce.stage.hitArea={contains:(t,e)=>!0},ce.stage.on("pointermove",this.onPointerMove,this),ce.stage.on("pointerdown",this.onPointerDown,this),ce.stage.on("pointerup",this.onPointerUp,this),ce.stage.on("pointerupoutside",this.onPointerUpOutside,this),this.wheelListener=this.onMouseWheel.bind(this),t.addEventListener("wheel",this.wheelListener)}disable(){this.gridSystem.destroy(),ce.stage.off("pointermove",this.onPointerMove,this),ce.stage.off("pointerdown",this.onPointerDown,this),ce.stage.off("pointerup",this.onPointerUp,this),ce.stage.off("pointerupoutside",this.onPointerUpOutside,this),ce.view.removeEventListener("wheel",this.wheelListener),document.getElementById("canvas-container").removeChild(ce.view),ce.resizeTo=void 0,super.disable()}}var Mt;!function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.GRID=10]="GRID",t[t.ROOM=20]="ROOM",t[t.PINS=30]="PINS",t[t.ROOM_CREATOR=40]="ROOM_CREATOR"}(Mt||(Mt={}));var Rt=function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function r(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class Tt{constructor(t,e){this.ecs=t,this.phase=e,this.storage=new vt("background_image"),this.ecs.addStorage(this.storage),this.ecs.events.on("entity_spawned",this.onEntitySpawned,this),this.ecs.events.on("component_edited",this.onComponentEdit,this),this.ecs.events.on("component_remove",this.onComponentRemove,this),this.ecs.events.on("selection_begin",this.onSelectionBegin,this),this.ecs.events.on("selection_end",this.onSelectionEnd,this)}onSelectionBegin(t){let e=this.storage.getComponent(t);void 0!==e&&(e._display.tint=7964363)}onSelectionEnd(t){let e=this.storage.getComponent(t);void 0!==e&&(e._display.tint=16777215)}enable(){this.displayMaps=new r.d,this.displayMaps.zIndex=Mt.BACKGROUND,this.displayMaps.interactive=!0,this.displayMaps.interactiveChildren=!0,this.phase.board.addChild(this.displayMaps)}onEntitySpawned(t){return Rt(this,void 0,void 0,(function*(){let e=this.storage.getComponent(t);if(void 0===e)return;let i=this.ecs.getComponent(t,"position");if(void 0===i)return;let n=this.ecs.getComponent(t,"transform");void 0===n&&(n={type:"transform",entity:-1,rotation:0},this.ecs.addComponent(t,n)),0!==e.image.byteOffset&&(e.image=new Uint8Array(e.image));let[o,s]=yield _t(e.image,e.imageType),a=new r.j(o);a.anchor.set(.5),a.position.set(i.x,i.y),a.angle=n.rotation,a.interactive=!0,a._ecs_entity=t,e._display=a,e._html=s,this.displayMaps.addChild(a),console.log("Sprite added")}))}onComponentEdit(t){if("position"===t.type){let e=t,i=this.storage.getComponent(t.entity);if(void 0===i)return;i._display.position.set(e.x,e.y)}else if("transform"===t.type){let e=t,i=this.storage.getComponent(t.entity);if(void 0===i)return;i._display.angle=e.rotation}}onComponentRemove(t){if("background_image"!==t.type)return;t._display.destroy(bt)}destroy(){this.displayMaps.destroy(bt)}}class It{constructor(t,e,i){this.left=void 0,this.right=void 0,this.point=t,this.parent=e,this.dimension=i}}class Pt{constructor(){this.root=void 0}distance(t,e){let i=t[0]-e[0],n=t[1]-e[1];return i*i+n*n}lastSearch(t,e,i){for(;void 0!==e;)i=e,e=t[e.dimension]<e.point[e.dimension]?e.left:e.right;return i}nodeSearch(t){let e=this.root;for(;void 0!==e;){if(t[0]===e.point[0]&&t[1]===e.point[1])return e;e=t[e.dimension]<e.point[e.dimension]?e.left:e.right}}insert(t){let e=this.lastSearch(t,this.root,void 0);if(void 0===e)return void(this.root=new It(t,void 0,0));let i=new It(t,e,e.dimension+1&1),n=e.dimension;t[n]<e.point[n]?e.left=i:e.right=i}findMin(t,e){if(void 0===t)return;if(t.dimension===e)return void 0!==t.left?this.findMin(t.left,e):t;let i=t.point[e],n=this.findMin(t.left,e),o=this.findMin(t.right,e),s=t;return void 0!==n&&n.point[e]<i&&(s=n),void 0!==o&&o.point[e]<s.point[e]&&(s=o),s}removeNode(t){if(void 0!==t.left||void 0!==t.right)if(void 0!==t.right){let e=this.findMin(t.right,t.dimension),i=e.point;this.removeNode(e),t.point=i}else{let e=this.findMin(t.left,t.dimension),i=e.point;this.removeNode(e),t.right=t.left,t.left=void 0,t.point=i}else{if(void 0===t.parent)return void(this.root=void 0);let e=t.parent.dimension;t.point[e]<t.parent.point[e]?t.parent.left=void 0:t.parent.right=void 0}}remove(t){let e=this.nodeSearch(t);return void 0!==e&&(this.removeNode(e),!0)}nearestPoint(t,e){if(void 0===(e=e||this.root))return;let i,n=this.distance(e.point,t);if(void 0===e.left&&void 0===e.right)return[e.point,n];i=void 0===e.right?e.left:void 0===e.left?e.right:t[e.dimension]<e.point[e.dimension]?e.left:e.right;let o,s,[r,a]=this.nearestPoint(t,i);a<n?(o=r,s=a):(o=e.point,s=n);let l=[t[0],t[1]];if(l[e.dimension]=e.point[e.dimension],this.distance(l,t)<s){let n;if(n=i===e.left?e.right:e.left,void 0!==n){let[e,i]=this.nearestPoint(t,n);i<s&&(o=e,s=i)}}return[o,s]}}function At(t,e){const i=t.x,n=t.y;let o=!1;const s=e.length/2;for(let t=0,r=s-1;t<s;r=t++){const s=e[2*t],a=e[2*t+1],l=e[2*r],d=e[2*r+1];a>n!=d>n&&i<(n-a)/(d-a)*(l-s)+s&&(o=!o)}return o}class kt{constructor(t){this.counter=new Map,this.tree=new Pt,this.count=0,this.grid=t}insert(t){let e=t[0]+"|"+t[1],i=this.counter.get(e)||0;this.counter.set(e,i+1),0==i&&this.tree.insert(t),this.count++}remove(t){let e=t[0]+"|"+t[1],i=(this.counter.get(e)||0)-1;if(0==i)this.counter.delete(e),this.tree.remove(t)||console.error("Failed to remove node: "+t);else{if(!(i>0))return!1;this.counter.set(e,i)}return this.count--,!0}findNearest(t){let e=this.tree.nearestPoint(t),i=void 0;if(void 0!==this.grid&&(i=this.grid.closestPoint(t)),void 0!==i){let n=function(t,e,i,n){let o=t-i,s=e-n;return o*o+s*s}(t[0],t[1],i[0],i[1]);if(void 0===e||n<e[1])return[i,n]}return e}}var Ot;!function(t){t[t.NONE=0]="NONE",t[t.SELECTION=1]="SELECTION",t[t.OBSCURED=2]="OBSCURED"}(Ot||(Ot={}));class Dt{constructor(t,e){this.roomStorage=new vt("room"),this.isTranslating=!1,this.ecs=t,this.phase=e,t.addStorage(this.roomStorage),t.events.on("entity_spawned",this.onEntitySpawned,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_remove",this.onComponentRemove,this),t.events.on("selection_begin",this.onSelectionBegin,this),t.events.on("selection_end",this.onSelectionEnd,this),t.events.on("tool_move_begin",this.onToolMoveBegin,this),t.events.on("tool_move_end",this.onToolMoveEnd,this)}findRoomAt(t){for(let e of this.roomStorage.allComponents())if(At(t,e._worldPolygon))return e.entity}static recomputeWorld(t,e){void 0!==t._worldPolygon&&t._worldPolygon.length===t.polygon.length||(t._worldPolygon=new Array(t.polygon.length));let i=t._worldPolygon;for(let n=0;n<i.length;n+=2)i[n]=t.polygon[n]+e.x,i[n+1]=t.polygon[n+1]+e.y}onEntitySpawned(t){let e=this.ecs.getComponent(t,"room");if(void 0===e)return;let i=this.ecs.getComponent(t,"position");void 0!==i&&(void 0===e._worldPolygon&&Dt.recomputeWorld(e,i),this.addRoom(e))}onComponentEdited(t,e){if("room"!==t.type&&"position"!==t.type)return;let i,n;if("room"===t.type?(i=t,n=this.ecs.getComponent(t.entity,"position")):(i=this.ecs.getComponent(t.entity,"room"),n=t),void 0!==i&&void 0!==n){if(!this.isTranslating){for(let t=0;t<i._worldPolygon.length;t+=2)this.phase.pointDb.remove([i._worldPolygon[t],i._worldPolygon[t+1]])||console.error("Error removing point");Dt.recomputeWorld(i,n);for(let t=0;t<i._worldPolygon.length;t+=2)this.phase.pointDb.insert([i._worldPolygon[t],i._worldPolygon[t+1]])}if("position"===t.type){let t=void 0!==e.x?e.x:n.x,o=void 0!==e.y?e.y:n.y,s=n.x-t,r=n.y-o,a=i._graphics.position;a.set(a.x+s,a.y+r)}else this.redrawComponent(i)}}onComponentRemove(t){"room"===t.type&&t._graphics.destroy(bt)}onSelectionBegin(t){let e=this.ecs.getComponent(t,"room");void 0!==e&&(e._selected=!0,this.redrawComponent(e))}onSelectionEnd(t){let e=this.ecs.getComponent(t,"room");void 0!==e&&(e._selected=void 0,this.redrawComponent(e))}onToolMoveBegin(){this.isTranslating=!0;for(let t of this.phase.selection.getSelectedByType("room")){let e=t;for(let t=0;t<e._worldPolygon.length;t+=2)this.phase.pointDb.remove([e._worldPolygon[t],e._worldPolygon[t+1]])||console.error("Error removing point")}}onToolMoveEnd(){this.isTranslating=!1;for(let t of this.phase.selection.getSelectedByType("room")){let e=t,i=this.ecs.getComponent(e.entity,"position");Dt.recomputeWorld(e,i);for(let t=0;t<e._worldPolygon.length;t+=2)this.phase.pointDb.insert([e._worldPolygon[t],e._worldPolygon[t+1]])}}addVertex(t){this.currentRoom.length>0&&t.x==this.currentRoom[0]&&t.y==this.currentRoom[1]?this.endRoomCreation(!0):(this.currentRoom.push(t.x,t.y),this.phase.pointDb.insert([t.x,t.y]),this.redrawRoomCreation(this.currentRoom,this.currentRoomDisplay,!1,!0,Ot.SELECTION))}undoVertex(t){let e=this.currentRoom.pop(),i=this.currentRoom.pop();void 0!==i&&(this.phase.pointDb.remove([i,e]),this.redrawRoomCreation(this.currentRoom,this.currentRoomDisplay,!1,!0,Ot.SELECTION),this.redrawLastLine(this.currentRoom,t))}initRoomCreation(){this.endRoomCreation(!1),this.currentRoom=[]}addRoom(t){let e=new r.e;this.displayRooms.addChild(e),t._graphics=e,this.redrawComponent(t)}endRoomCreation(t){if(void 0===this.currentRoom)return;this.currentRoomDisplay.clear(),this.currentRoomDisplayLastSegment.clear();let e=this.currentRoom;this.currentRoom=void 0;let i=1/0,n=1/0;for(let t=0;t<e.length;t+=2)i=Math.min(i,e[t]),n=Math.min(n,e[t+1]);let o=new Array(e.length);for(let t=0;t<e.length;t+=2)o[t]=e[t]-i,o[t+1]=e[t+1]-n;if(t){let t=this.ecs.spawnEntity({type:"position",x:i,y:n},{type:"room",polygon:o,_worldPolygon:e,visible:!1});this.phase.selection.setOnlyEntity(t),this.phase.changeTool(Wt.INSPECT)}}redrawComponent(t){t._graphics.position.set(0,0),t._graphics.cacheAsBitmap=!1;let e=Ot.NONE;!0===t._selected?e=Ot.SELECTION:t.visible||(e=Ot.OBSCURED),this.redrawRoomCreation(t._worldPolygon,t._graphics,!0,!1,e)}redrawRoomCreation(t,e,i,n,o){e.clear();let s=0,r=0;if(o===Ot.SELECTION?(s=7964363,r=.2):o===Ot.OBSCURED&&(s=0,r=.5),0!==t.length){o!==Ot.NONE&&e.beginFill(s,r),e.moveTo(t[0],t[1]),e.lineStyle(5);for(let i=2;i<t.length;i+=2)e.lineTo(t[i],t[i+1]);if(i&&e.lineTo(t[0],t[1]),o!==Ot.NONE&&e.endFill(),n){e.lineStyle(0),e.beginFill(15011856),e.drawCircle(t[0],t[1],10),e.endFill(),e.beginFill();for(let i=2;i<t.length;i+=2)e.drawCircle(t[i],t[i+1],10);e.endFill()}}}redrawLastLine(t,e){let i=this.currentRoomDisplayLastSegment;i.clear(),0!==t.length&&(i.lineTo(t[t.length-2],t[t.length-1]),i.lineStyle(5),i.lineTo(e.x,e.y)),i.lineStyle(0),i.beginFill(4218878),i.drawCircle(e.x,e.y,10),i.endFill()}enable(){this.displayRooms=new r.d,this.displayRooms.zIndex=Mt.ROOM,this.currentRoomDisplay=new r.e,this.currentRoomDisplay.zIndex=Mt.ROOM_CREATOR,this.currentRoomDisplayLastSegment=new r.e,this.currentRoomDisplayLastSegment.zIndex=Mt.ROOM_CREATOR+1,this.phase.board.addChild(this.displayRooms,this.currentRoomDisplay,this.currentRoomDisplayLastSegment)}destroy(){this.displayRooms.destroy(bt),this.currentRoomDisplay.destroy(bt),this.currentRoomDisplayLastSegment.destroy(bt)}}const Nt=["name","note"],zt=["name","note"],Bt=["note"];class Ft{constructor(t){this.selectedEntities=new Set,this.dataByType=new Map,this.isTranslating=!1,this.translateDirty=!1,this.ecs=t,this.ecs.events.on("tool_move_begin",()=>this.isTranslating=!0),this.ecs.events.on("tool_move_end",()=>{this.isTranslating=!1,this.translateDirty&&(this.translateDirty=!1,this.update())}),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edited",this.onComponentUpdate,this),this.ecs.events.on("component_removed",this.onComponentRemove,this),this.ecs.events.on("entity_despawn",this.onEntityDespawn,this)}update(){this.isTranslating?this.translateDirty=!0:this.ecs.events.emit("selection_update",this)}onComponentAdd(t){this.selectedEntities.has(t.entity)&&(this.getOrCreateData(t.type).entities.add(t),this.update())}onComponentUpdate(t){this.selectedEntities.has(t.entity)&&this.update()}onComponentRemove(t){if(!this.selectedEntities.has(t.entity))return;let e=this.dataByType.get(t.type);e.entities.delete(t),0===e.entities.size&&this.dataByType.delete(t.type),this.update()}onEntityDespawn(t){this.selectedEntities.has(t)&&(this.removeEntity(t),this.update())}clear(t=!0,e=!0){if(t)for(let t of this.selectedEntities)this.ecs.events.emit("selection_end",t);this.selectedEntities.clear(),this.dataByType.clear(),e&&this.update()}setOnlyEntity(t){this.clear(!0,!1),this.addEntity(t)}toggleEntity(t){this.selectedEntities.has(t)?this.removeEntity(t):this.addEntity(t)}addEntity(t){this.selectedEntities.add(t);let e=this.ecs.getAllComponents(t);for(let t of e)this.getOrCreateData(t.type).entities.add(t);this.ecs.events.emit("selection_begin",t),this.update()}removeEntity(t){this.selectedEntities.delete(t);let e=this.ecs.getAllComponents(t);for(let t of e){let e=this.dataByType.get(t.type);e.entities.delete(t),0===e.entities.size&&this.dataByType.delete(t.type)}this.ecs.events.emit("selection_end",t),this.update()}getSelectedByType(t){let e=this.dataByType.get(t);return void 0===e?[]:e.entities}initialComponent(t){return{_canDelete:zt.indexOf(t)>=0,_isFullscreen:!(Bt.indexOf(t)>=0)&&void 0}}getSingleComponents(){let t=new Array,e=this.selectedEntities.values().next().value;for(let i of this.ecs.storages.keys()){if(i.startsWith("host_"))continue;let n=this.ecs.storages.get(i).getComponents(e);for(let e of n)t.push(jt(this.initialComponent(i),e))}return t}getCommonComponents(){if(0===this.selectedEntities.size)return[];let t=this.selectedEntities.size;if(1===t)return this.getSingleComponents();let e=new Array;for(let i of this.ecs.storages.keys()){if("host_hidden"===i)continue;let n=this.dataByType.get(i);null!=n&&n.entities.size===t&&-1===Nt.indexOf(i)&&e.push(i)}let i=new Array;for(let t of e){if("host_hidden"===t)continue;let e=void 0;for(let i of this.selectedEntities){let n=this.ecs.storages.get(t).getComponents(i);for(let i of n)void 0===e?e=jt(this.initialComponent(t),i):Yt(e,i)}i.push(e)}return i}getCommonEntityOpts(){let t=this.dataByType.get("host_hidden"),e=this.dataByType.get("room");return{hidden:void 0!==t&&t.entities.size===this.selectedEntities.size,forgettable:void 0!==e&&e.entities.size===this.selectedEntities.size}}setProperty(t,e,i,n){if("$"!==t){for(let o of this.selectedEntities){let s={};s[e]=i,this.ecs.editComponent(o,t,s,n)}this.update()}else switch(e){case"hidden":for(let t of this.selectedEntities){let e=this.ecs.getComponent(t,"host_hidden");void 0!==e?this.ecs.removeComponent(e):this.ecs.addComponent(t,{type:"host_hidden",entity:-1})}break;case"forget":alert("TODO: forget room");break;case"delete":for(let t of[...this.selectedEntities])this.ecs.despawnEntity(t);this.clear();break;case"addComponent":let t;switch(i){case"name":t={type:"name",name:"",clientVisible:!0};break;case"note":t={type:"note",note:"",clientVisible:!0};break;default:throw"Cannot add unknown component: "+i}for(let e of[...this.selectedEntities])this.ecs.addComponent(e,Object.assign({},t));break;case"removeComponent":for(let t of[...this.selectedEntities]){let e=this.ecs.getComponent(t,i,n);void 0!==e&&this.ecs.removeComponent(e)}break;default:console.warn("Unknown special event: "+e)}}moveAll(t,e){for(let i of this.selectedEntities){let n=this.ecs.getComponent(i,"position");void 0!==n&&this.ecs.editComponent(i,"position",{x:n.x+t,y:n.y+e})}this.isTranslating?this.translateDirty=!0:this.update()}getOrCreateData(t){let e=this.dataByType.get(t);return void 0===e&&(e={entities:new Set},this.dataByType.set(t,e)),e}hasComponentType(t){let e=this.dataByType.get(t);return void 0!==e&&e.entities.size>0}}function jt(t,e){for(let i in e)"_"!==i[0]&&(t[i]=e[i]);return t}function Yt(t,e){for(let i in e)"_"!==i[0]&&t[i]!==e[i]&&(t[i]=null);for(let i in t)"_"!==i[0]&&void 0===e[i]&&(t[i]=null)}var Xt=i(28),$t=i.n(Xt);class Ut{constructor(t){this.connections=[],this.connectionsById=new Map,this.myId=-1,this.nextBroadcastPacketId=0,this.eventEmitter=new o,this.bufferingChannels=0,this.isHost=t,this.isHost&&(this.myId=0)}onMessage(t,e){let i=t;if(this.isHost&&(i.sender=e.channelId),i.payload.type.startsWith("_"))console.error("Invalid payload type");else{if(this.isHost&&i.receiver!==this.myId){let t=i.id;if(void 0===i.receiver){i.id=this.nextBroadcastPacketId++;for(let t of this.connectionsById.values())t!==e&&t.send(i)}else{let t=this.connectionsById.get(i.receiver);if(void 0===t)return void this.send({type:"error",errorType:"unknown_receiver",requestId:i.id},e.channelId);i.id=t.nextPacketId++,t.send(i)}i.id=t}if(void 0===i.receiver||i.receiver===this.myId){let t=i.payload.type;0,this.eventEmitter.emit("any",i.payload,i),this.eventEmitter.emit(t,i.payload,i)}}}broadcast(t){const e={id:this.nextBroadcastPacketId,payload:t,sender:this.myId};for(let t of this.connectionsById.values())t.send(e);this.nextBroadcastPacketId++}send(t,e){const i={id:0,payload:t,sender:this.myId};if(this.isHost){let t=this.connectionsById.get(e);if(void 0===t)throw"Unknown receiver";i.id=t.channelId++,t.send(i)}else{i.id=this.nextBroadcastPacketId++;for(let t of this.connectionsById.values())t.send(i)}}onConnectionStatusUpdate(t){t?this.bufferingChannels+=1:this.bufferingChannels-=1,this.eventEmitter.emit("_buffering_update",this.bufferingChannels)}registerNewConnection(t){this.connectionsById.set(t.channelId,t),this.connections.push(t),t.ondata=this.onMessage.bind(this),t.nextPacketId=0,t.onBufferChange=this.onConnectionStatusUpdate.bind(this),this.eventEmitter.emit("_device_join",t.channelId)}removeConnection(t){this.connectionsById.delete(t.channelId);const e=this.connections.indexOf(t);e>-1&&this.connections.splice(e,1),this.eventEmitter.emit("_device_left",t.channelId)}}var Lt=r.o.EventEmitter;class Vt extends Lt{constructor(t){super(),this.myId=-1,this.nextConnectionId=1,this.isHost=t,this.channel=new Ut(t),this.peer=new $t.a(void 0,{host:"peerjs.92k.de",secure:!0,debug:2}),this.isHost&&(this.myId=0,this.connections=new Map),this.peer.on("connection",this.onConnection.bind(this)),this.peer.on("open",this.onPeerConnectionOpen.bind(this)),this.peer.on("error",this.onPeerConnectionError.bind(this))}onConnection(t){let e=0;this.isHost&&(e=this.nextConnectionId++);let i=new Ht(this,e,t);this.isHost?this.connections.set(e,i):this.hostConnection=i}onPeerConnectionOpen(){void 0!==this.connectId&&this.connectReady(),this.emit("ready")}onPeerConnectionError(t){this.emit("error",t)}getId(){return this.peer.id}connectTo(t){if(this.isHost)throw"A host cannot open a connection, for now!";if(void 0!==this.connectId)throw"Cannot connect to multiple hosts";this.connectId=t,null!=this.peer.id&&this.connectReady()}connectReady(){let t=this.peer.connect(this.connectId,{reliable:!0});this.hostConnection=new Ht(this,void 0,t)}}class Ht{constructor(t,e,i){this.bootstrap=!1,this.buffered=!1,this.parent=t,this.channelId=e,this.connection=i,t.isHost&&(this.bootstrap=!0),i.on("open",this.onOpen.bind(this)),i.on("data",this.onData.bind(this)),i.on("close",this.onClose.bind(this))}onOpen(){this.connection.dataChannel.onbufferedamountlow=this.updateBuffered.bind(this),this.parent.isHost&&(this.connection.send(this.channelId),this.parent.channel.registerNewConnection(this))}onData(t){if(!this.bootstrap)return this.parent.myId=t,this.parent.channel.myId=t,this.bootstrap=!0,void this.parent.channel.registerNewConnection(this);void 0!==this.ondata&&this.ondata(t,this)}onClose(){this.parent.channel.removeConnection(this)}send(t){this.connection.send(t),this.updateBuffered()}bufferedBytes(){return this.connection.dataChannel.bufferedAmount}updateBuffered(){let t=this.buffered;this.buffered=this.connection.bufferSize+this.connection.dataChannel.bufferedAmount!==0,t!==this.buffered&&void 0!==this.onBufferChange&&this.onBufferChange(this.buffered)}}class qt{constructor(t,e){this.storage=new vt("pin"),this.pointToPin=new Map,this.isTranslating=!1,this.ecs=t,this.phase=e,t.addStorage(this.storage),t.events.on("entity_spawned",this.onEntitySpawned,this),t.events.on("component_edited",this.onComponentEdited,this),t.events.on("component_remove",this.onComponentRemove,this),t.events.on("selection_begin",this.onSelectionBegin,this),t.events.on("selection_end",this.onSelectionEnd,this),t.events.on("tool_move_begin",this.onToolMoveBegin,this),t.events.on("tool_move_end",this.onToolMoveEnd,this)}findPinAt(t){let e=-1,i=Number.POSITIVE_INFINITY;for(let n of this.storage.allComponents()){let o=this.ecs.getComponent(n.entity,"position"),s=o.x-t.x,r=o.y-t.y,a=s*s+r*r;a<i&&(e=n.entity,i=a)}if(i<=144)return e}addPinPoint(t,e){let i=t[0]+"|"+t[1],n=this.pointToPin.get(i);void 0===n&&(n=new Array,this.pointToPin.set(i,n)),n.push(e),this.phase.pointDb.insert(t)}removePinPoint(t,e){this.phase.pointDb.remove(t);let i=t[0]+"|"+t[1],n=this.pointToPin.get(i);n.splice(n.indexOf(e),1),0===n.length&&this.pointToPin.delete(i)}onEntitySpawned(t){let e=this.storage.getComponent(t);if(void 0===e)return;let i=this.ecs.getComponent(t,"position");void 0!==i&&(this.addPinPoint([i.x,i.y],t),this.addPin(i,e))}onComponentEdited(t,e){if("pin"!==t.type&&"position"!==t.type)return;let i,n;if("pin"===t.type?(i=t,n=this.ecs.getComponent(t.entity,"position")):(i=this.storage.getComponent(t.entity),n=t),void 0!==i&&void 0!==n){if("position"===t.type&&(!this.isTranslating||!0!==i._selected)){let i=void 0===e.x?n.x:e.x,o=void 0===e.y?n.y:e.y;this.removePinPoint([i,o],t.entity),this.addPinPoint([n.x,n.y],t.entity)}this.redrawComponent(n,i)}}onComponentRemove(t){if("pin"!==t.type)return;t._display.destroy({children:!0,texture:!1,baseTexture:!1});let e=this.ecs.getComponent(t.entity,"position");this.removePinPoint([e.x,e.y],t.entity)}onSelectionBegin(t){let e=this.storage.getComponent(t);if(void 0===e)return;e._selected=!0;let i=this.ecs.getComponent(e.entity,"position");this.redrawComponent(i,e)}onSelectionEnd(t){let e=this.storage.getComponent(t);if(void 0===e)return;e._selected=void 0;let i=this.ecs.getComponent(e.entity,"position");this.redrawComponent(i,e)}onToolMoveBegin(){this.isTranslating=!0;for(let t of this.phase.selection.getSelectedByType("pin")){let e=t,i=this.ecs.getComponent(e.entity,"position");this.removePinPoint([i.x,i.y],e.entity)}}onToolMoveEnd(){this.isTranslating=!1;for(let t of this.phase.selection.getSelectedByType("pin")){let e=t,i=this.ecs.getComponent(e.entity,"position");this.addPinPoint([i.x,i.y],e.entity)}}addPin(t,e){if(void 0===e._display){let t=new r.j(this.circleTex);this.displayPins.addChild(t),e._display=t}this.redrawComponent(t,e)}redrawComponent(t,e){let i=e._display,n=e.color;var o,s,r;e._selected&&(n=((o=n)>>16&255)*(1-(r=.3))+((s=7964363)>>16&255)*r<<16|(o>>8&255)*(1-r)+(s>>8&255)*r<<8|(255&o)*(1-r)+(255&s)*r),i.tint=n,i.position.set(t.x,t.y)}initCreation(){this.cancelCreation();let t=Math.floor(16777215*Math.random());this.createPin=new r.j(this.circleTex),this.createPin.tint=t,this.createPin.position.set(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),this.displayPins.addChild(this.createPin)}cancelCreation(){void 0!==this.createPin&&(this.createPin.destroy({children:!0,texture:!1,baseTexture:!1}),this.createPin=void 0)}redrawCreation(t){void 0!==this.createPin&&this.createPin.position.set(t.x,t.y)}confirmCreation(t){if(void 0===this.createPin)return;let e=this.ecs.spawnEntity({type:"position",x:t.x,y:t.y},{type:"pin",color:this.createPin.tint,_display:this.createPin});this.createPin=void 0,this.phase.changeTool(Wt.INSPECT),this.phase.selection.setOnlyEntity(e)}enable(){this.displayPins=new r.f(1e4,{vertices:!1,position:!0,rotation:!1,uvs:!1,tint:!0}),this.displayPins.zIndex=Mt.PINS,this.phase.board.addChild(this.displayPins);let t=new r.e;t.beginFill(16777215),t.lineStyle(0),t.drawCircle(12,12,12),this.circleTex=ce.renderer.generateTexture(t,r.i.LINEAR,1),this.circleTex.defaultAnchor.set(.5,.5)}destroy(){this.displayPins.destroy(bt),this.circleTex.destroy(!0)}}class Gt extends St{constructor(t,e){super(t),this.tool=Wt.INSPECT,this.isMovingSelection=!1,this.movingStart=new r.g(0,0),this.lastMove=new r.g(0,0),this.isHost=e,this.pointDb=new kt(this.gridSystem),this.selection=new Ft(this.ecs)}setupEcs(){this.setupNetworkManager(),super.setupEcs(),this.backgroundSystem=new Tt(this.ecs,this),this.roomSystem=new Dt(this.ecs,this),this.pinSystem=new qt(this.ecs,this),this.ecs.events.on("selection_update",t=>{this.vue.selectedEntityOpts=t.getCommonEntityOpts(),this.vue.selectedComponents=t.getCommonComponents()})}setupBoard(){ce.stage.sortableChildren=!0,ce.stage.addChild(this.board)}setupNetworkManager(){this.networkManager=new Vt(this.isHost),this.networkManager.on("ready",this.onNetworkReady,this),this.networkManager.on("error",this.onNetworkError,this);let t=()=>{this.vue.connectionCount=this.networkManager.channel.connections.length},e=this.networkManager.channel.eventEmitter;e.on("_device_join",t),e.on("_device_left",t),e.on("_buffering_update",()=>{this.vue.connectionBuffering=this.networkManager.channel.bufferingChannels>0})}changeTool(t){let e=this.tool;e===Wt.CREATE_ROOM?this.roomSystem.endRoomCreation(!1):e===Wt.CREATE_PIN&&this.pinSystem.cancelCreation(),t!==Wt.MOVE&&t!==Wt.INSPECT&&this.selection.clear(),t===Wt.CREATE_ROOM?this.roomSystem.initRoomCreation():t===Wt.CREATE_PIN&&this.pinSystem.initCreation(),this.tool=t,console.log("Changing tool from "+e+" to "+t),this.uiEventEmitter.emit("changeTool",this.tool)}getMapPointFromMouseInteraction(t,e){let i=t.data.getLocalPosition(this.board,e),n=this.pointDb.findNearest([i.x,i.y]);return void 0!==n&&n[1]<100&&i.set(n[0][0],n[0][1]),i}onPointerDown(t){if(super.onPointerDown(t),this.tool===Wt.MOVE&&(1!==t.data.button||"mouse"!==t.data.pointerType)){this.isDraggingBoard=!1,this.isMovingSelection=!0;let e=this.getMapPointFromMouseInteraction(t);this.movingStart.copyFrom(e),this.lastMove.set(0,0),this.ecs.events.emit("tool_move_begin")}}onPointerMove(t){if(super.onPointerMove(t),this.tool===Wt.CREATE_ROOM){let e=this.getMapPointFromMouseInteraction(t);this.roomSystem.redrawLastLine(this.roomSystem.currentRoom,e)}else if(this.isMovingSelection){let e=this.getMapPointFromMouseInteraction(t),i=e.x-this.movingStart.x,n=e.y-this.movingStart.y,o=i-this.lastMove.x,s=n-this.lastMove.y;this.lastMove.set(i,n),this.selection.moveAll(o,s)}else if(this.tool===Wt.CREATE_PIN){let e=this.getMapPointFromMouseInteraction(t);this.pinSystem.redrawCreation(e)}}onPointerUp(t){super.onPointerUp(t),this.isMovingSelection&&(this.isMovingSelection=!1,this.ecs.events.emit("tool_move_end"))}onPointerUpOutside(t){super.onPointerUpOutside(t)}findEntityAt(t){let e=this.pinSystem.findPinAt(t);return void 0!==e?e:(e=this.roomSystem.findRoomAt(t),void 0!==e?e:void 0)}onPointerClick(t){super.onPointerClick(t);let e=this.getMapPointFromMouseInteraction(t);if(this.tool===Wt.CREATE_ROOM)return void this.roomSystem.addVertex(e);if(this.tool===Wt.CREATE_PIN)return void this.pinSystem.confirmCreation(e);let i=this.findEntityAt(e);void 0===i&&(i=t.target._ecs_entity);let n=!!t.data.originalEvent.ctrlKey;this.tool===Wt.INSPECT&&(n?void 0!==i&&this.selection.toggleEntity(i):void 0!==i?this.selection.setOnlyEntity(i):this.selection.clear())}onNetworkReady(){console.log("Network is ready! "+this.networkManager.isHost),this.networkManager.isHost&&history.replaceState(null,null,"#p"+this.networkManager.peer.id)}onNetworkError(t){console.error("Error from peerjs: ",t.type),"server-error"===t.type?(alert("Error connecting to peerjs instance, you're offline now"),this.isHost||pe.setPhase(new oe(new S))):"peer-unavailable"===t.type?(console.log("Invalid invite link"),alert("Invalid invite link"),history.replaceState(null,null," "),this.isHost||pe.setPhase(new oe(new S))):"network"===t.ty?alert("Connection lost"):alert(t)}onPointerRightDown(t){if(super.onPointerRightDown(t),this.tool===Wt.CREATE_ROOM){let e=this.getMapPointFromMouseInteraction(t);this.roomSystem.undoVertex(e)}}ui(){let t=new ct;return t.phase=this,t.isAdmin=this.isHost,t}enable(){super.enable(),this.setupBoard(),this.backgroundSystem.enable(),this.roomSystem.enable(),this.pinSystem.enable()}disable(){this.pinSystem.destroy(),this.roomSystem.destroy(),this.backgroundSystem.destroy(),super.disable()}}var Wt;!function(t){t.INSPECT="inspect",t.MOVE="move",t.CREATE_ROOM="create_room",t.CREATE_PIN="create_pin",t.GRID="grid"}(Wt||(Wt={}));class Kt{constructor(t,e){this.connectedClients=0,this.isEnabled=!1,this.ecs=t,this.channel=e,this.channel.eventEmitter.on("_device_join",this.onDeviceJoin,this),this.channel.eventEmitter.on("_device_left",this.onDeviceLeft,this),this.ecs.events.on("entity_spawn",this.onEntitySpawn,this),this.ecs.events.on("entity_spawned",this.onEntitySpawned,this),this.ecs.events.on("entity_despawn",this.onEntityDespawn,this),this.ecs.events.on("entity_despawned",this.onEntityDespawned,this),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edit",this.onComponentEdit,this),this.ecs.events.on("component_removed",this.onComponentRemoved,this),this.ecs.events.on("resource_add",this.onResourceAdd,this),this.ecs.events.on("resource_edit",this.onResourceEdit,this),this.ecs.events.on("resource_remove",this.onResourceRemove,this)}onDeviceJoin(t){this.connectedClients++,this.isEnabled=!0,this.channel.send({type:"ecs_bootstrap",payload:this.ecs.serializeClient()},t)}onDeviceLeft(t){this.connectedClients--,this.isEnabled=0!==this.connectedClients}onEntitySpawn(t){this.entitySpawning=t}onEntitySpawned(t){if(t!==this.entitySpawning&&!this.ecs.isDeserializing)throw this.entitySpawning=void 0,"Invalid entity spawn";this.entitySpawning=void 0,this.isEnabled&&!this.shouldIgnoreEntity(t)&&this.channel.broadcast(this.createEntitySpawnPacket(t))}onEntityDespawn(t){this.isEnabled&&!this.shouldIgnoreEntity(t)&&(this.entityDespawning=t,this.channel.broadcast({type:"entity_despawn",entityId:t}))}onEntityDespawned(t){this.entityDespawning=void 0}onComponentAdd(t){this.entitySpawning!==t.entity&&this.isEnabled&&("host_hidden"!==t.type?this.shouldIgnoreComponent(t)||this.channel.broadcast({type:"component_add",entityId:t.entity,payload:Qt(t)}):this.channel.broadcast({type:"entity_despawn",entityId:t.entity}))}onComponentEdit(t,e){if(this.isEnabled&&!this.shouldIgnoreEntity(t.entity))if(!0!==e.clientVisible||!1!==t.clientVisible)!1!==e.clientVisible||!1===t.clientVisible?!1!==t.clientVisible&&this.channel.broadcast({type:"component_edit",entityId:t.entity,compType:t.type,multiId:t.multiId,changes:Object.assign({},e)}):this.channel.broadcast({type:"component_remove",entityId:t.entity,compType:t.type,multiId:t.multiId});else{let i=Object.assign({},t,e);this.channel.broadcast({type:"component_add",entityId:t.entity,payload:Qt(i)})}}onComponentRemoved(t){if(this.entityDespawning!==t.entity&&this.isEnabled)if("host_hidden"!==t.type)this.shouldIgnoreComponent(t)||this.channel.broadcast({type:"component_remove",entityId:t.entity,compType:t.type,multiId:t.multiId});else{if(this.entityDespawning===t.entity)return;this.channel.broadcast(this.createEntitySpawnPacket(t.entity))}}onResourceAdd(t){this.isEnabled&&!0!==t._clientHide&&this.channel.broadcast({type:"resource_add",payload:Zt(t)})}onResourceEdit(t,e){this.isEnabled&&!0!==t._clientHide&&this.channel.broadcast({type:"resource_edit",resType:t.type,changes:Object.assign({},e)})}onResourceRemove(t){this.isEnabled&&!0!==t._clientHide&&this.channel.broadcast({type:"resource_remove",resType:t.type})}shouldIgnoreComponent(t){return this.shouldIgnoreEntity(t.entity)||!1===t.clientVisible||t.type.startsWith("host_")}shouldIgnoreEntity(t){return this.ecs.hasAllComponents(t,"host_hidden")}createEntitySpawnPacket(t){let e=this.ecs.getAllComponents(t),i=[];for(let t of e)t.type.startsWith("host_")||!1!==t.clientVisible&&i.push(Qt(t));return{type:"entity_spawn",entityId:t,components:i}}destroy(){}}class Jt{constructor(t,e){this.ecs=t,this.channel=e,e.eventEmitter.on("ecs_bootstrap",this.onEcsBootstrap,this),e.eventEmitter.on("entity_spawn",this.onEntitySpawn,this),e.eventEmitter.on("entity_despawn",this.onEntityDespawn,this),e.eventEmitter.on("component_add",this.onComponentAdd,this),e.eventEmitter.on("component_edit",this.onComponentEdit,this),e.eventEmitter.on("component_remove",this.onComponentRemove,this),e.eventEmitter.on("resource_add",this.onResourceAdd,this),e.eventEmitter.on("resource_edit",this.onResourceEdit,this),e.eventEmitter.on("resource_remove",this.onResourceRemove,this)}onEcsBootstrap(t,e){0===e.sender&&this.ecs.deserialize(t.payload)}onEntitySpawn(t,e){0===e.sender&&this.ecs.spawnEntityManual(t.entityId,t.components)}onEntityDespawn(t,e){0===e.sender&&this.ecs.despawnEntity(t.entityId)}onComponentAdd(t,e){0===e.sender&&this.ecs.addComponent(t.entityId,t.payload)}onComponentEdit(t,e){0===e.sender&&this.ecs.editComponent(t.entityId,t.compType,t.changes,t.multiId)}onComponentRemove(t,e){if(0!==e.sender)return;let i=this.ecs.getComponent(t.entityId,t.compType,t.multiId);void 0!==i&&this.ecs.removeComponent(i)}onResourceAdd(t,e){0===e.sender&&this.ecs.addResource(t.payload)}onResourceEdit(t,e){0===e.sender&&this.ecs.editResource(t.resType,t.changes)}onResourceRemove(t,e){0===e.sender&&this.ecs.removeResource(t.resType)}destroy(){}}function Qt(t){let e={};for(let i in t)"_"!==i[0]&&"entity"!==i&&"clientVisible"!==i&&(e[i]=t[i]);return e}function Zt(t){let e={};for(let i in t)"_"!==i[0]&&(e[i]=t[i]);return e}var te=function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function r(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class ee{constructor(t,e){this.ecs=t,this.channel=e,this.channel.eventEmitter.on("_device_join",this.onDeviceJoin,this),this.roomKnownStorage=new gt("host_room_known"),this.ecs.addStorage(this.roomKnownStorage),this.ecs.events.on("entity_spawned",this.onEntitySpawned,this),this.ecs.events.on("component_add",this.onComponentAdd,this),this.ecs.events.on("component_edit",this.onComponentEdit,this),this.ecs.events.on("component_remove",this.onComponentRemove,this)}onDeviceJoin(t){return te(this,void 0,void 0,(function*(){let e=this.ecs.storages.get("position"),i=1/0,n=1/0,o=[];for(let t of this.roomKnownStorage.allComponents()){o.push(t.entity);let s=e.getComponent(t.entity);i=Math.min(i,s.x),n=Math.min(n,s.y)}if(0===o.length)return;let s=yield this.cutRoomImage(o);if(null===s)return;let r=yield s.arrayBuffer();this.channel.send({type:"room_map_draw",map:r,mapType:"image/png",mapX:i,mapY:n},t)}))}onEntitySpawned(t){let e=this.ecs.getComponent(t,"room");void 0!==e&&e.visible&&(this.ecs.hasAllComponents(t,"host_hidden")||this.ecs.hasAllComponents(t,"host_room_known")||this.ecs.addComponent(t,{type:"host_room_known"}))}onComponentAdd(t){return te(this,void 0,void 0,(function*(){if("host_hidden"===t.type){let e=this.roomKnownStorage.getComponent(t.entity);void 0!==e&&this.ecs.removeComponent(e)}else if("host_room_known"===t.type){if(0===this.channel.connections.length)return;let e=yield this.cutRoomImage([t.entity]);if(null===e)return;let i=yield e.arrayBuffer(),n=this.ecs.getComponent(t.entity,"position");this.channel.broadcast({type:"room_map_draw",map:i,mapType:"image/png",mapX:n.x,mapY:n.y})}}))}onComponentEdit(t,e){return te(this,void 0,void 0,(function*(){if("room"===t.type)!0!==e.visible||this.ecs.hasAllComponents(t.entity,"host_hidden")||void 0!==this.roomKnownStorage.getComponent(t.entity)||this.ecs.addComponent(t.entity,{type:"host_room_known"});else if("position"==t.type){let e=this.roomKnownStorage.getComponent(t.entity);if(void 0!==e){let i=this.ecs.getComponent(t.entity,"room");i.visible&&this.ecs.editComponent(i.entity,"room",{visible:!1}),this.channel.broadcast({type:"room_map_force_forget",rooms:[t.entity]}),this.ecs.removeComponent(e)}}}))}onComponentRemove(t){return te(this,void 0,void 0,(function*(){if("host_hidden"===t.type){let e=this.ecs.getComponent(t.entity,"room");void 0!==e&&e.visible&&this.ecs.addComponent(t.entity,{type:"host_room_known"})}}))}cutRoomImage(t){let e=this.ecs.storages.get("room"),i=this.ecs.storages.get("background_image"),n=this.ecs.storages.get("position"),o=1/0,s=1/0,a=-1/0,l=-1/0,d=new r.e;for(let i of t){let t=e.getComponent(i),r=n.getComponent(i);o=Math.min(o,r.x),s=Math.min(s,r.y);let h=t.polygon.length;for(let e=0;e<h;e+=2)a=Math.max(a,t._worldPolygon[e]),l=Math.max(l,t._worldPolygon[e+1]);d.beginFill(),d.drawPolygon(t._worldPolygon),d.endFill()}let h=new r.d;for(let t of i.allComponents()){let e=new r.j(t._display.texture);e.position.copyFrom(t._display.position),e.rotation=t._display.rotation,h.addChild(e)}h.position.set(-o,-s);let c=new r.e;c.beginFill(),c.drawRect(0,0,a-o+1,l-s+1),c.position.set(o,s);let p=new r.d;d.blendMode=r.b.ERASE,p.addChild(c,d),p.position.set(-o,-s);let m=r.h.create({width:a-o,height:l-s});ce.renderer.render(p,m);let u=new r.j(m);u.blendMode=r.b.ERASE,u.position.set(o,s),h.addChild(u);let f=r.h.create({width:a-o,height:l-s});ce.renderer.render(h,f);let y=ce.renderer.extract.canvas(f);return f.destroy(!0),p.destroy(bt),u.destroy(bt),h.destroy({children:!0,texture:!1,baseTexture:!1}),new Promise(t=>{y.toBlob(t)})}destroy(){this.channel.eventEmitter.off("_device_join",this.onDeviceJoin,this)}}class ie{constructor(t,e){this.phase=t,this.ecs=t.ecs,this.channel=e,this.displayMap=new r.j(r.k.EMPTY),this.displayMapTex=void 0,this.ecs.events.on("component_remove",this.onComponentRemove,this),e.eventEmitter.on("room_map_draw",this.onRoomMapDraw,this),e.eventEmitter.on("room_map_force_forget",this.onRoomMapForceForget,this)}onComponentRemove(t){"room"===t.type&&this.forget([t.entity])}onRoomMapDraw(t,e){return te(this,void 0,void 0,(function*(){if(0!==e.sender)return;let[i]=yield _t(t.map,t.mapType);this.addPartialImage(t.mapX,t.mapY,i)}))}onRoomMapForceForget(t,e){return te(this,void 0,void 0,(function*(){0===e.sender&&this.forget(t.rooms)}))}forget(t){if(void 0===this.displayMapTex)return;let e=this.ecs.storages.get("room"),i=new r.e;i.lineStyle(3);for(let n of t){let t=e.getComponent(n);i.beginFill(),i.drawPolygon(t._worldPolygon),i.endFill()}i.blendMode=r.b.ERASE;let n=this.displayMap.position,o=new r.d;o.filters=[new r.m.AlphaFilter],o.position.set(-n.x,-n.y);let s=new r.j(this.displayMapTex);s.position.copyFrom(n),o.addChild(s),o.addChild(i);let a=r.h.create({width:this.displayMapTex.width,height:this.displayMapTex.height,scaleMode:r.i.LINEAR});ce.renderer.render(o,a),this.displayMap.texture=a,void 0!==this.displayMapTex&&this.displayMapTex.destroy(!0),this.displayMapTex=a}addPartialImage(t,e,i){let n=new r.j(i),o=new r.j(this.displayMapTex);o.x=this.displayMap.x,o.y=this.displayMap.y,n.position.set(t,e);let s,a,l=this.displayMap.x,d=this.displayMap.y;this.displayMapTex;void 0!==this.displayMapTex?(s=Math.min(t,l),a=Math.min(e,d)):(s=t,a=e);let h=Math.max(t+i.width,l+this.displayMap.width),c=Math.max(e+i.height,d+this.displayMap.height),p=r.h.create({width:Math.ceil(h-s),height:Math.ceil(c-a),scaleMode:r.i.LINEAR}),m=new r.d;m.addChild(n),m.addChild(o),m.position.set(-s,-a),ce.renderer.render(m,p),this.displayMap.texture=p,this.displayMap.x=s,this.displayMap.y=a,void 0!==this.displayMapTex&&this.displayMapTex.destroy(!0),this.displayMapTex=p,m.destroy({children:!1,texture:!0,baseTexture:!0}),o.destroy({children:!1,texture:!1,baseTexture:!1}),n.destroy(bt)}enable(){this.phase.board.addChild(this.displayMap)}destroy(){this.displayMap.destroy(bt),this.channel.eventEmitter.off("room_map_draw",this.onRoomMapDraw,this)}}var ne=function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function r(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class oe extends Gt{constructor(t){super("editHost",!0),this.map=t,0==this.map.levels.size&&this.map.levels.set(42,new w(42)),this.currentLevel=this.map.levels.values().next().value,this.setupEcs()}setupEcs(){super.setupEcs(),this.ecs.addStorage(new gt("host_hidden")),this.roomBackgroundSystem=new ee(this.ecs,this.networkManager.channel),this.networkSystem=new Kt(this.ecs,this.networkManager.channel)}onDrop(t){return ne(this,void 0,void 0,(function*(){if(t.stopPropagation(),t.preventDefault(),t.dataTransfer.items){let e=[];for(let i of t.dataTransfer.items){let t=i.getAsFile();null!=t&&e.push(t)}yield this.onFileDrop(e)}else yield this.onFileDrop(t.dataTransfer.files)}))}onDragOver(t){return t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy",!1}onFileDrop(t){return ne(this,void 0,void 0,(function*(){if(0==t.length)return;let e=t[0];e.type.startsWith("image/")&&(this.ecs.spawnEntity({type:"host_hidden"},{type:"name",name:e.name,clientVisible:!1},{type:"position",x:0,y:0},{type:"transform",rotation:0},{type:"background_image",imageType:e.type,image:new Uint8Array(yield e.arrayBuffer())}),console.log("Image loaded"))}))}exportMap(){return ne(this,void 0,void 0,(function*(){this.currentLevel.saveFrom(this.ecs);let t=yield this.map.saveToFile();this.saveBlob(t,"map.dndm")}))}saveBlob(t,e){let i=document.getElementById("hidden-download-link"),n=window.URL.createObjectURL(t);i.href=n,i.download=e,i.click(),window.URL.revokeObjectURL(n)}enable(){super.enable(),ce.view.ondrop=this.onDrop.bind(this),ce.view.ondragover=this.onDragOver.bind(this),this.currentLevel.loadInto(this.ecs);this.networkManager.channel.eventEmitter}disable(){this.networkManager.channel.eventEmitter;ce.view.ondrop=void 0,ce.view.ondragover=void 0,super.disable()}}var se=function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function r(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};class re extends s{constructor(){super("home")}ui(){return new b}createMap(){let t=new S;pe.setPhase(new oe(t))}editMap(t){return se(this,void 0,void 0,(function*(){let e=yield S.loadFromFile(t);pe.setPhase(new oe(e))}))}enable(){super.enable(),this.uiEventEmitter.on("create_map",this.createMap,this),this.uiEventEmitter.on("edit",this.editMap,this)}disable(){this.uiEventEmitter.on("edit",this.editMap,this),this.uiEventEmitter.on("create_map",this.createMap,this),super.disable()}}var ae=i(29);i(54),i(71),i(72);class le extends Gt{constructor(t){super("editClient",!1),this.setupEcs(),this.networkManager.connectTo(t)}setupEcs(){super.setupEcs(),this.ecs.addStorage(new gt("host_hidden")),this.roomBackgroundSystem=new ie(this,this.networkManager.channel),this.networkSystem=new Jt(this.ecs,this.networkManager.channel)}enable(){super.enable(),this.roomBackgroundSystem.enable()}disable(){super.disable(),this.networkSystem.destroy(),this.roomBackgroundSystem.destroy()}}var de=function(t,e,i,n){return new(i||(i=Promise))((function(o,s){function r(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};n.default.use(ae.a);const he=new class extends o{constructor(t){super(),this.caught=new Set,this.catcher=t}catchEvent(t){this.catcher(t,this),this.caught.add(t)}on(t,e,i){return super.on(t,e,i),this.caught.has(t)||this.catchEvent(t),this}addListener(t,e,i){return super.addListener(t,e,i),this.caught.has(t)||this.catchEvent(t),this}}((t,e)=>{window.addEventListener(t,i=>{e.emit(t,i)})});let ce;const pe=new class extends s{constructor(t){super(t)}setPhase(t){this.phase&&this.phase.disable(),this.phase=t,this.phase&&this.phase.enable()}disable(){super.disable(),this.setPhase(null)}}("main");function me(){if(window.location.hash){const t=window.location.hash.substr(1);t.startsWith("p")?(console.log("Connecting with: peerj2"),pe.setPhase(new le(t.substr(1)))):(console.log("Invalid hash"),pe.setPhase(new re))}else pe.setPhase(new re)}!function(){de(this,void 0,void 0,(function*(){ce=new r.a({transparent:!0}),ce.view.addEventListener("contextmenu",t=>{t.preventDefault()}),me(),window.onhashchange=function(t){console.log("Hash change"+t.newURL),me()}}))}()}]);